---
work: post-v2.0-bugfixes
status: in_progress
last_updated: 2026-02-15T16:27:24.619Z
---

<current_state>
Post-v2.0 release bugfixes. Working on two issues:
1. Light theme not displaying properly (popover background still dark, text hard to read)
2. Popover height being cut off for trial users (despite increasing height values significantly)
</current_state>

<completed_work>

- Added 4 themes to Theme.swift: Native macOS, Light, Dark, Anthropic
- Fixed Light theme text colors with hardcoded dark values (`#3c3c43` with opacity)
- Added `usageColor(for:)` to ThemeColors for theme-aware percentage colors
- Added `tertiaryText` color to ThemeColors
- Added `onAppear` in PopoverContentView to set NSWindow appearance for Light theme
- Widened Settings window from 420 to 560px
- Shortened tab names ("Data Sources" → "Sources", "Admin API" → "Admin")
- Made popover height dynamic based on trial banner + chart visibility
- Tried multiple height values: 310→320→330→340→360→390→420 base, still cut off
</completed_work>

<remaining_work>

- **Popover height cut off**: Despite setting baseHeight to 420 and trialBannerHeight to 100 (total 520px for trial), content still gets cut off at top and bottom. Need to investigate root cause - maybe MenuBarExtra has a max height or the frame isn't being applied correctly.

- **Light theme popover background**: Added NSWindow appearance setting in onAppear, but popover background may still not be light. The floating window IS light, so theme colors work - issue is specific to MenuBarExtra window.
</remaining_work>

<decisions_made>

- Used hardcoded colors for Light theme instead of NSColor because NSColor reads from system appearance, ignoring SwiftUI's `preferredColorScheme(.light)` modifier
- Added `usageColor(for:)` helper to ThemeColors that returns theme-aware colors for usage percentages (handles <40% case where GradientColors returns NSColor.secondaryLabelColor)
- Dark theme uses hardcoded colors: background `#1a1a1a`, accent `#4a9eff`
- Light theme uses hardcoded colors: background `#ececec`, accent `#007aff`, text `#3c3c43`
</decisions_made>

<blockers>

- **Popover height mystery**: Frame height is set to 520px for trial users but content still appears cut off. Tried `fixedSize()` but that broke the app. Need to investigate if MenuBarExtra has constraints or if the issue is elsewhere.
</blockers>

<context>
The user wants 4 themes that work regardless of system appearance:
- Native macOS: follows system
- Light: always light (even on dark system)
- Dark: always dark
- Anthropic: warm tones, follows system for light/dark base

The challenge is that NSColor (used for gradients, labels) reads from system appearance, not SwiftUI's preferredColorScheme. Solution is hardcoded colors for Light/Dark themes.

Popover height issue is frustrating - values keep increasing but content still gets cut off. May need to debug the actual rendered size vs requested size.
</context>

<next_action>
Debug popover height issue:
1. Add logging to see actual frame size being requested vs rendered
2. Check if MenuBarExtra has a maximum height limit
3. Try setting frame on a different view in the hierarchy
4. Consider if padding/spacing is eating into the height unexpectedly
</next_action>
