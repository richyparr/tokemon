---
phase: 18-extension-foundation
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - tokemon-raycast/src/setup.tsx
  - tokemon-raycast/src/index.tsx
  - tokemon-raycast/src/constants.ts
  - tokemon-raycast/src/api.ts
autonomous: false

must_haves:
  truths:
    - "User can open the Setup command and see instructions for entering their OAuth token"
    - "User can open Raycast preferences from the Setup command to enter their token"
    - "User can open the Dashboard command and see a placeholder indicating Phase 19 work"
    - "If token is invalid or expired, user sees a failure toast with action to open preferences"
  artifacts:
    - path: "tokemon-raycast/src/setup.tsx"
      provides: "Setup wizard with markdown guide and Open Preferences action"
      exports: ["default"]
    - path: "tokemon-raycast/src/index.tsx"
      provides: "Stub dashboard that reads token and validates on first load"
      exports: ["default"]
    - path: "tokemon-raycast/src/constants.ts"
      provides: "API endpoints, headers, and client ID ported from Swift Constants.swift"
      exports: ["USAGE_URL", "ANTHROPIC_BETA_HEADER"]
    - path: "tokemon-raycast/src/api.ts"
      provides: "fetchUsage function that calls OAuth usage endpoint with token validation"
      exports: ["fetchUsage"]
  key_links:
    - from: "tokemon-raycast/src/setup.tsx"
      to: "Raycast preferences panel"
      via: "openExtensionPreferences() action"
      pattern: "openExtensionPreferences"
    - from: "tokemon-raycast/src/index.tsx"
      to: "tokemon-raycast/src/api.ts"
      via: "fetchUsage import for token validation"
      pattern: 'import.*fetchUsage.*from.*api'
    - from: "tokemon-raycast/src/api.ts"
      to: "tokemon-raycast/src/constants.ts"
      via: "USAGE_URL import for endpoint"
      pattern: 'import.*USAGE_URL.*from.*constants'
    - from: "tokemon-raycast/src/index.tsx"
      to: "Raycast preferences"
      via: "getPreferenceValues for token access"
      pattern: "getPreferenceValues"
---

<objective>
Implement the setup wizard command, API constants, token validation, and stub dashboard.

Purpose: Deliver the user-facing setup experience (EXT-04) and the foundation code that all Phase 19+ commands build on. Users can enter their OAuth token via the setup wizard, and the dashboard stub validates the token on first load.

Output: Four source files — `setup.tsx` (setup wizard), `index.tsx` (stub dashboard with token validation), `constants.ts` (API constants), `api.ts` (usage fetch with error handling).
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-extension-foundation/18-RESEARCH.md
@.planning/phases/18-extension-foundation/18-01-SUMMARY.md
@Tokemon/Utilities/Constants.swift
@Tokemon/Services/OAuthClient.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API constants and fetch utility</name>
  <files>
    tokemon-raycast/src/constants.ts
    tokemon-raycast/src/api.ts
  </files>
  <action>
    **Create `src/constants.ts`** — Port the API constants from the Swift app's `Constants.swift`. Include:
    ```typescript
    /** OAuth usage endpoint — same as macOS app's Constants.oauthUsageURL */
    export const USAGE_URL = "https://api.anthropic.com/api/oauth/usage";

    /** OAuth token refresh endpoint — deferred to future phase, declared for reference */
    export const TOKEN_REFRESH_URL = "https://console.anthropic.com/v1/oauth/token";

    /** Claude Code CLI OAuth client ID */
    export const OAUTH_CLIENT_ID = "9d1c250a-e61b-44d9-88ed-5944d1962f5e";

    /** Required beta header for OAuth usage endpoint */
    export const ANTHROPIC_BETA_HEADER = "oauth-2025-04-20";
    ```
    These values come directly from the existing Swift `Constants.swift` at `Tokemon/Utilities/Constants.swift`.

    **Create `src/api.ts`** — Implement the `fetchUsage` function:
    - Accept a `token: string` parameter
    - Trim the token and validate it's non-empty (pitfall from research: `required: true` doesn't prevent whitespace-only)
    - Call `USAGE_URL` with:
      - `Authorization: Bearer {token}`
      - `Accept: application/json`
      - `anthropic-beta: {ANTHROPIC_BETA_HEADER}`
      - `User-Agent: tokemon-raycast/1.0`
    - On 401: throw a typed error indicating token is expired/invalid
    - On 403: throw a typed error indicating insufficient scope
    - On other non-ok: throw with HTTP status
    - On success: return the JSON response (typed loosely as `unknown` for now — full typing is Phase 19 scope)
    - Use native `fetch` (available in Node 22.14+, which the research confirmed)
    - Export a `TokenError` type or class for callers to distinguish token errors from network errors

    Do NOT implement token refresh logic — Phase 18 scope is validate-only. Do NOT import `@raycast/api` in this file — keep it a pure utility.
  </action>
  <verify>
    1. `cd /Users/richardparr/tokemon-raycast && npx tsc --noEmit` succeeds (no type errors)
    2. `grep "USAGE_URL" src/constants.ts` shows the correct endpoint
    3. `grep "anthropic-beta" src/api.ts` shows the header is used in the fetch call
    4. `grep "401" src/api.ts` shows token error handling
  </verify>
  <done>
    constants.ts exports all API constants ported from Swift. api.ts exports fetchUsage with proper headers, token trimming, and typed error handling for 401/403. Both compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement setup wizard and stub dashboard</name>
  <files>
    tokemon-raycast/src/setup.tsx
    tokemon-raycast/src/index.tsx
  </files>
  <action>
    **Implement `src/setup.tsx`** — The setup wizard command (locked decision: Raycast preferences + dedicated setup command):
    - Render a `Detail` component with a markdown guide:
      - Title: "Welcome to tokemon"
      - One-line description: "Monitor your Claude usage directly from Raycast."
      - Steps to get the OAuth token:
        1. Open [claude.ai](https://claude.ai) in your browser
        2. Open Developer Console (browser dev tools)
        3. Look for requests to `api.anthropic.com` and copy the Bearer token from the Authorization header
        4. Or: If you use the Tokemon macOS app, find the token in your Keychain under "Claude Code-credentials"
      - Note: Keep the instructions concise. The Raycast developer audience is technical.
      - Footer: "*by [tokemon](https://tokemon.app) — also available as a macOS menu bar app*" (standalone with nod identity per locked decision)
    - ActionPanel with primary action: `Action` titled "Enter Token in Preferences" that calls `openExtensionPreferences()`
    - Import from `@raycast/api`: `Detail`, `ActionPanel`, `Action`, `openExtensionPreferences`
    - Check if token is already configured (via `getPreferenceValues`). If a valid token exists, show a different message: "Your token is configured. Use the Dashboard command to view your usage." with actions for both "Open Dashboard" (using Raycast deep link or just a note) and "Update Token" (openExtensionPreferences).

    **Implement `src/index.tsx`** — Stub dashboard with token validation:
    - Read the OAuth token from preferences using `getPreferenceValues<Preferences>()` where `Preferences` has `oauthToken: string`
    - Trim the token (pitfall: whitespace-only can pass `required: true`)
    - If token is empty after trim: show a `Detail` view with "Setup Required" message and an action to open preferences
    - If token exists: attempt a single `fetchUsage(token)` call using the `useEffect` + `useState` pattern (or `useCachedPromise` from `@raycast/utils` for cleaner loading states)
    - While loading: show `Detail` with `isLoading={true}`
    - On success: show a `Detail` with simple markdown: "# Dashboard\n\nToken validated successfully. Full dashboard coming in the next update." — This is a Phase 18 stub. Phase 19 replaces this with the real dashboard.
    - On token error (401/403): show `showToast` with `Toast.Style.Failure`, title "Invalid or expired token", message "Update your token in preferences", and `primaryAction` with title "Open Preferences" calling `openExtensionPreferences` (save-then-check pattern per research recommendation)
    - On network error: show `showToast` with `Toast.Style.Failure`, title "Connection failed", message with error details
    - Import `fetchUsage` from `./api` and relevant types from `@raycast/api`
  </action>
  <verify>
    1. `cd /Users/richardparr/tokemon-raycast && npx tsc --noEmit` succeeds (all four source files compile)
    2. `npm run build` succeeds
    3. `grep "openExtensionPreferences" src/setup.tsx` shows the action is wired
    4. `grep "fetchUsage" src/index.tsx` shows the API call is wired
    5. `grep "Toast.Style.Failure" src/index.tsx` shows error handling
    6. `npm run lint` passes (or only produces warnings, no errors)
  </verify>
  <done>
    setup.tsx renders a markdown guide with steps to get the OAuth token and an action to open preferences. index.tsx reads the token from preferences, validates it via fetchUsage on load, shows a success stub or failure toast. Both compile and lint without errors.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify extension loads in Raycast</name>
  <files>tokemon-raycast/src/index.tsx, tokemon-raycast/src/setup.tsx</files>
  <action>
    Human verification of the complete Raycast extension. What was built: Complete Raycast extension with setup wizard, stub dashboard, Tokemon icon, and token validation at /Users/richardparr/tokemon-raycast/.

    Steps to verify:
    1. Open terminal and run: `cd /Users/richardparr/tokemon-raycast && npm run dev`
    2. Open Raycast (Cmd+Space or your hotkey)
    3. Type "tokemon" — you should see both "Dashboard" and "Setup" commands with the Tokemon icon
    4. Open "Setup" — verify the markdown guide displays with token instructions and "Enter Token in Preferences" action
    5. Press Enter on "Enter Token in Preferences" — verify Raycast preferences panel opens with the password field
    6. Enter your OAuth token in the preferences field
    7. Go back to Raycast and open "Dashboard" — verify it attempts to validate the token
    8. If token is valid: you should see "Token validated successfully" message
    9. If token is invalid: you should see a failure toast with "Open Preferences" action

    Resume signal: Type "approved" if the extension loads correctly with icon, setup wizard works, and token validation functions. Describe any issues otherwise.
  </action>
  <verify>User confirms extension loads in Raycast with Tokemon icon, setup wizard renders correctly, preferences panel opens, and token validation works (success or failure toast).</verify>
  <done>Extension verified working in Raycast by the user — icon displays, setup wizard guides token entry, dashboard validates token on load.</done>
</task>

</tasks>

<verification>
1. `cd /Users/richardparr/tokemon-raycast && npm run build` succeeds
2. `npm run lint` passes (no errors; warnings acceptable)
3. `npx tsc --noEmit` succeeds (TypeScript clean)
4. Setup command renders markdown guide with "Enter Token in Preferences" action
5. Dashboard reads token, calls usage API, shows success or failure toast
6. Token error (401) produces toast with "Open Preferences" action
7. All four source files exist: constants.ts, api.ts, setup.tsx, index.tsx
</verification>

<success_criteria>
- Setup wizard displays markdown instructions and opens preferences panel on action
- Dashboard validates token via fetchUsage on load
- Invalid/expired token shows Toast.Style.Failure with "Open Preferences" action
- Valid token shows success confirmation stub
- All TypeScript compiles without errors
- ESLint passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/18-extension-foundation/18-02-SUMMARY.md`
</output>
