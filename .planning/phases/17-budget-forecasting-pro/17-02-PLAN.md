---
phase: 17-budget-forecasting-pro
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - Tokemon/Views/Budget/BudgetDashboardView.swift
  - Tokemon/Views/Budget/BudgetGaugeView.swift
  - Tokemon/Views/Budget/CostBreakdownView.swift
  - Tokemon/Views/Budget/ForecastView.swift
  - Tokemon/Views/Settings/SettingsView.swift
  - Tokemon/TokemonApp.swift
  - Tokemon/Services/SettingsWindowController.swift
autonomous: true

must_haves:
  truths:
    - "User can set a monthly dollar budget limit in a Budget settings tab"
    - "User sees current spend vs budget as a visual gauge"
    - "User receives macOS notifications at 50%, 75%, and 90% of budget"
    - "User can see cost attribution broken down by workspace/project"
    - "User sees predicted time-to-limit based on daily spend rate"
    - "User sees on pace / ahead / behind indicator"
    - "Prediction updates when BudgetManager refreshes cost data"
  artifacts:
    - path: "Tokemon/Views/Budget/BudgetDashboardView.swift"
      provides: "Main budget dashboard with Pro gate, budget config form, and sub-views"
      contains: "struct BudgetDashboardView"
    - path: "Tokemon/Views/Budget/BudgetGaugeView.swift"
      provides: "Circular or arc gauge showing spend vs budget percentage"
      contains: "struct BudgetGaugeView"
    - path: "Tokemon/Views/Budget/CostBreakdownView.swift"
      provides: "Workspace/project cost attribution table"
      contains: "struct CostBreakdownView"
    - path: "Tokemon/Views/Budget/ForecastView.swift"
      provides: "Forecast section with time-to-limit, pace indicator, projected monthly spend"
      contains: "struct ForecastView"
    - path: "Tokemon/Views/Settings/SettingsView.swift"
      provides: "Budget tab in settings TabView"
      contains: "BudgetDashboardView"
    - path: "Tokemon/TokemonApp.swift"
      provides: "BudgetManager instantiation, environment injection, refresh cycle wiring"
      contains: "budgetManager"
    - path: "Tokemon/Services/SettingsWindowController.swift"
      provides: "BudgetManager property and setter for settings window injection"
      contains: "setBudgetManager"
  key_links:
    - from: "Tokemon/Views/Budget/BudgetDashboardView.swift"
      to: "Tokemon/Services/BudgetManager.swift"
      via: "@Environment(BudgetManager.self) for data binding"
      pattern: "Environment\\(BudgetManager\\.self\\)"
    - from: "Tokemon/Views/Budget/ForecastView.swift"
      to: "Tokemon/Services/ForecastingEngine.swift"
      via: "static method calls for pace and time-to-limit"
      pattern: "ForecastingEngine\\."
    - from: "Tokemon/TokemonApp.swift"
      to: "Tokemon/Services/BudgetManager.swift"
      via: "onBudgetRefresh callback wiring to UsageMonitor refresh cycle"
      pattern: "budgetManager\\.fetchCurrentMonthCost"
    - from: "Tokemon/Views/Settings/SettingsView.swift"
      to: "Tokemon/Views/Budget/BudgetDashboardView.swift"
      via: "TabView tab item"
      pattern: "BudgetDashboardView"
---

<objective>
Budget & Forecasting UI and app integration: dashboard views with gauge, cost breakdown, forecasting display, Settings tab, and TokemonApp wiring.

Purpose: Deliver the complete user-facing budget and forecasting experience -- users set a budget, see a visual gauge of spend vs limit, receive threshold alerts, view project cost attribution, and see ML-driven usage predictions with pace indicators.

Output: BudgetDashboardView with sub-views (gauge, cost breakdown, forecast), Settings tab integration, TokemonApp wiring for automatic cost refresh.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/17-budget-forecasting-pro/17-01-SUMMARY.md
@Tokemon/Views/Settings/SettingsView.swift
@Tokemon/Views/Settings/WebhookSettings.swift
@Tokemon/Views/Team/TeamDashboardView.swift
@Tokemon/Views/Analytics/OrgUsageView.swift
@Tokemon/TokemonApp.swift
@Tokemon/Services/SettingsWindowController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: BudgetDashboardView, BudgetGaugeView, CostBreakdownView, and ForecastView</name>
  <files>
    Tokemon/Views/Budget/BudgetDashboardView.swift
    Tokemon/Views/Budget/BudgetGaugeView.swift
    Tokemon/Views/Budget/CostBreakdownView.swift
    Tokemon/Views/Budget/ForecastView.swift
  </files>
  <action>
    Create `Tokemon/Views/Budget/` directory and four SwiftUI view files.

    **BudgetDashboardView.swift** -- main container view (follows TeamDashboardView/WebhookSettings Pro gate pattern):
    - `@Environment(FeatureAccessManager.self) private var featureAccess`
    - `@Environment(BudgetManager.self) private var budgetManager`
    - Pro gate at top level: if `!featureAccess.canAccess(.budgetTracking)`, show upgrade prompt (lock icon, "Budget & Forecasting is a Pro feature" text, "Upgrade to Pro" button calling `featureAccess.openPurchasePage()`)
    - Also check `AdminAPIClient.shared.hasAdminKey()` -- if not configured, show "Admin API Required" message with explanation that budget tracking needs the Admin API for cost data (matching TeamDashboardView pattern)
    - When Pro and Admin API configured, show a `Form { ... }.formStyle(.grouped)` with sections:
      - Section 1 "Budget Settings": Toggle for `budgetManager.config.isEnabled` with label "Enable Budget Tracking". When enabled, show: TextField for monthly limit (bound to `budgetManager.config.monthlyLimitDollars`, formatted as currency with "$" prefix), text caption showing threshold levels "Alerts at 50%, 75%, 90%". On change of any config field, call `budgetManager.saveConfig()`.
      - Section 2 "Current Month" (only if config.isEnabled): `BudgetGaugeView()` showing spend vs budget gauge, and basic stats row with current spend formatted as "$X.XX", remaining formatted, and days left in month.
      - Section 3 "Forecast" (only if config.isEnabled and dailyCostData has data): `ForecastView()`
      - Section 4 "Cost by Project" (only if config.isEnabled and projectCosts not empty): `CostBreakdownView()`
    - Refresh button in header that calls `Task { await budgetManager.fetchCurrentMonthCost() }`
    - `.task { await budgetManager.fetchCurrentMonthCost() }` on appear
    - Loading state: show ProgressView when `budgetManager.isLoading`
    - Error state: show error message from `budgetManager.errorMessage`

    **BudgetGaugeView.swift** -- visual spend vs budget gauge:
    - `@Environment(BudgetManager.self) private var budgetManager`
    - Circular arc gauge using SwiftUI `Gauge` view (available macOS 14+) with `.gaugeStyle(.accessoryCircularCapacity)` -- OR if that's too limiting, build a custom arc:
      - Use a `ZStack` with a background arc (gray) and foreground arc (colored by utilization level) at 270-degree sweep
      - Center text shows percentage: "{utilization}%"
      - Below gauge: "$X spent of $Y" text
    - Color thresholds: green (<50%), orange (50-75%), red (>75%) -- using the same GradientColors pattern or inline color logic
    - Frame the gauge at a reasonable size (~120x120)

    **CostBreakdownView.swift** -- project/workspace cost attribution (BUDG-04):
    - `@Environment(BudgetManager.self) private var budgetManager`
    - Display `budgetManager.projectCosts` as a list of rows
    - Each row: workspace ID (or "Default" if empty), cost formatted as "$X.XX", proportion bar (matching ProjectBreakdownView pattern with GeometryReader)
    - Sort by cost descending
    - If projectCosts is empty, show "No project cost data" message
    - Header: "Cost by Project" with total cost

    **ForecastView.swift** -- usage prediction display (FORE-01, FORE-02, FORE-03):
    - `@Environment(BudgetManager.self) private var budgetManager`
    - Calculate forecast values using ForecastingEngine static methods:
      - `dailyRate` from `ForecastingEngine.calculateDailySpendRate(from: budgetManager.dailyCostData)`
      - `pace` from `ForecastingEngine.paceIndicator(currentSpend:monthlyBudget:dayOfMonth:daysInMonth:)`
      - `timeToLimit` from `ForecastingEngine.timeToLimit(currentSpend:monthlyBudget:dailyRate:)`
      - `projectedMonthly` from `ForecastingEngine.predictedMonthlySpend(...)`
    - Layout as a 3-column grid (matching OrgUsageView/TeamUsageSummaryView pattern):
      - Card 1 "Pace": Show PaceIndicator icon + text + color (e.g., green "On Pace" with checkmark, red "Ahead" with up arrow). This is FORE-02.
      - Card 2 "Time to Limit": Show formatted time remaining (e.g., "12d 5h") or "--" if not approaching limit. This is FORE-01.
      - Card 3 "Projected": Show projected monthly spend formatted as "$X.XX", with red color if over budget, green if under. This provides additional context.
    - Below grid: daily spend rate as caption text: "Avg. $X.XX/day"
    - All values recompute from budgetManager observed properties, so they update when BudgetManager refreshes (FORE-03 -- real-time updates)
  </action>
  <verify>Run `swift build` from project root -- must compile with no errors.</verify>
  <done>Four view files exist in Tokemon/Views/Budget/. BudgetDashboardView shows Pro gate, budget config, gauge, forecast, and cost breakdown. All compile cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: SettingsView tab, TokemonApp wiring, and SettingsWindowController injection</name>
  <files>
    Tokemon/Views/Settings/SettingsView.swift
    Tokemon/TokemonApp.swift
    Tokemon/Services/SettingsWindowController.swift
  </files>
  <action>
    **SettingsView.swift** -- add Budget tab:
    - Add `BudgetDashboardView()` as a new tab item AFTER the Webhooks tab and BEFORE the Analytics tab (position: Profiles, Updates, General, Sources, Appearance, Terminal, Alerts, Webhooks, **Budget**, Analytics, License, Admin, Team)
    - Tab label: `Label("Budget", systemImage: "dollarsign.gauge.chart.lefthalf.righthalf")`
    - The tab is always visible (like Webhooks) -- the Pro gate is handled internally by BudgetDashboardView
    - The Budget tab also needs Admin API to be meaningful, but the view itself handles showing the "Admin API Required" message (no conditional visibility like Team tab)

    **TokemonApp.swift** -- add BudgetManager to the app:
    - Add `@State private var budgetManager = BudgetManager()` property alongside existing service properties (after webhookManager)
    - Add `.environment(budgetManager)` to BOTH the MenuBarExtra content view chain AND the Settings scene chain (matching how webhookManager is injected)
    - In the `menuBarExtraAccess` closure (where all the wiring happens):
      - Call `SettingsWindowController.shared.setBudgetManager(budgetManager)` (after setWebhookManager)
      - Wire budget refresh to the usage monitor refresh cycle: After the existing `monitor.onAlertCheck` wiring, add a budget refresh callback. Use `monitor.onUsageChanged` or add a dedicated callback. The cleanest approach: add a new `@ObservationIgnored var onBudgetRefresh: ((_ usage: UsageSnapshot) -> Void)?` callback to UsageMonitor if needed, OR simpler: just call budgetManager.fetchCurrentMonthCost() inside the existing onAlertCheck closure. Actually, the simplest pattern matching the webhook wiring: add a new `alertManager.onBudgetCheck` callback property OR wire directly in the onAlertCheck closure. SIMPLEST: In the onAlertCheck callback wiring, after `alertManager.checkUsage(usage)`, also call `budgetManager.checkBudgetThresholds()`. For the actual cost data fetching, trigger `budgetManager.fetchCurrentMonthCost()` less frequently -- add a timer or check in BudgetManager itself. Best approach: wire into the existing `monitor.onUsageChanged` callback (which fires on every successful refresh). Add budgetManager cost refresh there, but BudgetManager should internally rate-limit (e.g., fetch cost data at most every 5 minutes) to avoid hammering the Admin API. Add a `@ObservationIgnored private var lastCostFetch: Date?` to BudgetManager and a `refreshIfNeeded()` async method that only calls fetchCurrentMonthCost() if more than 5 minutes have passed. Then in TokemonApp, wire: `monitor.onUsageChanged` already exists -- extend it to also call `Task { await budgetManager.refreshIfNeeded() }` and `budgetManager.checkBudgetThresholds()`.

      Here is the exact wiring approach:
      1. Extend the existing `monitor.onUsageChanged` closure to also trigger budget refresh:
         After the `statusItemManager.update(...)` call in the existing closure, add:
         ```
         Task { @MainActor in
             await budgetManager.refreshIfNeeded()
             budgetManager.checkBudgetThresholds()
         }
         ```
      2. This means BudgetManager needs `refreshIfNeeded()` -- an async method that checks `lastCostFetch` and only calls `fetchCurrentMonthCost()` if 5+ minutes have elapsed (or if never fetched). Add this to BudgetManager:
         - `@ObservationIgnored private var lastCostFetch: Date?`
         - `private let costRefreshInterval: TimeInterval = 300` (5 minutes)
         - `func refreshIfNeeded() async { guard lastCostFetch == nil || Date().timeIntervalSince(lastCostFetch!) >= costRefreshInterval else { return }; await fetchCurrentMonthCost(); lastCostFetch = Date() }`
         Note: This modification to BudgetManager is part of THIS task since it's wiring-related.

    **SettingsWindowController.swift** -- add BudgetManager injection:
    - Add `private var budgetManager: BudgetManager?` property (after webhookManager)
    - Add `func setBudgetManager(_ manager: BudgetManager) { self.budgetManager = manager }` method
    - Add `guard let budgetManager = budgetManager else { ... return }` check in `showSettings()` (after webhookManager guard)
    - Add `.environment(budgetManager)` to the settingsView chain in `showSettings()` (after .environment(webhookManager))
  </action>
  <verify>Run `swift build` from project root -- must compile with no errors.</verify>
  <done>Budget tab appears in Settings. BudgetManager is instantiated in TokemonApp, injected into environment, and wired to UsageMonitor refresh cycle. SettingsWindowController passes BudgetManager to settings window. Cost data refreshes automatically every 5 minutes during normal usage polling.</done>
</task>

</tasks>

<verification>
- `swift build` succeeds with no errors
- Budget tab visible in SettingsView TabView
- BudgetDashboardView shows Pro gate for non-Pro users
- BudgetDashboardView shows "Admin API Required" when no admin key
- BudgetGaugeView renders spend vs budget arc
- CostBreakdownView lists workspace costs
- ForecastView shows pace indicator, time-to-limit, projected spend
- BudgetManager instantiated in TokemonApp with environment injection
- SettingsWindowController has setBudgetManager method
- Cost refresh wired to monitor.onUsageChanged with 5-minute rate limiting
</verification>

<success_criteria>
All 7 files created/modified, `swift build` passes, complete budget & forecasting feature accessible via Settings > Budget tab with Pro gating, automatic cost refresh during normal polling cycle.
</success_criteria>

<output>
After completion, create `.planning/phases/17-budget-forecasting-pro/17-02-SUMMARY.md`
</output>
