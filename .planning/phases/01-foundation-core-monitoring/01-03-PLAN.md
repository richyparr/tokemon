---
phase: 01-foundation-core-monitoring
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - ClaudeMon/Views/MenuBar/PopoverContentView.swift
  - ClaudeMon/Views/MenuBar/UsageHeaderView.swift
  - ClaudeMon/Views/MenuBar/UsageDetailView.swift
  - ClaudeMon/Views/MenuBar/RefreshStatusView.swift
  - ClaudeMon/Views/MenuBar/ErrorBannerView.swift
  - ClaudeMon/Views/Settings/SettingsView.swift
  - ClaudeMon/Views/Settings/DataSourceSettings.swift
  - ClaudeMon/Views/Settings/RefreshSettings.swift
  - ClaudeMon/Views/Settings/AppearanceSettings.swift
  - ClaudeMon/Utilities/Extensions.swift
  - ClaudeMon/ClaudeMonApp.swift
autonomous: false

must_haves:
  truths:
    - "Popover shows big usage percentage at top, with limit remaining, reset time, and breakdown below"
    - "Popover has comfortable density with breathing room (not cramped or wasteful)"
    - "Subtle spinner shows during refresh with last-updated timestamp always visible"
    - "Error banner shows user-friendly message with 'Show details' expander for technical info"
    - "Settings allows enabling/disabling each data source independently"
    - "Settings allows configuring refresh interval"
    - "Settings gear icon in popover footer opens settings window"
    - "Right-click on menu bar icon shows context menu (Refresh now, Open floating window, Settings, Quit)"
    - "Menu bar icon shows error indicator when both sources fail"
    - "Usage breakdown shows multiple windows (5-hour, 7-day) when available from OAuth"
  artifacts:
    - path: "ClaudeMon/Views/MenuBar/UsageHeaderView.swift"
      provides: "Big percentage display (dominant, first thing user sees)"
      exports: ["UsageHeaderView"]
    - path: "ClaudeMon/Views/MenuBar/UsageDetailView.swift"
      provides: "Limit remaining, reset time, tokens/messages breakdown"
      exports: ["UsageDetailView"]
    - path: "ClaudeMon/Views/MenuBar/RefreshStatusView.swift"
      provides: "Spinner during refresh + last updated timestamp"
      exports: ["RefreshStatusView"]
    - path: "ClaudeMon/Views/MenuBar/ErrorBannerView.swift"
      provides: "Error state with Show details expander"
      exports: ["ErrorBannerView"]
    - path: "ClaudeMon/Views/Settings/SettingsView.swift"
      provides: "Main settings container with tabs/sections"
      exports: ["SettingsView"]
    - path: "ClaudeMon/Views/Settings/DataSourceSettings.swift"
      provides: "Enable/disable OAuth and JSONL sources"
      exports: ["DataSourceSettings"]
    - path: "ClaudeMon/Views/Settings/RefreshSettings.swift"
      provides: "Refresh interval configuration"
      exports: ["RefreshSettings"]
  key_links:
    - from: "PopoverContentView.swift"
      to: "UsageMonitor"
      via: "@Environment(UsageMonitor.self)"
      pattern: "@Environment.*UsageMonitor"
    - from: "SettingsView.swift"
      to: "UsageMonitor"
      via: "@Environment for reading/writing settings properties"
      pattern: "@Environment.*UsageMonitor"
    - from: "PopoverFooterView (in PopoverContentView)"
      to: "Settings window"
      via: "SettingsAccess openSettingsLegacy()"
      pattern: "openSettingsLegacy"
    - from: "ClaudeMonApp.swift"
      to: "NSMenu (right-click)"
      via: "NSEvent monitor or button sendAction for right-click"
      pattern: "rightMouseUp|NSMenu"
    - from: "DataSourceSettings.swift"
      to: "UsageMonitor.oauthEnabled / jsonlEnabled"
      via: "Toggle binding"
      pattern: "oauthEnabled|jsonlEnabled"
---

<objective>
Build the complete popover UI (usage header, detail breakdown, refresh status, error banner), the settings window (data source toggles, refresh interval, appearance), and the right-click context menu on the menu bar icon. This plan delivers the final user-facing experience for Phase 1.

Purpose: The app shell (Plan 01) and data layer (Plan 02) are complete. This plan delivers the UI that makes the data useful and the settings that make the app configurable.
Output: Polished popover with real data display, working settings window, and right-click context menu.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-core-monitoring/01-RESEARCH.md
@.planning/phases/01-foundation-core-monitoring/01-CONTEXT.md
@.planning/phases/01-foundation-core-monitoring/01-01-SUMMARY.md
@.planning/phases/01-foundation-core-monitoring/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build popover views (header, detail, refresh status, error banner)</name>
  <files>
    ClaudeMon/Views/MenuBar/PopoverContentView.swift
    ClaudeMon/Views/MenuBar/UsageHeaderView.swift
    ClaudeMon/Views/MenuBar/UsageDetailView.swift
    ClaudeMon/Views/MenuBar/RefreshStatusView.swift
    ClaudeMon/Views/MenuBar/ErrorBannerView.swift
    ClaudeMon/Utilities/Extensions.swift
  </files>
  <action>
**Extensions.swift:**
- `Date` extension: `func relativeTimeString() -> String` returning "just now", "2 min ago", "1 hour ago" etc.
- `Date` extension: `func formattedResetTime() -> String` returning "in 2h 15m" or "Tomorrow at 3:00 PM" for reset times
- `Int` extension: `var formattedTokenCount: String` returning "12,450" or "1.2M" for large numbers
- `Double` extension: `var percentageFormatted: String` returning "45.0%" with one decimal

**UsageHeaderView.swift:**
- Takes `usage: UsageSnapshot` as parameter
- Layout per user decision -- "big usage percentage number (dominant, first thing user sees)":
  - Large percentage text: SF Rounded font, ~48-56pt, bold weight
  - Color from `GradientColors.color(for: usage.primaryPercentage)` (converted to SwiftUI Color)
  - Below the number: "of 5-hour limit used" in `.secondary` foregroundStyle, ~13pt
  - If usage source is `.jsonl` (no percentage available): show token count as the big number (e.g., "12.4k tokens") with "from local session logs" subtitle
  - If usage is `.empty` / `.none`: show "--%" in `.tertiary` color

**UsageDetailView.swift:**
- Takes `usage: UsageSnapshot` as parameter
- Layout per user decision -- "limit remaining, reset time, messages/tokens breakdown":
- Section with rows, each row is HStack with label (left, `.secondary`) and value (right, `.primary`):
  - "Resets in" : `usage.resetsAt?.formattedResetTime() ?? "--"`
  - "5-hour usage" : `usage.fiveHourUtilization` formatted as percentage, or "--"
  - "7-day usage" : `usage.sevenDayUtilization` formatted as percentage, or "--"
  - "7-day Opus" : `usage.sevenDayOpusUtilization` formatted as percentage, or "--" (only show if non-nil and non-zero)
- If source is `.jsonl`, show token breakdown instead:
  - "Input tokens" : formatted count
  - "Output tokens" : formatted count
  - "Cache tokens" : formatted count (cache creation + cache read)
  - "Model" : model name or "--"
- Per user decision: "comfortable density" -- use VStack with spacing ~10-12, rows have padding. NOT cramped, NOT wasteful. Think "well-designed utility app."

**RefreshStatusView.swift:**
- Takes `isRefreshing: Bool` and `lastUpdated: Date?` as parameters
- Layout per user decision -- "subtle spinner during refresh + last updated timestamp always visible":
  - HStack:
    - Left: if `isRefreshing`, show a small `ProgressView()` (SwiftUI default spinner, which is subtle). Else, show nothing or a small checkmark icon
    - Center/left: "Updated {relativeTimeString}" text in `.caption` size, `.secondary` color. If `lastUpdated` is nil, show "Not yet updated"
  - The timestamp is ALWAYS visible (per user decision), spinner appears alongside it

**ErrorBannerView.swift:**
- Takes `error: MonitorError` and binding `requiresManualRetry: Bool`
- Layout per user decision -- "user-friendly primary message + Show details expander":
  - Rounded rect background in very subtle warning color (`.orange.opacity(0.1)`)
  - Primary text: user-friendly message based on error type:
    - `.oauthFailed`: "Using backup data source" (calm, not alarming)
    - `.jsonlFailed`: "Could not read local session logs"
    - `.bothSourcesFailed`: "Unable to fetch usage data" (more prominent)
    - `.tokenExpired`: "Authentication expired -- please re-open Claude Code"
    - `.insufficientScope`: "Claude Code needs to be re-authenticated with /login"
  - "Show details" `DisclosureGroup` or button that expands to show technical error description (the actual Error's localizedDescription)
  - If `requiresManualRetry` is true: show a "Retry" button that calls `monitor.manualRefresh()`

**Update PopoverContentView.swift:**
- Replace placeholder content with the real views:
  - VStack(spacing: 16) with padding 16
  - `UsageHeaderView(usage: monitor.currentUsage)`
  - `Divider()`
  - `UsageDetailView(usage: monitor.currentUsage)`
  - `Spacer(minLength: 0)`
  - If error exists: `ErrorBannerView(error: monitor.error!, requiresManualRetry: $monitor.requiresManualRetry)`
  - `Divider()`
  - Footer HStack:
    - Left: `RefreshStatusView(isRefreshing: monitor.isRefreshing, lastUpdated: monitor.lastUpdated)`
    - Spacer
    - Right: Gear icon button using SettingsAccess:
      ```swift
      Button { openSettingsLegacy() } label: { Image(systemName: "gear") }
      .buttonStyle(.plain)
      .openSettingsAccess()
      ```
  - Frame: width 320, ideal height ~380-420 (use `.frame(width: 320)` with flexible height, or `.frame(width: 320, idealHeight: 400)`)
  </action>
  <verify>
`xcodebuild build` succeeds. Run the app: click menu bar icon, verify popover shows real usage percentage prominently at top, detail rows below with reset time and breakdown, refresh status in footer, and gear icon. If an error state is active, verify the error banner appears with "Show details" toggle.
  </verify>
  <done>
Popover shows big usage percentage (or token count for JSONL), detail breakdown with limit remaining/reset time, refresh spinner + "last updated" timestamp, and error banner with "Show details" when errors occur. Layout has comfortable density. Gear icon opens settings via SettingsAccess.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build settings window and right-click context menu</name>
  <files>
    ClaudeMon/Views/Settings/SettingsView.swift
    ClaudeMon/Views/Settings/DataSourceSettings.swift
    ClaudeMon/Views/Settings/RefreshSettings.swift
    ClaudeMon/Views/Settings/AppearanceSettings.swift
    ClaudeMon/ClaudeMonApp.swift
  </files>
  <action>
**SettingsView.swift:**
- Replace placeholder with real settings window
- Use `TabView` with `.tabViewStyle(.automatic)` for macOS-native settings tabs
- Three tabs:
  1. "General" (gear icon) -- contains RefreshSettings
  2. "Data Sources" (arrow.triangle.2.circlepath icon) -- contains DataSourceSettings
  3. "Appearance" (paintbrush icon) -- contains AppearanceSettings
- Each tab: `Label("Name", systemImage: "icon")`
- Frame: min width 400, min height 250

**DataSourceSettings.swift (requirement SET-05, DATA-06):**
- Takes `UsageMonitor` from environment
- "Data Sources" section header
- Toggle: "OAuth Endpoint (Primary)" bound to `monitor.oauthEnabled`
  - Below toggle: brief description "Fetches usage data from Anthropic's API using your Claude Code credentials"
  - Status indicator: green dot + "Connected" if `oauthState == .available`, red dot + error message if `.failed`, gray dot + "Disabled" if `.disabled`
- Toggle: "Claude Code Logs (Fallback)" bound to `monitor.jsonlEnabled`
  - Below toggle: "Reads usage from local Claude Code session files in ~/.claude/"
  - Status indicator similar to above
- Note at bottom: "At least one data source must be enabled" -- if user tries to disable both, prevent it (disable the remaining toggle when only one is active)

**RefreshSettings.swift (requirement SET-03):**
- Takes `UsageMonitor` from environment
- "Refresh Interval" label with Picker or Stepper
- Options: 30 seconds, 1 minute (default), 2 minutes, 5 minutes, 10 minutes
- Use a `Picker` with `.pickerStyle(.menu)` for clean dropdown
- Bind to `monitor.refreshInterval` -- when changed, restart polling timer with new interval
- Show current value clearly: "Data refreshes every {interval}"

**AppearanceSettings.swift:**
- Takes `UsageMonitor` from environment (or a separate AppSettings @Observable)
- "Menu Bar Display" section:
  - Picker for icon style: "Percentage" (default), "Claude Logo", "Gauge Meter"
  - Per user decision: "User can change to: stylized Claude logo or abstract gauge/meter in settings"
  - For Phase 1, implement "Percentage" fully. For "Claude Logo" and "Gauge Meter", show as options but with "(Coming in future update)" note -- the actual icon rendering for these can be simplified or placeholder. The percentage mode is the locked default.
- Preview of current menu bar appearance (optional -- nice to have but not critical)

**Update ClaudeMonApp.swift -- Add right-click context menu:**
Per user decision: "Right-click behavior: shows quick menu with: Refresh now, Open floating window, Settings, Quit"

Implementation approach (from research):
- In the `.menuBarExtraAccess` callback, store the `NSStatusItem` reference in a property
- Set `statusItem.button?.sendAction(on: [.leftMouseUp, .rightMouseUp])`
- Add an `NSEvent.addLocalMonitorForEvents(matching: .rightMouseUp)` that checks if the click is within the status item button's frame
- When right-click detected on the status item:
  1. Prevent the popover from opening (set `isPopoverPresented = false` if it was toggled)
  2. Build and show an `NSMenu` at the status item position
- Context menu items:
  - "Refresh Now" (Cmd+R) -- calls `Task { await monitor.refresh() }`
  - Separator
  - "Open Floating Window" -- disabled/grayed out with "(Phase 4)" note (per roadmap, floating window is Phase 4)
  - "Settings..." (Cmd+,) -- opens Settings window
  - Separator
  - "Quit ClaudeMon" (Cmd+Q) -- calls `NSApplication.shared.terminate(nil)`

**Important right-click implementation detail:** The MenuBarExtraAccess library manages left-click for popover. The right-click monitor needs to:
1. Check if the event location is within the status item button's screen rect
2. If so, consume the event (return nil from the monitor to prevent propagation)
3. Show the NSMenu using `statusItem.menu = contextMenu` temporarily, then clear it after menu closes (so left-click still shows popover)

Alternative approach if the above is fragile: Use `NSStatusItem.menu` property. Set it to the context menu ONLY during right-click, then nil it out. Or use a coordinator/delegate pattern.

**Also update ClaudeMonApp.swift for status item appearance updates:**
- Ensure the status item text updates reactively when `monitor.currentUsage` changes
- If the `.menuBarExtraAccess` callback only fires once, use `withObservationTracking` in a Task to watch `monitor.currentUsage` and update the status item appearance
- When `monitor.error` is `.bothSourcesFailed` and `monitor.requiresManualRetry`, change the status item to show an error indicator: either "!" in warning color or the percentage with a small warning accent (per user decision: "obvious but not alarming")
  </action>
  <verify>
`xcodebuild build` succeeds. Run the app and verify:
1. Click gear icon in popover footer -- Settings window opens
2. Settings has three tabs: General, Data Sources, Appearance
3. Data Sources: can toggle OAuth on/off, can toggle JSONL on/off, cannot disable both
4. General: can change refresh interval, polling restarts with new interval
5. Right-click menu bar icon: context menu appears with Refresh Now, Settings, Quit
6. "Refresh Now" from context menu triggers a refresh
7. "Quit ClaudeMon" terminates the app
8. When both sources fail: menu bar shows error indicator
  </verify>
  <done>
Settings window with three tabs (General, Data Sources, Appearance) opens reliably from popover gear icon via SettingsAccess. Data source toggles control OAuth/JSONL independently with at-least-one-enabled guard. Refresh interval is configurable and takes effect immediately. Right-click on menu bar icon shows context menu with Refresh Now, Settings, and Quit. Error indicator appears in menu bar when both sources fail.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 1 experience</name>
  <files>
    ClaudeMon/ClaudeMonApp.swift
  </files>
  <action>
CHECKPOINT: Human verification of the complete Phase 1 experience.

What was built: Complete Phase 1 menu bar app with real usage data from OAuth endpoint and/or JSONL fallback, popover with usage breakdown, settings window, right-click context menu, and error handling with fallback chain.

How to verify:
1. Build and run the app from Xcode (Cmd+R)
2. Menu bar icon: Verify a colored percentage appears in the menu bar (no Dock icon should be visible)
3. Left-click: Click the percentage -- a popover should open showing large usage percentage at top, reset time and usage breakdown below, "Updated X ago" timestamp at the bottom, gear icon in the bottom-right
4. Right-click: Right-click the menu bar icon -- a context menu should appear with "Refresh Now", "Settings...", "Quit ClaudeMon"
5. Refresh: Click "Refresh Now" from context menu -- the data should refresh (spinner briefly visible)
6. Settings: Click the gear icon in the popover -- Settings window should open with General, Data Sources, and Appearance tabs
7. Data source toggle: In Settings > Data Sources, toggle OAuth off -- app should switch to JSONL source. Toggle it back on.
8. Refresh interval: In Settings > General, change refresh interval -- verify the new interval takes effect
9. Error handling: Temporarily disable both data sources in settings -- verify menu bar shows error indicator and popover shows error banner with "Show details" expander
10. Background persistence: Close the popover, wait for a refresh cycle -- the menu bar percentage should update without the popover being open

Resume signal: Type "approved" to complete Phase 1, or describe any issues to fix.
  </action>
  <verify>
User confirms all 10 verification steps pass. All Phase 1 success criteria from ROADMAP.md are met.
  </verify>
  <done>
User has approved the complete Phase 1 experience. All 18 requirements (DATA-01 through DATA-06, MENU-01 through MENU-06, USAGE-01 through USAGE-05, SET-01/03/05) are verified through human testing.
  </done>
</task>

</tasks>

<verification>
- Popover layout matches user decisions: big percentage at top, comfortable density, gear icon in footer
- Settings window opens reliably from MenuBarExtra via SettingsAccess
- Data source toggles work with at-least-one guard
- Refresh interval is configurable and takes effect immediately
- Right-click context menu appears with all specified items
- Error states show user-friendly messages with "Show details" for technical info
- Error indicator visible in menu bar when both sources fail
- All Phase 1 requirements (DATA-01 through DATA-06, MENU-01 through MENU-06, USAGE-01 through USAGE-05, SET-01/03/05) are met
</verification>

<success_criteria>
- Popover shows big usage percentage prominently, with limit remaining, reset time, and usage breakdown
- Comfortable density layout (breathing room, easy to read)
- Subtle spinner during refresh with always-visible "last updated" timestamp
- Error banner with user-friendly message and "Show details" expander
- Settings window with three tabs: General (refresh interval), Data Sources (toggle each), Appearance (icon style)
- Right-click context menu with: Refresh Now, Open Floating Window (disabled), Settings, Quit
- Data source toggles prevent disabling both simultaneously
- Menu bar error indicator when both sources fail (obvious but not alarming)
- All 18 Phase 1 requirements verified through human testing
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-monitoring/01-03-SUMMARY.md`
</output>
