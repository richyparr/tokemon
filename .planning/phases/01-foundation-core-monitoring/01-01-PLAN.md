---
phase: 01-foundation-core-monitoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Tokemon/TokemonApp.swift
  - Tokemon/Info.plist
  - Tokemon/Models/UsageSnapshot.swift
  - Tokemon/Models/OAuthUsageResponse.swift
  - Tokemon/Models/DataSourceState.swift
  - Tokemon/Services/UsageMonitor.swift
  - Tokemon/Utilities/Constants.swift
  - Tokemon/Utilities/GradientColors.swift
  - Tokemon/Views/MenuBar/PopoverContentView.swift
  - Tokemon.xcodeproj
  - Package.swift
autonomous: true

must_haves:
  truths:
    - "App compiles and runs as a background process (no Dock icon)"
    - "A status icon appears in the macOS menu bar showing a percentage (mock data)"
    - "Clicking the menu bar icon opens a popover with placeholder usage content"
    - "Menu bar text color changes based on usage level (subtle gradient)"
  artifacts:
    - path: "Tokemon/TokemonApp.swift"
      provides: "@main entry point with MenuBarExtra scene and Settings scene"
      contains: "MenuBarExtra"
    - path: "Tokemon/Info.plist"
      provides: "LSUIElement = YES for background-only app"
      contains: "LSUIElement"
    - path: "Tokemon/Models/UsageSnapshot.swift"
      provides: "Central usage state model used by all views"
      exports: ["UsageSnapshot"]
    - path: "Tokemon/Models/OAuthUsageResponse.swift"
      provides: "Codable model for OAuth /api/oauth/usage response"
      exports: ["OAuthUsageResponse"]
    - path: "Tokemon/Models/DataSourceState.swift"
      provides: "Enum tracking per-source availability state"
      exports: ["DataSourceState"]
    - path: "Tokemon/Services/UsageMonitor.swift"
      provides: "@Observable central state manager with polling stub"
      exports: ["UsageMonitor"]
    - path: "Tokemon/Utilities/GradientColors.swift"
      provides: "Usage-level gradient color mapping (subtle, not traffic lights)"
      exports: ["GradientColors"]
    - path: "Tokemon/Views/MenuBar/PopoverContentView.swift"
      provides: "Main popover layout shell"
      exports: ["PopoverContentView"]
  key_links:
    - from: "TokemonApp.swift"
      to: "UsageMonitor"
      via: "@State private var monitor"
      pattern: "@State.*UsageMonitor"
    - from: "TokemonApp.swift"
      to: "PopoverContentView"
      via: "MenuBarExtra content"
      pattern: "PopoverContentView"
    - from: "TokemonApp.swift"
      to: "NSStatusItem"
      via: "MenuBarExtraAccess .menuBarExtraAccess callback"
      pattern: "menuBarExtraAccess"
---

<objective>
Create the Tokemon Xcode project foundation: SwiftUI menu bar app with MenuBarExtra, popover shell, data models, and the UsageMonitor service skeleton. By the end of this plan, the app compiles, runs as a background process (no Dock icon), shows a colored percentage in the menu bar, and opens a popover with placeholder content when clicked.

Purpose: Everything in Phase 1 depends on having a working app shell with the correct project structure, dependencies, and MenuBarExtra + popover wiring.
Output: Compilable Xcode project with menu bar icon, popover shell, data models, and service skeleton.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-core-monitoring/01-RESEARCH.md
@.planning/phases/01-foundation-core-monitoring/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Xcode project with SPM dependencies and app entry point</name>
  <files>
    Tokemon.xcodeproj
    Tokemon/TokemonApp.swift
    Tokemon/Info.plist
  </files>
  <action>
Create a new Xcode project for a macOS app called "Tokemon" using SwiftUI lifecycle, targeting macOS 14.0+.

**Project setup:**
- Create via `xcodebuild` or by writing the project files directly. Use Swift Package Manager for dependencies.
- Add three SPM dependencies to the project:
  - `MenuBarExtraAccess` from `https://github.com/orchetect/MenuBarExtraAccess.git` (from: "1.2.2")
  - `SettingsAccess` from `https://github.com/orchetect/SettingsAccess.git` (from: "2.1.0")
  - `KeychainAccess` from `https://github.com/kishikawakatsumi/KeychainAccess.git` (from: "4.2.2")

**Info.plist:**
- Set `LSUIElement` to `YES` (app runs as background process, no Dock icon)
- Set bundle identifier to `com.tokemon.app`
- Set minimum deployment target to macOS 14.0

**TokemonApp.swift (the @main entry point):**
- Import SwiftUI, MenuBarExtraAccess, SettingsAccess
- Create `TokemonApp: App` with `@main`
- Declare `@State private var monitor = UsageMonitor()`
- Declare `@State private var isPopoverPresented = false`
- Body contains two scenes:
  1. `MenuBarExtra(isPresented: $isPopoverPresented)` with `.menuBarExtraStyle(.window)` -- content is `PopoverContentView().environment(monitor).frame(width: 320, height: 400)`
  2. `Settings { SettingsView().environment(monitor) }` (SettingsView will be a placeholder Text for now)
- Use `.menuBarExtraAccess(isPresented: $isPopoverPresented)` to access the NSStatusItem
- In the menuBarExtraAccess callback, call a helper function `updateStatusItemAppearance(_:usage:)` that:
  - Gets the button from the status item
  - Creates an NSAttributedString with the percentage text (e.g., "45%") using `NSFont.monospacedDigitSystemFont(ofSize: 12, weight: .medium)`
  - Sets the foreground color using `GradientColors.color(for: percentage)`
  - Assigns to `button.attributedTitle`
  - Sets `statusItem.length = NSStatusItem.variableLength`
- The MenuBarExtra label closure should show `Text(monitor.menuBarText)` as fallback

**Important:** The `.menuBarExtraAccess` modifier needs to update whenever `monitor.currentUsage` changes. Use `withObservationTracking` or ensure the callback fires on state changes. If the callback only fires once (on setup), store the NSStatusItem reference and update it from UsageMonitor's refresh method instead.

Create a placeholder `SettingsView.swift` in `Views/Settings/` with just `Text("Settings")` for now (will be built in Plan 03).
  </action>
  <verify>
Run `xcodebuild build -project Tokemon.xcodeproj -scheme Tokemon -destination 'platform=macOS'` -- build must succeed with zero errors. SPM dependencies must resolve.
  </verify>
  <done>
Xcode project compiles. Running the app shows a percentage in the macOS menu bar. No Dock icon appears. Clicking the percentage opens a popover (even if content is placeholder).
  </done>
</task>

<task type="auto">
  <name>Task 2: Create data models, UsageMonitor service, gradient colors, and popover shell</name>
  <files>
    Tokemon/Models/UsageSnapshot.swift
    Tokemon/Models/OAuthUsageResponse.swift
    Tokemon/Models/DataSourceState.swift
    Tokemon/Services/UsageMonitor.swift
    Tokemon/Utilities/Constants.swift
    Tokemon/Utilities/GradientColors.swift
    Tokemon/Views/MenuBar/PopoverContentView.swift
  </files>
  <action>
**UsageSnapshot.swift:**
- Codable struct representing current usage state
- Properties: `primaryPercentage: Double` (0-100), `fiveHourUtilization: Double?`, `sevenDayUtilization: Double?`, `sevenDayOpusUtilization: Double?`, `resetsAt: Date?`, `source: DataSource` (enum: `.oauth`, `.jsonl`, `.none`)
- For JSONL fallback: `inputTokens: Int?`, `outputTokens: Int?`, `cacheCreationTokens: Int?`, `cacheReadTokens: Int?`, `model: String?`
- Static `.empty` factory with all zeros and `.none` source
- Computed `menuBarText: String` returning e.g. "45%" or "--%" when empty

**OAuthUsageResponse.swift:**
- Codable struct matching the verified API response (from research):
  - `fiveHour: UsageWindow?`, `sevenDay: UsageWindow?`, `sevenDayOauthApps: UsageWindow?`, `sevenDayOpus: UsageWindow?`
  - CodingKeys: `five_hour`, `seven_day`, `seven_day_oauth_apps`, `seven_day_opus`
  - Nested `UsageWindow`: `utilization: Double`, `resetsAt: String?` (CodingKey: `resets_at`)
- Method `toSnapshot() -> UsageSnapshot` that maps the response to a UsageSnapshot, using `fiveHour.utilization` as `primaryPercentage` (this is the most relevant window for real-time monitoring), and populating the other utilization fields

**DataSourceState.swift:**
- Enum: `.available`, `.failed(Error)`, `.disabled`, `.notConfigured`
- Computed `isUsable: Bool` (true only for `.available`)

**UsageMonitor.swift:**
- `@Observable @MainActor final class UsageMonitor`
- Published properties: `currentUsage: UsageSnapshot = .empty`, `isRefreshing: Bool = false`, `lastUpdated: Date?`, `error: MonitorError?`, `oauthState: DataSourceState = .available`, `jsonlState: DataSourceState = .available`
- Computed `menuBarText: String` delegating to `currentUsage.menuBarText`
- `MonitorError` enum with cases: `oauthFailed(Error)`, `jsonlFailed(Error)`, `bothSourcesFailed(Error)`, `tokenExpired`, `insufficientScope`
- Stub methods (real implementation in Plan 02):
  - `func startPolling(interval: TimeInterval = 60)` -- for now, sets up a Timer that calls `refresh()` repeatedly. Include App Nap prevention via `ProcessInfo.processInfo.beginActivity(options: [.background, .idleSystemSleepDisabled], reason: "Tokemon usage monitoring")`
  - `func stopPolling()`
  - `func refresh() async` -- for now, sets `isRefreshing = true`, waits 0.5s (simulating network), sets mock data on `currentUsage` with a random percentage between 20-80, sets `lastUpdated = Date()`, sets `isRefreshing = false`
- Settings properties: `refreshInterval: TimeInterval` (stored in UserDefaults, default 60), `oauthEnabled: Bool` (UserDefaults, default true), `jsonlEnabled: Bool` (UserDefaults, default true)
- Call `startPolling()` from an `init()` or have the App call it on appear

**Constants.swift:**
- `static let oauthUsageURL = "https://api.anthropic.com/api/oauth/usage"`
- `static let oauthTokenRefreshURL = "https://console.anthropic.com/v1/oauth/token"`
- `static let oauthClientId = "9d1c250a-e61b-44d9-88ed-5944d1962f5e"`
- `static let keychainService = "Claude Code-credentials"`
- `static let defaultRefreshInterval: TimeInterval = 60`
- `static let claudeProjectsPath = "~/.claude/projects/"`
- `static let maxRetryAttempts = 3`

**GradientColors.swift:**
- Static function `color(for usage: Double) -> NSColor` implementing the subtle gradient per user decision (NOT harsh traffic lights):
  - 0..<40: `NSColor.secondaryLabelColor` (subtle, unobtrusive)
  - 40..<65: muted warm green-yellow `(0.6, 0.7, 0.3)`
  - 65..<80: amber `(0.85, 0.6, 0.2)`
  - 80..<95: warm orange `(0.9, 0.4, 0.2)`
  - 95+: muted red `(0.85, 0.25, 0.2)`
- These are calibrated NSColors, not system colors, per research recommendations

**PopoverContentView.swift:**
- Takes `UsageMonitor` from environment
- VStack with spacing 16, padding 16
- Top: large percentage text (SF Rounded, ~48pt, bold) showing `monitor.currentUsage.primaryPercentage` formatted as "45%"
- Below: secondary text "of 5-hour limit used" in `.secondary` color
- Divider
- Detail rows (placeholder for now -- will be refined in Plan 03):
  - "Resets at" with formatted date or "--"
  - "7-day usage" with percentage or "--"
- Spacer
- Divider
- Footer HStack: left side shows "Last updated: {time}" or spinner if refreshing, right side shows gear icon button (placeholder action for now)
- Frame: width 320, minHeight 300, maxHeight 500 (allow some flexibility)

**Wire it all together:**
- In TokemonApp, the monitor starts polling on init
- PopoverContentView reads from monitor environment
- Status item updates from monitor state
  </action>
  <verify>
Run `xcodebuild build -project Tokemon.xcodeproj -scheme Tokemon -destination 'platform=macOS'` -- must compile with zero errors. Run the app and verify: (1) percentage appears in menu bar with color, (2) clicking opens popover showing a percentage number, (3) percentage updates every ~60 seconds (mock data), (4) no Dock icon visible.
  </verify>
  <done>
App compiles and runs. Menu bar shows colored percentage text. Popover opens with usage percentage, placeholder details, and footer with last-updated timestamp. UsageMonitor provides mock data that cycles. All data models exist and are wired. GradientColors produces subtle (not harsh) color gradients.
  </done>
</task>

</tasks>

<verification>
- `xcodebuild build` succeeds with zero errors
- App launches as background process (no Dock icon)
- Menu bar shows percentage with subtle gradient color
- Clicking menu bar icon opens popover with usage content
- Mock data updates periodically (timer fires)
- All model files, service files, and utility files exist at expected paths
</verification>

<success_criteria>
- Compilable Xcode project with all three SPM dependencies resolving
- App runs as LSUIElement (no Dock icon)
- Menu bar shows colored percentage text using MenuBarExtraAccess
- Popover opens with SwiftUI content showing usage percentage and placeholder details
- UsageMonitor exists with polling infrastructure (mock data for now)
- All data models (UsageSnapshot, OAuthUsageResponse, DataSourceState) defined and compiling
- GradientColors implements subtle gradient (not harsh traffic lights) per user decision
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-core-monitoring/01-01-SUMMARY.md`
</output>
