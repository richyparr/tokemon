---
phase: 14-distribution-trust
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - Tokemon/Services/AlertManager.swift
  - Tokemon/Services/UsageMonitor.swift
  - Tokemon/Views/Settings/AlertSettings.swift
  - Tokemon/Utilities/Constants.swift
autonomous: true

must_haves:
  truths:
    - "User can enable auto-start session when usage resets to 0%"
    - "When usage drops from >0% to 0% (new window), app sends notification"
    - "Auto-start setting is persisted across app launches"
  artifacts:
    - path: "Tokemon/Services/AlertManager.swift"
      provides: "Session reset detection and notification"
      exports: ["checkForSessionReset"]
    - path: "Tokemon/Views/Settings/AlertSettings.swift"
      provides: "Auto-start toggle in alert settings"
      contains: "autoStartSession"
  key_links:
    - from: "Tokemon/Services/UsageMonitor.swift"
      to: "Tokemon/Services/AlertManager.swift"
      via: "refresh() calls checkForSessionReset"
      pattern: "checkForSessionReset"
    - from: "Tokemon/Views/Settings/AlertSettings.swift"
      to: "Tokemon/Services/AlertManager.swift"
      via: "Toggle binds to autoStartEnabled"
      pattern: "alertManager\\.autoStartEnabled"
---

<objective>
Implement auto-start session notification when usage resets to 0%.

Purpose: Users who work intensively with Claude Code want to know immediately when their usage window resets, so they can resume work. This feature notifies them when a new session is available.

Output:
- AlertManager extended to detect session reset (0% after being >0%)
- System notification sent when session resets
- Settings toggle to enable/disable this behavior
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Tokemon/Services/AlertManager.swift
@Tokemon/Services/UsageMonitor.swift
@Tokemon/Views/Settings/AlertSettings.swift
@Tokemon/Utilities/Constants.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add session reset detection to AlertManager</name>
  <files>
    Tokemon/Services/AlertManager.swift
    Tokemon/Utilities/Constants.swift
  </files>
  <action>
**Tokemon/Utilities/Constants.swift:**
Add constant for auto-start setting:
```swift
// MARK: - Auto-Start Session

/// UserDefaults key for auto-start session notification preference
static let autoStartSessionKey = "tokemon.autoStartSession"
```

**Tokemon/Services/AlertManager.swift:**
Add session reset detection alongside existing alert checking:

1. Add new stored property for auto-start preference:
```swift
/// Whether auto-start session notification is enabled
var autoStartEnabled: Bool {
    didSet {
        UserDefaults.standard.set(autoStartEnabled, forKey: Constants.autoStartSessionKey)
    }
}
```

2. Add tracking state for previous usage:
```swift
/// Previous usage percentage (to detect 0% transition)
@ObservationIgnored
private var previousPercentage: Double = -1

/// Whether we've notified about session reset this cycle
@ObservationIgnored
private var hasNotifiedSessionReset: Bool = false
```

3. Initialize in init():
```swift
self.autoStartEnabled = UserDefaults.standard.bool(forKey: Constants.autoStartSessionKey)
```

4. Add new method `checkForSessionReset`:
```swift
/// Check if usage has reset to 0% and send notification if enabled.
/// Called by UsageMonitor after each successful refresh.
///
/// - Parameter usage: Current usage snapshot
///
/// Logic:
/// - If previous percentage was > 0 and current is 0%, session has reset
/// - Send notification ONCE per reset cycle
/// - Reset the notification flag when usage goes back above 0%
func checkForSessionReset(_ usage: UsageSnapshot) {
    guard usage.hasPercentage else { return }
    guard autoStartEnabled else {
        previousPercentage = usage.primaryPercentage
        return
    }

    let current = usage.primaryPercentage

    // Detect reset: was > 0, now is 0
    if previousPercentage > 0 && current == 0 && !hasNotifiedSessionReset {
        hasNotifiedSessionReset = true
        sendSessionResetNotification()
    }

    // Reset notification flag when usage goes back above 0
    if current > 0 {
        hasNotifiedSessionReset = false
    }

    previousPercentage = current
}

/// Send notification that session has reset
private func sendSessionResetNotification() {
    guard hasAppBundle else {
        print("[AlertManager] No app bundle, skipping session reset notification")
        return
    }

    let content = UNMutableNotificationContent()
    content.title = "Session Available"
    content.subtitle = "Claude Code"
    content.body = "Your usage has reset to 0%. A fresh session is ready."
    content.sound = .default
    content.interruptionLevel = .timeSensitive

    let uniqueId = "tokemon.session-reset.\(Date().timeIntervalSince1970)"

    let request = UNNotificationRequest(
        identifier: uniqueId,
        content: content,
        trigger: nil
    )

    print("[AlertManager] Sending session reset notification")

    UNUserNotificationCenter.current().add(request) { error in
        if let error = error {
            print("[AlertManager] Session reset notification error: \(error.localizedDescription)")
        }
    }
}
```

5. Also reset `hasNotifiedSessionReset` in `resetNotificationState()`:
```swift
func resetNotificationState() {
    hasNotifiedWarning = false
    hasNotifiedCritical = false
    hasNotifiedSessionReset = false
    currentAlertLevel = .normal
}
```
  </action>
  <verify>
Run `swift build` to verify AlertManager compiles.
Check that checkForSessionReset method exists and has correct signature.
  </verify>
  <done>
AlertManager detects session reset (>0% to 0% transition) and sends notification when autoStartEnabled is true.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire session reset check and add Settings toggle</name>
  <files>
    Tokemon/Services/UsageMonitor.swift
    Tokemon/Views/Settings/AlertSettings.swift
  </files>
  <action>
**Tokemon/Services/UsageMonitor.swift:**
In the `refresh()` method, add a call to check for session reset after the main alert check.

Find the existing line:
```swift
onAlertCheck?(currentUsage)
```

The onAlertCheck callback already invokes alertManager.checkUsage(). We need to add session reset checking there too.

Option 1: Add a new callback `onSessionResetCheck`:
```swift
/// Callback invoked to check for session reset after each refresh.
@ObservationIgnored
var onSessionResetCheck: ((_ usage: UsageSnapshot) -> Void)?
```

Then in refresh(), after `onAlertCheck?(currentUsage)`:
```swift
onSessionResetCheck?(currentUsage)
```

Option 2: Have checkUsage also call checkForSessionReset internally.

Go with Option 2 since it keeps the wiring simpler. In AlertManager.checkUsage(), add at the end:
```swift
// Check for session reset (AUTO-01)
checkForSessionReset(usage)
```

**Tokemon/Views/Settings/AlertSettings.swift:**
Add toggle for auto-start session notification. Find the existing Form with alert threshold and notifications toggle.

Add a new Section after the existing alerts:
```swift
Section("Session Notifications") {
    Toggle("Notify when session resets", isOn: Binding(
        get: { alertManager.autoStartEnabled },
        set: { alertManager.autoStartEnabled = $0 }
    ))

    Text("Get notified when your usage resets to 0%, indicating a fresh session is available.")
        .font(.caption)
        .foregroundStyle(.secondary)
}
```

This toggle is separate from the warning/critical notifications since it serves a different purpose (starting work vs. pacing work).
  </action>
  <verify>
Run `swift build` to verify all files compile.
Check AlertSettings.swift has the new Section with toggle.
  </verify>
  <done>
Session reset checking wired into UsageMonitor refresh cycle.
AlertSettings has toggle for "Notify when session resets" with explanatory caption.
  </done>
</task>

</tasks>

<verification>
1. `swift build` compiles successfully
2. AlertManager.checkForSessionReset exists and is called from checkUsage
3. AlertSettings has "Session Notifications" section with toggle
4. autoStartEnabled persists via UserDefaults
5. Notification fires when usage transitions from >0% to 0%
</verification>

<success_criteria>
- User can enable "Notify when session resets" in Alert Settings
- When usage drops from any positive value to 0%, notification fires (once per cycle)
- Notification has title "Session Available" with friendly message
- Setting persists across app launches
</success_criteria>

<output>
After completion, create `.planning/phases/14-distribution-trust/14-04-SUMMARY.md`
</output>
