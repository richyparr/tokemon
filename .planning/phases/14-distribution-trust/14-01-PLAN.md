---
phase: 14-distribution-trust
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/build-release.sh
  - scripts/notarize.sh
  - .github/workflows/release.yml
autonomous: true
user_setup:
  - service: apple-developer
    why: "Code signing and notarization"
    env_vars:
      - name: APPLE_DEVELOPER_ID
        source: "Apple Developer Portal -> Certificates, IDs & Profiles -> Developer ID Application certificate"
      - name: APPLE_TEAM_ID
        source: "Apple Developer Portal -> Membership -> Team ID"
      - name: AC_PASSWORD
        source: "Apple ID -> App-Specific Password (create at appleid.apple.com)"
    dashboard_config:
      - task: "Create Developer ID Application certificate"
        location: "Apple Developer Portal -> Certificates, IDs & Profiles -> Certificates -> +"
      - task: "Download and install certificate in Keychain Access"
        location: "Local Keychain Access.app"

must_haves:
  truths:
    - "Running codesign on the built app binary produces a signed bundle"
    - "Running notarytool submit succeeds without Gatekeeper warnings"
    - "Release workflow produces signed and notarized .dmg artifact"
  artifacts:
    - path: "scripts/build-release.sh"
      provides: "Build and sign release binary"
      min_lines: 30
    - path: "scripts/notarize.sh"
      provides: "Notarization submission and stapling"
      min_lines: 40
    - path: ".github/workflows/release.yml"
      provides: "Automated release pipeline"
      min_lines: 50
  key_links:
    - from: "scripts/build-release.sh"
      to: "scripts/notarize.sh"
      via: "build-release calls notarize after signing"
      pattern: "notarize\\.sh"
    - from: ".github/workflows/release.yml"
      to: "scripts/build-release.sh"
      via: "workflow runs build script"
      pattern: "build-release\\.sh"
---

<objective>
Create the code signing, notarization, and release infrastructure for Tokemon.

Purpose: Establish the build pipeline for producing trusted, Gatekeeper-approved binaries that users can run without security warnings. This is prerequisite infrastructure for Homebrew distribution.

Output:
- Build script that produces signed Tokemon.app bundle
- Notarization script that submits to Apple and staples the ticket
- GitHub Actions workflow for automated releases
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@Package.swift
@Tokemon/Info.plist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create build and signing scripts</name>
  <files>
    scripts/build-release.sh
    scripts/notarize.sh
  </files>
  <action>
Create `scripts/` directory and two shell scripts:

**scripts/build-release.sh:**
- Accept version argument (e.g., `./build-release.sh 1.0.0`)
- Run `swift build -c release` to build the executable
- Create Tokemon.app bundle structure:
  - `Tokemon.app/Contents/MacOS/tokemon` (copy binary)
  - `Tokemon.app/Contents/Info.plist` (copy from Tokemon/Info.plist, update version)
  - `Tokemon.app/Contents/Resources/` (copy resources including logo PNGs)
- Sign with: `codesign --deep --force --verify --verbose --sign "Developer ID Application: $APPLE_DEVELOPER_ID" --options runtime Tokemon.app`
- The `--options runtime` enables hardened runtime required for notarization
- Verify signature: `codesign --verify --verbose Tokemon.app`
- Create DMG: `hdiutil create -volname "Tokemon" -srcfolder Tokemon.app -ov -format UDZO Tokemon-$VERSION.dmg`
- Sign DMG: `codesign --sign "Developer ID Application: $APPLE_DEVELOPER_ID" Tokemon-$VERSION.dmg`

**scripts/notarize.sh:**
- Accept DMG path argument
- Submit to notary service: `xcrun notarytool submit $DMG --apple-id "$APPLE_ID" --password "$AC_PASSWORD" --team-id "$APPLE_TEAM_ID" --wait`
- The `--wait` flag blocks until notarization completes (usually 1-5 minutes)
- On success, staple the ticket: `xcrun stapler staple $DMG`
- Also staple the app inside: unpack DMG, staple Tokemon.app, repack
- Verify: `spctl --assess --type open --context context:primary-signature --verbose $DMG`

Both scripts should:
- Set `set -e` for fail-fast
- Check required environment variables exist
- Print clear status messages with timestamps
- Exit with meaningful error codes
  </action>
  <verify>
Run `chmod +x scripts/*.sh && ./scripts/build-release.sh 1.0.0` (will fail without certificate but should produce unsigned .app bundle structure).
Check that Tokemon.app/Contents/ has MacOS/tokemon, Info.plist, and Resources/ with logo files.
  </verify>
  <done>
build-release.sh creates valid .app bundle and .dmg (signing requires certificate).
notarize.sh has correct notarytool and stapler commands.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions release workflow</name>
  <files>
    .github/workflows/release.yml
  </files>
  <action>
Create GitHub Actions workflow triggered by git tags matching `v*`:

```yaml
name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0'

      - name: Import signing certificate
        env:
          CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          echo "$CERTIFICATE_P12" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain -P "$CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "" build.keychain
          rm certificate.p12

      - name: Build and sign release
        env:
          APPLE_DEVELOPER_ID: ${{ secrets.APPLE_DEVELOPER_ID }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          chmod +x scripts/build-release.sh
          ./scripts/build-release.sh $VERSION

      - name: Notarize
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          AC_PASSWORD: ${{ secrets.AC_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          chmod +x scripts/notarize.sh
          ./scripts/notarize.sh Tokemon-$VERSION.dmg

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: Tokemon-*.dmg
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
```

The workflow requires these repository secrets (documented in user_setup):
- APPLE_CERTIFICATE_P12: Base64-encoded .p12 file
- APPLE_CERTIFICATE_PASSWORD: Password for .p12
- APPLE_DEVELOPER_ID: Certificate common name
- APPLE_ID: Apple account email
- AC_PASSWORD: App-specific password
- APPLE_TEAM_ID: 10-character team ID
  </action>
  <verify>
Run `cat .github/workflows/release.yml | head -30` to verify YAML structure.
Verify the workflow file is valid YAML with no syntax errors.
  </verify>
  <done>
release.yml workflow triggered by v* tags, imports certificate, builds, signs, notarizes, and creates GitHub release with DMG artifact.
  </done>
</task>

</tasks>

<verification>
1. `ls -la scripts/` shows build-release.sh and notarize.sh with execute permissions
2. `ls -la .github/workflows/` shows release.yml
3. `./scripts/build-release.sh 1.0.0` produces Tokemon.app bundle (unsigned without certificate)
4. YAML syntax validation: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/release.yml'))"`
</verification>

<success_criteria>
- Build script creates valid .app bundle structure from SPM executable
- Notarization script has correct xcrun notarytool commands
- GitHub Actions workflow automates the full release pipeline
- All scripts are documented with required environment variables
</success_criteria>

<output>
After completion, create `.planning/phases/14-distribution-trust/14-01-SUMMARY.md`
</output>
