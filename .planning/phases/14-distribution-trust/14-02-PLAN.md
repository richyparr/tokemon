---
phase: 14-distribution-trust
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - homebrew-tokemon/Formula/tokemon.rb
  - homebrew-tokemon/README.md
autonomous: true
user_setup:
  - service: github
    why: "Homebrew tap hosting"
    dashboard_config:
      - task: "Create new repository named 'homebrew-tokemon'"
        location: "GitHub -> New Repository"
      - task: "Repository must be public for Homebrew taps"
        location: "Repository settings"

must_haves:
  truths:
    - "User can run `brew tap <org>/tokemon` and `brew install tokemon` to install the app"
    - "Homebrew formula downloads the notarized DMG from GitHub releases"
    - "Installed app appears in /Applications and runs without Gatekeeper warnings"
  artifacts:
    - path: "homebrew-tokemon/Formula/tokemon.rb"
      provides: "Homebrew cask formula for Tokemon"
      min_lines: 20
    - path: "homebrew-tokemon/README.md"
      provides: "Installation instructions for tap"
      min_lines: 10
  key_links:
    - from: "homebrew-tokemon/Formula/tokemon.rb"
      to: "GitHub Releases"
      via: "url pointing to release DMG"
      pattern: "github\\.com.*releases.*\\.dmg"
---

<objective>
Create Homebrew tap for distributing Tokemon via `brew install`.

Purpose: Enable easy installation via Homebrew, the standard package manager for macOS developers. This gives users a familiar install experience and simplifies updates.

Output:
- Homebrew cask formula that installs Tokemon.app
- Tap repository structure ready to push to GitHub
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-distribution-trust/14-01-SUMMARY.md
@Tokemon/Info.plist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Homebrew tap repository structure</name>
  <files>
    homebrew-tokemon/Formula/tokemon.rb
    homebrew-tokemon/README.md
    homebrew-tokemon/.github/workflows/update-sha.yml
  </files>
  <action>
Create `homebrew-tokemon/` directory with Homebrew tap structure:

**homebrew-tokemon/Formula/tokemon.rb:**
```ruby
cask "tokemon" do
  version "1.0.0"
  sha256 "PLACEHOLDER_SHA256"

  url "https://github.com/YOUR_ORG/tokemon/releases/download/v#{version}/Tokemon-#{version}.dmg"
  name "Tokemon"
  desc "Monitor Claude Code usage from your macOS menu bar"
  homepage "https://tokemon.app"

  livecheck do
    url :url
    strategy :github_latest
  end

  app "Tokemon.app"

  zap trash: [
    "~/Library/Preferences/ai.tokemon.app.plist",
    "~/.tokemon",
  ]
end
```

**homebrew-tokemon/README.md:**
```markdown
# Homebrew Tap for Tokemon

Monitor your Claude Code usage from the macOS menu bar.

## Installation

```bash
brew tap YOUR_ORG/tokemon
brew install tokemon
```

## Upgrading

```bash
brew upgrade tokemon
```

## Uninstalling

```bash
brew uninstall tokemon
```

## About

Tokemon shows your Claude Code session usage, alerts before hitting limits, and helps you pace your work.

[Learn more at tokemon.app](https://tokemon.app)
```

**homebrew-tokemon/.github/workflows/update-sha.yml:**
A workflow that auto-updates the SHA256 when a new release is published (optional but helpful):
```yaml
name: Update Formula SHA

on:
  repository_dispatch:
    types: [release-published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (e.g., 1.0.1)'
        required: true

jobs:
  update-sha:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download and compute SHA
        run: |
          VERSION=${{ github.event.inputs.version || github.event.client_payload.version }}
          curl -L -o Tokemon.dmg "https://github.com/YOUR_ORG/tokemon/releases/download/v${VERSION}/Tokemon-${VERSION}.dmg"
          SHA=$(shasum -a 256 Tokemon.dmg | cut -d' ' -f1)
          echo "SHA256=$SHA" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Update formula
        run: |
          sed -i '' "s/version \".*\"/version \"$VERSION\"/" Formula/tokemon.rb
          sed -i '' "s/sha256 \".*\"/sha256 \"$SHA256\"/" Formula/tokemon.rb

      - name: Create PR
        uses: peter-evans/create-pull-request@v5
        with:
          title: "Update tokemon to v${{ env.VERSION }}"
          commit-message: "Update tokemon to v${{ env.VERSION }}"
          branch: "update-v${{ env.VERSION }}"
```

Note: Replace `YOUR_ORG` with actual GitHub org/username before pushing.
  </action>
  <verify>
Run `ls -la homebrew-tokemon/Formula/` to verify tokemon.rb exists.
Run `cat homebrew-tokemon/Formula/tokemon.rb | head -15` to verify cask structure.
  </verify>
  <done>
Homebrew tap repository structure created with cask formula, README, and optional SHA update workflow.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add tap publishing instructions to release workflow</name>
  <files>
    .github/workflows/release.yml
  </files>
  <action>
Update the existing release workflow (from 14-01) to add a step that triggers the homebrew tap update:

Add after the "Create Release" step:

```yaml
      - name: Compute DMG SHA256
        id: sha
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          SHA=$(shasum -a 256 Tokemon-$VERSION.dmg | cut -d' ' -f1)
          echo "sha256=$SHA" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Trigger Homebrew tap update
        uses: peter-evans/repository-dispatch@v2
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          repository: YOUR_ORG/homebrew-tokemon
          event-type: release-published
          client-payload: '{"version": "${{ steps.sha.outputs.version }}", "sha256": "${{ steps.sha.outputs.sha256 }}"}'
```

This requires a PAT with repo scope stored as HOMEBREW_TAP_TOKEN secret.

Also add to user_setup in the plan that user needs to:
1. Create the homebrew-tokemon repository on GitHub
2. Push the formula from homebrew-tokemon/ directory to that repo
3. Create a PAT with repo scope and add as HOMEBREW_TAP_TOKEN secret
  </action>
  <verify>
Run `cat .github/workflows/release.yml | grep -A5 "Trigger Homebrew"` to verify the step exists.
  </verify>
  <done>
Release workflow triggers homebrew tap update with version and SHA256.
  </done>
</task>

</tasks>

<verification>
1. `ls homebrew-tokemon/Formula/tokemon.rb` exists
2. `grep "cask \"tokemon\"" homebrew-tokemon/Formula/tokemon.rb` confirms cask format
3. `cat .github/workflows/release.yml` includes Homebrew tap trigger step
4. README has installation instructions
</verification>

<success_criteria>
- Homebrew cask formula correctly defines app installation from DMG
- Formula includes livecheck for version tracking
- Zap stanza cleans up preferences and cache on uninstall
- Release workflow triggers tap update on new releases
</success_criteria>

<output>
After completion, create `.planning/phases/14-distribution-trust/14-02-SUMMARY.md`
</output>
