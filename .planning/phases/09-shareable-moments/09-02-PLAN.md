---
phase: 09-shareable-moments
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - Tokemon/Views/Analytics/AnalyticsDashboardView.swift
autonomous: false

must_haves:
  truths:
    - "User can generate a usage card image showing their stats"
    - "User can copy the card image to clipboard with one click"
    - "Usage card includes Tokemon branding"
  artifacts:
    - path: "Tokemon/Views/Analytics/AnalyticsDashboardView.swift"
      provides: "Share Usage Card button in export section"
      contains: "Share Usage Card"
  key_links:
    - from: "AnalyticsDashboardView"
      to: "ShareableCardView"
      via: "creates card instance for clipboard copy"
      pattern: "ShareableCardView"
    - from: "AnalyticsDashboardView"
      to: "ExportManager.copyViewToClipboard"
      via: "copies rendered card to clipboard"
      pattern: "ExportManager\\.copyViewToClipboard"
    - from: "AnalyticsDashboardView"
      to: "FeatureAccessManager"
      via: "Pro gates .usageCards feature"
      pattern: "canAccess\\(\\.usageCards\\)"
---

<objective>
Integrate shareable card generation into the Analytics dashboard with Pro gating.

Purpose: Wire the ShareableCardView and clipboard methods into the UI, completing the user-facing share workflow.
Output: "Share Usage Card" button in Analytics export section, Pro-gated with .usageCards feature.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-shareable-moments/09-RESEARCH.md
@.planning/phases/09-shareable-moments/09-01-SUMMARY.md
@Tokemon/Views/Analytics/AnalyticsDashboardView.swift
@Tokemon/Services/FeatureAccessManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Share Usage Card button to Analytics dashboard</name>
  <files>Tokemon/Views/Analytics/AnalyticsDashboardView.swift</files>
  <action>
Modify AnalyticsDashboardView.swift to add a "Share Usage Card" button in the export section.

1. Add a new @State property for copy feedback:
```swift
@State private var isCopied = false
```

2. In `exportSection`, add a third button after the CSV button using the existing `exportButton` helper:
```swift
// Share Card Button
exportButton(
    title: isCopied ? "Copied!" : "Share Usage Card",
    icon: isCopied ? "checkmark" : "photo.fill",
    feature: .usageCards
) {
    await performCardCopy()
}
```

3. Add the `performCardCopy()` action method after `performCSVExport()`:
```swift
private func performCardCopy() async {
    // Get weekly summary for average utilization
    let weeklySummaries = AnalyticsEngine.weeklySummaries(from: monitor.usageHistory, weeks: 1)
    let avgUtilization = weeklySummaries.first?.averageUtilization ?? monitor.currentUsage.primaryPercentage

    // Get top project from last 7 days
    let topProject = AnalyticsEngine.projectBreakdown(since: Date().addingTimeInterval(-7 * 24 * 3600)).first

    // Build card with computed data
    let card = ShareableCardView(
        periodLabel: "This Week",
        utilizationPercentage: avgUtilization,
        topProjectName: topProject?.projectName,
        totalTokensUsed: topProject?.totalTokens,
        generatedDate: Date()
    )

    // Copy to clipboard
    if ExportManager.copyViewToClipboard(card) {
        isCopied = true
        // Reset after 2 seconds
        try? await Task.sleep(for: .seconds(2))
        isCopied = false
    }
}
```

Note: The existing `exportButton` helper already handles Pro gating via `.usageCards` feature check from FeatureAccessManager.
  </action>
  <verify>
Build succeeds: `cd /Users/richardparr/Tokemon && xcodebuild -scheme Tokemon -quiet build 2>&1 | tail -5`
Button exists: `grep "Share Usage Card" Tokemon/Views/Analytics/AnalyticsDashboardView.swift`
Pro gating: `grep ".usageCards" Tokemon/Views/Analytics/AnalyticsDashboardView.swift`
  </verify>
  <done>Analytics dashboard has "Share Usage Card" button that copies weekly usage card to clipboard, Pro-gated via .usageCards feature.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify shareable card workflow</name>
  <what-built>Complete shareable card workflow: card template, clipboard copy, Pro-gated button in Analytics</what-built>
  <how-to-verify>
1. Build and run Tokemon
2. Open Settings > Analytics tab
3. Scroll down to the Export section
4. Look for "Share Usage Card" button (should show lock icon if not Pro)
5. If Pro: Click the button, paste into any app (Notes, Preview, Slack) to verify image appears
6. Image should show: Tokemon branding, utilization %, optional project/tokens, tokemon.app URL
7. Button should briefly show "Copied!" feedback after clicking
  </how-to-verify>
  <resume-signal>Type "approved" if card copies correctly with branding, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Build passes with no errors
2. "Share Usage Card" button visible in Analytics export section
3. Button Pro-gated with .usageCards feature
4. Clicking button copies card image to clipboard
5. Pasted image shows Tokemon branding and usage stats
6. Button shows "Copied!" feedback momentarily
</verification>

<success_criteria>
- User can generate a usage card showing their stats (SHARE-01)
- User can copy the card image to clipboard with one click (SHARE-02)
- Usage card includes Tokemon branding (SHARE-03)
- Feature is Pro-gated via FeatureAccessManager
</success_criteria>

<output>
After completion, create `.planning/phases/09-shareable-moments/09-02-SUMMARY.md`
</output>
