---
phase: 13-terminal-statusline
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - Tokemon/Views/Settings/StatuslineSettings.swift
  - Tokemon/Views/Settings/SettingsView.swift
  - Tokemon/TokemonApp.swift
  - Tokemon/Services/UsageMonitor.swift
  - Tokemon/Services/SettingsWindowController.swift
  - Package.swift
autonomous: false

must_haves:
  truths:
    - "User can enable/disable statusline export from Settings"
    - "User can choose which fields to display (session %, weekly %, reset timer)"
    - "User can customize separator, prefix, suffix, and color toggle"
    - "Usage data is automatically exported to disk on every poll refresh"
    - "User can install the shell integration by clicking a button that copies the source command"
    - "User can see a live preview of the statusline format in Settings"
  artifacts:
    - path: "Tokemon/Views/Settings/StatuslineSettings.swift"
      provides: "Settings tab for statusline configuration and install"
      contains: "struct StatuslineSettings"
    - path: "Tokemon/TokemonApp.swift"
      provides: "StatuslineExporter wired into app lifecycle"
      contains: "statuslineExporter"
    - path: "Tokemon/Services/UsageMonitor.swift"
      provides: "Export hook called after each refresh"
      contains: "onStatuslineExport"
  key_links:
    - from: "Tokemon/Services/UsageMonitor.swift"
      to: "Tokemon/Services/StatuslineExporter.swift"
      via: "onStatuslineExport callback after each refresh"
      pattern: "onStatuslineExport"
    - from: "Tokemon/TokemonApp.swift"
      to: "Tokemon/Services/StatuslineExporter.swift"
      via: "StatuslineExporter created and wired in app init"
      pattern: "StatuslineExporter"
    - from: "Tokemon/Views/Settings/SettingsView.swift"
      to: "Tokemon/Views/Settings/StatuslineSettings.swift"
      via: "New tab in TabView"
      pattern: "StatuslineSettings"
---

<objective>
Wire the StatuslineExporter into the app refresh cycle, create the Settings UI for customization, and add the one-click install experience.

Purpose: This plan connects the export service (from Plan 01) to the rest of the app, gives users control over the format, and provides a frictionless install path. The user should be able to go from zero to seeing usage in their terminal in under 30 seconds.

Output: StatuslineSettings tab, UsageMonitor integration, app wiring, Package.swift resource, complete end-to-end pipeline.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-terminal-statusline/13-01-SUMMARY.md
@Tokemon/TokemonApp.swift
@Tokemon/Services/UsageMonitor.swift
@Tokemon/Views/Settings/SettingsView.swift
@Tokemon/Services/SettingsWindowController.swift
@Package.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StatuslineSettings view and wire into Settings tabs</name>
  <files>
    Tokemon/Views/Settings/StatuslineSettings.swift
    Tokemon/Views/Settings/SettingsView.swift
  </files>
  <action>
**StatuslineSettings.swift:**
Create a `struct StatuslineSettings: View` with `@State private var config = StatuslineConfig.load()`.

Layout (using Form with sections, matching existing settings tab patterns):

**Section 1: "Terminal Statusline"**
- Toggle: "Enable statusline export" bound to `config.enabled`. On change, call `config.save()` and post `StatuslineConfigChanged` notification.
- Caption text below toggle: "When enabled, Tokemon writes usage data to ~/.tokemon/statusline for your shell prompt."

**Section 2: "Fields" (only shown when enabled)**
- Toggle: "Session usage %" bound to `config.showSessionPercent`
- Toggle: "Weekly usage %" bound to `config.showWeeklyPercent`
- Toggle: "Reset timer" bound to `config.showResetTimer`
- All toggles call `config.save()` on change and post notification.

**Section 3: "Format" (only shown when enabled)**
- TextField: "Separator" bound to `config.separator`
- TextField: "Prefix" bound to `config.prefix`
- TextField: "Suffix" bound to `config.suffix`
- Toggle: "ANSI colors" bound to `config.useColors`
- All fields call `config.save()` on change (use `.onSubmit` for TextFields, `.onChange` for toggle) and post notification.

**Section 4: "Preview" (only shown when enabled)**
- Show a Text view with a monospaced font displaying what the statusline will look like using sample data: `[S:42% | W:78% | R:2h15m]` (using current config format settings). Build this preview string using the same logic as StatuslineExporter but with hardcoded sample values.

**Section 5: "Shell Integration" (only shown when enabled)**
- A text block showing the source command the user needs to add to their shell config:
  ```
  # Tokemon terminal statusline
  source ~/.tokemon/tokemon-statusline.sh
  ```
- A "Copy Install Command" button that copies the full integration snippet to clipboard:
  ```
  # Tokemon terminal statusline
  [ -f ~/.tokemon/tokemon-statusline.sh ] && source ~/.tokemon/tokemon-statusline.sh
  ```
  Use `NSPasteboard.general` for clipboard. Show "Copied!" feedback for 2 seconds (use isCopied state pattern from ShareableCardView).
- A caption explaining: "Add this line to your ~/.bashrc or ~/.zshrc. Then add $(tokemon_statusline) to your PS1 or PROMPT variable."
- A "Copy to Shell Config" button that appends the source line to the user's detected shell config file (~/.zshrc for zsh, ~/.bashrc for bash). Detect shell from `ProcessInfo.processInfo.environment["SHELL"]`. Show confirmation alert before writing. This satisfies TERM-04 (one-click install).

**Section 6: "Advanced" (only shown when enabled)**
- Caption text: "Raw JSON data is also available at ~/.tokemon/status.json for custom integrations."

Define `StatuslineConfigChanged` notification name as a static on StatuslineExporter (or as an extension on Notification.Name in the settings file).

**SettingsView.swift:**
Add a new tab after the "Appearance" tab (before "Alerts"):
```swift
StatuslineSettings()
    .tabItem {
        Label("Terminal", systemImage: "terminal")
    }
```

Note: The "terminal" SF Symbol is available on macOS 14+. If it doesn't exist, use "text.cursor" or "chevron.left.forwardslash.chevron.right" as fallback.
  </action>
  <verify>
Run `swift build` to verify compilation. Verify StatuslineSettings.swift exists and SettingsView.swift includes the Terminal tab.
  </verify>
  <done>
StatuslineSettings view provides full configuration UI with enable toggle, field selection, format customization, live preview, and shell integration install section. Settings tab appears in SettingsView as "Terminal". All config changes persist to UserDefaults and post notification.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire StatuslineExporter into app lifecycle and refresh cycle</name>
  <files>
    Tokemon/TokemonApp.swift
    Tokemon/Services/UsageMonitor.swift
    Tokemon/Services/SettingsWindowController.swift
    Package.swift
  </files>
  <action>
**UsageMonitor.swift:**
Add a new callback property (following the existing `onUsageChanged` and `onAlertCheck` pattern):
```swift
@ObservationIgnored
var onStatuslineExport: ((_ usage: UsageSnapshot) -> Void)?
```

Call `onStatuslineExport?(currentUsage)` in the `refresh()` method at the same points where `onUsageChanged` and `onAlertCheck` are called -- after successful OAuth fetch (line ~212), after successful JSONL fallback (line ~255), and in the both-failed path (line ~290). This ensures the statusline file is updated on every refresh cycle regardless of data source.

**TokemonApp.swift:**
1. Add a new `@State` property:
```swift
@State private var statuslineExporter = StatuslineExporter()
```

2. In the `.menuBarExtraAccess` closure (where other services are wired), add:
```swift
// Wire statusline export to refresh cycle
monitor.onStatuslineExport = { [statuslineExporter] usage in
    statuslineExporter.export(usage)
}

// Listen for config changes to reload exporter settings
NotificationCenter.default.addObserver(
    forName: StatuslineExporter.configChangedNotification,
    object: nil,
    queue: .main
) { _ in
    Task { @MainActor in
        statuslineExporter.reloadConfig()
        // Re-export with current data to immediately reflect format changes
        statuslineExporter.export(monitor.currentUsage)
    }
}
```

3. Also in the `.menuBarExtraAccess` closure, copy the shell helper script to `~/.tokemon/` on first launch:
```swift
// Copy shell helper script to ~/.tokemon/ for user access
statuslineExporter.installShellHelper()
```

Add an `installShellHelper()` method to StatuslineExporter that copies `tokemon-statusline.sh` from the app bundle (Bundle.module) to `~/.tokemon/tokemon-statusline.sh`. Only copy if the destination doesn't exist OR if the bundle version is newer (compare file modification dates). Make the copied file executable (`chmod +x`).

**SettingsWindowController.swift:**
No changes needed -- StatuslineSettings doesn't require environment injection since it manages its own state via StatuslineConfig (UserDefaults-backed). The settings window already receives all needed environments.

**Package.swift:**
Add the shell script to the resources array in the executable target:
```swift
.copy("Resources/tokemon-statusline.sh"),
```
Add it alongside the existing `.copy("Resources/tokemon_logo_white.png")` and `.copy("Resources/tokemon_logo.png")` entries.
  </action>
  <verify>
Run `swift build` to verify the full project compiles. Verify that the onStatuslineExport callback is defined in UsageMonitor and called in refresh(). Verify Package.swift includes the shell script resource.
  </verify>
  <done>
StatuslineExporter is created in TokemonApp and wired to UsageMonitor's refresh cycle via onStatuslineExport callback. Config change notifications trigger re-export with updated format. Shell helper script is auto-installed to ~/.tokemon/ on app launch. Package.swift includes shell script as a bundle resource. Complete end-to-end pipeline: app refreshes -> exports to disk -> shell reads from disk -> displays in prompt.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify terminal statusline end-to-end</name>
  <what-built>
Complete terminal statusline integration: StatuslineExporter writes usage data to ~/.tokemon/statusline on every refresh, shell helper script provides tokemon_statusline() function, Settings tab allows customization, one-click install copies source command to clipboard.
  </what-built>
  <how-to-verify>
1. Build and run: `swift build && .build/debug/tokemon`
2. Open Settings > Terminal tab
3. Enable "Terminal statusline" toggle
4. Verify preview shows sample format like `[S:42% | W:78% | R:2h15m]`
5. Wait for a refresh cycle (or trigger manually from menu bar)
6. Check that `~/.tokemon/statusline` exists and contains formatted usage text: `cat ~/.tokemon/statusline`
7. Check that `~/.tokemon/statusline-color` exists with ANSI codes: `cat -v ~/.tokemon/statusline-color`
8. Check that `~/.tokemon/status.json` exists with JSON: `cat ~/.tokemon/status.json`
9. Check that `~/.tokemon/tokemon-statusline.sh` exists and is executable: `ls -la ~/.tokemon/tokemon-statusline.sh`
10. Source the helper and test: `source ~/.tokemon/tokemon-statusline.sh && tokemon_statusline`
11. Verify the output matches the format shown in Settings preview
12. Try toggling fields off in Settings and verify the export updates accordingly
13. Click "Copy Install Command" and verify clipboard contains the source line
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `swift build` succeeds with all changes
2. Enabling statusline in Settings causes ~/.tokemon/statusline to be written on next refresh
3. Disabling statusline causes ~/.tokemon/statusline to be deleted (cleanup)
4. Shell helper script sourced in terminal prints current usage data
5. Changing format settings immediately updates the exported file
6. Install command correctly references ~/.tokemon/tokemon-statusline.sh
</verification>

<success_criteria>
- TERM-01: User can display usage in terminal statusline via tokemon_statusline() shell function
- TERM-02: Statusline shows session %, weekly %, reset timer (all configurable)
- TERM-03: User can customize format (field selection, separators, colors, prefix/suffix) in Settings
- TERM-04: One-click install via "Copy Install Command" button + auto-installed shell script
- Complete end-to-end pipeline from app refresh to terminal display
</success_criteria>

<output>
After completion, create `.planning/phases/13-terminal-statusline/13-02-SUMMARY.md`
</output>
