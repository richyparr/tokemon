---
phase: 05-theming-polish
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - Tokemon/TokemonApp.swift
  - Tokemon/Views/MenuBar/PopoverContentView.swift
  - Tokemon/Views/FloatingWindow/FloatingWindowView.swift
  - Tokemon/Services/FloatingWindowController.swift
  - Tokemon/Views/Charts/UsageChartView.swift
  - Tokemon/Views/Settings/SettingsView.swift
autonomous: false

must_haves:
  truths:
    - "User can switch themes in settings and see changes immediately"
    - "Selected theme applies consistently to popover and floating window"
    - "Native theme follows system appearance (light/dark)"
    - "Minimal Dark theme forces dark mode with muted blue accents"
    - "Anthropic theme uses warm orange (#c15f3c) accent colors"
    - "Chart colors reflect the selected theme"
  artifacts:
    - path: "Tokemon/TokemonApp.swift"
      provides: "ThemeManager @State and .environment() injection"
      contains: "@State private var themeManager"
    - path: "Tokemon/Views/MenuBar/PopoverContentView.swift"
      provides: "Themed popover with colorScheme override"
      contains: "ThemeManager"
    - path: "Tokemon/Views/FloatingWindow/FloatingWindowView.swift"
      provides: "Themed floating window with proper colors"
      contains: "ThemeColors"
    - path: "Tokemon/Services/FloatingWindowController.swift"
      provides: "ThemeManager environment injection to floating window"
      contains: "environment(themeManager)"
    - path: "Tokemon/Views/Charts/UsageChartView.swift"
      provides: "Theme-aware chart gradient colors"
      contains: "themeColors.chartGradientColors"
  key_links:
    - from: "Tokemon/TokemonApp.swift"
      to: "PopoverContentView"
      via: ".environment(themeManager)"
      pattern: "\\.environment\\(themeManager\\)"
    - from: "Tokemon/Services/FloatingWindowController.swift"
      to: "FloatingWindowView"
      via: ".environment(themeManager)"
      pattern: "\\.environment\\(themeManager\\)"
    - from: "Tokemon/Views/Charts/UsageChartView.swift"
      to: "ThemeColors"
      via: "chart foregroundStyle"
      pattern: "themeColors\\.chartGradientColors"
---

<objective>
Wire ThemeManager through the entire app and apply themed colors to PopoverContentView, FloatingWindowView, and UsageChartView. Ensure theme changes propagate consistently to all display surfaces.

Purpose: Complete the theming implementation by connecting infrastructure to UI.
Output: Fully themed app with consistent colors across popover, floating window, and charts.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-theming-polish/05-RESEARCH.md
@.planning/phases/05-theming-polish/05-01-SUMMARY.md

# Files to modify
@Tokemon/TokemonApp.swift
@Tokemon/Views/MenuBar/PopoverContentView.swift
@Tokemon/Views/FloatingWindow/FloatingWindowView.swift
@Tokemon/Services/FloatingWindowController.swift
@Tokemon/Views/Charts/UsageChartView.swift
@Tokemon/Views/Settings/SettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire ThemeManager Through App</name>
  <files>
    Tokemon/TokemonApp.swift
    Tokemon/Views/MenuBar/PopoverContentView.swift
    Tokemon/Views/FloatingWindow/FloatingWindowView.swift
    Tokemon/Services/FloatingWindowController.swift
    Tokemon/Views/Settings/SettingsView.swift
  </files>
  <action>
**TokemonApp.swift:**
1. Add `@State private var themeManager = ThemeManager()` alongside other @State properties
2. Update FloatingWindowController setup to pass themeManager:
   ```swift
   FloatingWindowController.shared.setThemeManager(themeManager)
   ```
3. Inject themeManager to PopoverContentView:
   ```swift
   PopoverContentView()
       .environment(monitor)
       .environment(alertManager)
       .environment(themeManager)  // ADD THIS
   ```
4. Inject themeManager to Settings scene:
   ```swift
   Settings {
       SettingsView()
           .environment(monitor)
           .environment(alertManager)
           .environment(themeManager)  // ADD THIS
   }
   ```

**FloatingWindowController.swift:**
1. Add `private var themeManager: ThemeManager?` property
2. Add `func setThemeManager(_ manager: ThemeManager)` method
3. In `showFloatingWindow()`, inject themeManager to FloatingWindowView:
   ```swift
   let contentView = FloatingWindowView()
       .environment(monitor)
       .environment(alertManager)
       .environment(themeManager)  // ADD THIS
   ```

**PopoverContentView.swift:**
1. Add `@Environment(ThemeManager.self) private var themeManager`
2. Add `@Environment(\.colorScheme) private var colorScheme`
3. Compute themeColors: `private var themeColors: ThemeColors { themeManager.colors(for: colorScheme) }`
4. Wrap body content in container with colorScheme override:
   ```swift
   var body: some View {
       popoverContent
           .preferredColorScheme(themeColors.colorSchemeOverride)
   }

   private var popoverContent: some View {
       VStack(spacing: 16) {
           // ... existing content
       }
       .padding(16)
       .frame(width: 320)
   }
   ```

**FloatingWindowView.swift:**
1. Add `@Environment(ThemeManager.self) private var themeManager`
2. Add `@Environment(\.colorScheme) private var colorScheme`
3. Compute themeColors: `private var themeColors: ThemeColors { themeManager.colors(for: colorScheme) }`
4. Apply colorScheme override to the view
5. Update background (if any) to use themeColors.primaryBackground

**SettingsView.swift:**
1. Add `@Environment(ThemeManager.self) private var themeManager`
2. Pass through to child views via .environment() if not already inherited

Note: The @Environment propagation should automatically flow to AppearanceSettings since it's a child view. If SettingsView uses explicit view construction, ensure .environment(themeManager) is passed.
  </action>
  <verify>
`swift build` compiles without errors. All modified files contain ThemeManager environment references.
  </verify>
  <done>
ThemeManager is wired through TokemonApp to PopoverContentView, FloatingWindowView, and SettingsView. Color scheme override applies based on selected theme.
  </done>
</task>

<task type="auto">
  <name>Task 2: Theme Chart Colors</name>
  <files>
    Tokemon/Views/Charts/UsageChartView.swift
  </files>
  <action>
Update UsageChartView to use theme-aware chart colors:

1. Add environment bindings:
   ```swift
   @Environment(ThemeManager.self) private var themeManager
   @Environment(\.colorScheme) private var colorScheme
   ```

2. Add computed themeColors property:
   ```swift
   private var themeColors: ThemeColors {
       themeManager.colors(for: colorScheme)
   }
   ```

3. Replace the hard-coded blue gradient in AreaMark:
   - Current: `colors: [.blue.opacity(0.4), .blue.opacity(0.1)]`
   - New: `colors: themeColors.chartGradientColors`

4. Replace the hard-coded blue in LineMark:
   - Current: `.foregroundStyle(.blue)`
   - New: `.foregroundStyle(themeColors.primaryAccent)`

This ensures:
- Native theme: Uses system accent color (typically blue)
- Minimal Dark: Uses muted blue (#4a9eff)
- Anthropic: Uses warm orange (#c15f3c)
  </action>
  <verify>
`swift build` compiles. UsageChartView contains @Environment(ThemeManager.self) and uses themeColors for chart gradient.
  </verify>
  <done>
UsageChartView chart colors reflect the selected theme. Area fill and line use theme accent colors instead of hard-coded blue.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Visual Theme Verification</name>
  <what-built>
Complete theme system with three themes (Native macOS, Minimal Dark, Anthropic) applied consistently to:
- Menu bar popover
- Floating window
- Usage chart
- Settings appearance picker
  </what-built>
  <how-to-verify>
1. Build and run: `swift build && .build/debug/Tokemon`
2. Click the menu bar icon to open popover
3. Open Settings (gear icon or Cmd+,) -> Appearance tab
4. Verify theme picker shows three options: Native macOS, Minimal Dark, Anthropic

**Test Native macOS theme:**
- Select "Native macOS"
- Popover should follow system light/dark appearance
- Chart uses system accent color (usually blue)
- Toggle System Preferences -> Appearance between Light/Dark
- Verify popover responds to system changes

**Test Minimal Dark theme:**
- Select "Minimal Dark"
- Popover should force dark appearance regardless of system setting
- Background should be near-black (#1a1a1a)
- Chart uses muted blue (#4a9eff)

**Test Anthropic theme:**
- Select "Anthropic"
- Popover should have warm, off-white background (light) or near-black (dark)
- Chart uses warm orange accent (#c15f3c)
- Overall feel should be warm, not harsh

**Test Floating Window:**
- Show floating window (Cmd+F or right-click menu bar -> Show Floating Window)
- Verify floating window reflects selected theme
- Change theme in settings while floating window is visible
- Verify floating window updates to match new theme

**Expected behavior:**
- Theme changes are immediate (no restart required)
- All surfaces (popover, floating window, charts) stay consistent
- Native theme follows system; Minimal Dark forces dark; Anthropic uses warm colors
  </how-to-verify>
  <resume-signal>Type "approved" if all themes work correctly, or describe specific issues (e.g., "floating window not updating", "chart still blue in Anthropic theme")</resume-signal>
</task>

</tasks>

<verification>
1. `swift build` completes successfully
2. App runs and themes can be switched in Settings
3. Popover appearance changes with theme selection
4. Floating window appearance changes with theme selection
5. Chart colors match theme accent colors
6. Native theme responds to macOS light/dark mode
7. Minimal Dark forces dark appearance
8. Anthropic theme uses warm orange accents
</verification>

<success_criteria>
- All three themes fully functional and visually distinct
- Theme changes apply immediately without restart
- Consistent appearance across popover and floating window
- Chart colors match theme palette
- Human verification confirms visual quality
</success_criteria>

<output>
After completion, create `.planning/phases/05-theming-polish/05-02-SUMMARY.md`
</output>
