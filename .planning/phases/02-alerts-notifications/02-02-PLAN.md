---
phase: 02-alerts-notifications
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - ClaudeMon/Services/AlertManager.swift
  - ClaudeMon/ClaudeMonApp.swift
  - ClaudeMon/Views/Settings/AlertSettings.swift
  - ClaudeMon/Views/Settings/SettingsView.swift
  - ClaudeMon/Services/SettingsWindowController.swift
autonomous: false

must_haves:
  truths:
    - "User receives macOS system notification when crossing warning threshold"
    - "User receives macOS system notification with critical sound when reaching 100%"
    - "User can enable/disable notifications in settings"
    - "User can configure alert threshold percentage in settings"
    - "User can toggle launch at login in settings"
    - "Notifications do not spam (only fire when crossing INTO a higher level)"
    - "Settings changes persist across app restarts"
  artifacts:
    - path: "ClaudeMon/Views/Settings/AlertSettings.swift"
      provides: "Alerts tab with threshold picker, notification toggle, launch at login toggle"
      min_lines: 60
    - path: "ClaudeMon/Views/Settings/SettingsView.swift"
      provides: "Fourth tab for Alerts"
      contains: "AlertSettings"
  key_links:
    - from: "ClaudeMon/Services/AlertManager.swift"
      to: "UNUserNotificationCenter"
      via: "sendNotification method"
      pattern: "UNUserNotificationCenter\\.current\\(\\)"
    - from: "ClaudeMon/Views/Settings/AlertSettings.swift"
      to: "SMAppService.mainApp"
      via: "launch at login toggle"
      pattern: "SMAppService\\.mainApp"
    - from: "ClaudeMon/ClaudeMonApp.swift"
      to: "UNUserNotificationCenterDelegate"
      via: "AppDelegate conformance"
      pattern: "UNUserNotificationCenterDelegate"
---

<objective>
Implement macOS system notifications and the Alerts settings tab for threshold configuration, notification preferences, and launch at login.

Purpose: Users want proactive notifications when approaching limits (even when not looking at the app) and the ability to customize alert behavior.
Output: Working notifications, Alerts settings tab with threshold picker, notification toggle, and launch at login.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-alerts-notifications/02-RESEARCH.md
@.planning/phases/02-alerts-notifications/02-01-SUMMARY.md

# Key existing files
@ClaudeMon/Services/AlertManager.swift
@ClaudeMon/ClaudeMonApp.swift
@ClaudeMon/Views/Settings/SettingsView.swift
@ClaudeMon/Services/SettingsWindowController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement macOS notifications in AlertManager</name>
  <files>
    ClaudeMon/Services/AlertManager.swift
    ClaudeMon/ClaudeMonApp.swift
  </files>
  <action>
**AlertManager.swift additions:**

1. Add import: `import UserNotifications`

2. Add `requestNotificationPermission()` method:
   ```swift
   func requestNotificationPermission() {
       UNUserNotificationCenter.current().requestAuthorization(options: [.alert, .sound]) { granted, _ in
           Task { @MainActor in
               self.notificationPermissionGranted = granted
           }
       }
   }
   ```

3. Call `requestNotificationPermission()` in AlertManager.init()

4. Implement `sendNotification(level:percentage:)` (replace the stub):
   ```swift
   private func sendNotification(level: AlertLevel, percentage: Int) {
       guard notificationsEnabled && notificationPermissionGranted else { return }
       guard level != .normal else { return }

       let content = UNMutableNotificationContent()

       switch level {
       case .warning:
           content.title = "Claude Usage Warning"
           content.body = "You've used \(percentage)% of your 5-hour limit."
           content.sound = .default
       case .critical:
           content.title = "Claude Usage Limit Reached"
           content.body = "You've reached your 5-hour usage limit."
           content.sound = UNNotificationSound.defaultCritical
       case .normal:
           return
       }

       // Fixed identifier per level prevents duplicate notifications
       let request = UNNotificationRequest(
           identifier: "claudemon.alert.\(level)",
           content: content,
           trigger: nil  // Immediate delivery
       )

       UNUserNotificationCenter.current().add(request) { error in
           if let error = error {
               print("[AlertManager] Notification error: \(error.localizedDescription)")
           }
       }
   }
   ```

5. Update `checkUsage()` to call `sendNotification(level: newLevel, percentage: percentage)` when transitioning to higher alert level

**ClaudeMonApp.swift additions:**

1. Add import: `import UserNotifications`

2. Add `@NSApplicationDelegateAdaptor private var appDelegate: AppDelegate` to ClaudeMonApp struct

3. In ClaudeMonApp.init(), set the notification delegate:
   ```swift
   init() {
       UNUserNotificationCenter.current().delegate = AppDelegate.shared
   }
   ```

4. Create AppDelegate class (or modify existing if present):
   ```swift
   class AppDelegate: NSObject, NSApplicationDelegate, UNUserNotificationCenterDelegate {
       static let shared = AppDelegate()

       // Show banner even when app is "active" (menu bar apps are always active)
       func userNotificationCenter(
           _ center: UNUserNotificationCenter,
           willPresent notification: UNNotification,
           withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void
       ) {
           completionHandler([.banner, .sound])
       }

       // Handle notification tap
       func userNotificationCenter(
           _ center: UNUserNotificationCenter,
           didReceive response: UNNotificationResponse,
           withCompletionHandler completionHandler: @escaping () -> Void
       ) {
           NSApp.activate(ignoringOtherApps: true)
           completionHandler()
       }
   }
   ```

Note: The AppDelegate must be a static shared instance because UNUserNotificationCenter.delegate is weak.
  </action>
  <verify>
`swift build` succeeds. Run the app, verify notification permission dialog appears on first launch. If usage is above threshold, notification should fire.
  </verify>
  <done>
AlertManager sends macOS notifications when crossing threshold levels. Notifications appear even when app is "active" (menu bar state). Fixed identifiers prevent spam.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Alerts settings tab with threshold, notifications, and launch at login</name>
  <files>
    ClaudeMon/Views/Settings/AlertSettings.swift
    ClaudeMon/Views/Settings/SettingsView.swift
    ClaudeMon/Services/SettingsWindowController.swift
    ClaudeMon/ClaudeMonApp.swift
  </files>
  <action>
**Create AlertSettings.swift:**

```swift
import SwiftUI
import ServiceManagement

/// Settings tab for alert thresholds, notifications, and startup behavior.
struct AlertSettings: View {
    @Environment(AlertManager.self) private var alertManager

    private let thresholdOptions = [50, 60, 70, 80, 90]

    // Read launch-at-login state directly from system (not UserDefaults)
    private var launchAtLoginEnabled: Bool {
        SMAppService.mainApp.status == .enabled
    }

    var body: some View {
        Form {
            // MARK: - Alert Threshold Section
            Section {
                Picker("Warning threshold", selection: Binding(
                    get: { alertManager.alertThreshold },
                    set: { alertManager.alertThreshold = $0 }
                )) {
                    ForEach(thresholdOptions, id: \.self) { value in
                        Text("\(value)%").tag(value)
                    }
                }
                .pickerStyle(.menu)

                Text("Show visual warning when usage exceeds this percentage")
                    .font(.caption)
                    .foregroundStyle(.secondary)
            } header: {
                Text("Alert Threshold")
            }

            // MARK: - Notifications Section
            Section {
                Toggle("macOS notifications", isOn: Binding(
                    get: { alertManager.notificationsEnabled },
                    set: { alertManager.notificationsEnabled = $0 }
                ))

                Text("Send system notifications when approaching usage limits")
                    .font(.caption)
                    .foregroundStyle(.secondary)

                // Show warning if notifications enabled but permission denied
                if alertManager.notificationsEnabled && !alertManager.notificationPermissionGranted {
                    HStack(spacing: 8) {
                        Image(systemName: "exclamationmark.triangle.fill")
                            .foregroundStyle(.orange)
                        Text("Notifications not permitted")
                            .font(.caption)
                        Spacer()
                        Button("Open Settings") {
                            openNotificationSettings()
                        }
                        .font(.caption)
                    }
                    .padding(.top, 4)
                }
            } header: {
                Text("Notifications")
            }

            // MARK: - Startup Section
            Section {
                Toggle("Launch at login", isOn: Binding(
                    get: { launchAtLoginEnabled },
                    set: { newValue in
                        do {
                            if newValue {
                                try SMAppService.mainApp.register()
                            } else {
                                try SMAppService.mainApp.unregister()
                            }
                        } catch {
                            print("[AlertSettings] Login item error: \(error.localizedDescription)")
                        }
                    }
                ))

                Text("Start ClaudeMon automatically when you log in")
                    .font(.caption)
                    .foregroundStyle(.secondary)
            } header: {
                Text("Startup")
            }
        }
        .formStyle(.grouped)
        .padding()
    }

    private func openNotificationSettings() {
        if let url = URL(string: "x-apple.systempreferences:com.apple.preference.notifications") {
            NSWorkspace.shared.open(url)
        }
    }
}
```

**Update SettingsView.swift:**

Add a fourth tab for Alerts after Appearance. SettingsView needs access to alertManager via environment:

```swift
@Environment(AlertManager.self) private var alertManager

// In body, add fourth tab:
AlertSettings()
    .environment(alertManager)
    .tabItem {
        Label("Alerts", systemImage: "bell.badge")
    }
```

**Update SettingsWindowController.swift:**
1. Add `private var alertManager: AlertManager?` property
2. Add `func setAlertManager(_ manager: AlertManager)` method similar to setMonitor
3. Update `createSettingsWindow()` to inject alertManager into SettingsView's environment alongside monitor

**Update ClaudeMonApp.swift:**
In the `.menuBarExtraAccess` callback, after setting monitor on SettingsWindowController:
```swift
SettingsWindowController.shared.setAlertManager(alertManager)
```

Also update the Settings scene to inject alertManager:
```swift
Settings {
    SettingsView()
        .environment(monitor)
        .environment(alertManager)
}
```
  </action>
  <verify>
`swift build` succeeds. Open Settings window, verify four tabs exist. Navigate to Alerts tab, verify:
1. Warning threshold picker shows 50-90% options, defaults to 80%
2. macOS notifications toggle works
3. Launch at login toggle reflects system state
4. Permission warning appears if notifications enabled but not permitted
  </verify>
  <done>
Alerts settings tab exists with configurable threshold (50-90%), notification toggle with permission status, and launch at login toggle using SMAppService.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete Phase 2 alert system</name>
  <files>N/A - verification only</files>
  <action>
Human verification of complete Phase 2 alert system: AlertManager service with threshold-based alerts, macOS system notifications, visual indicators in menu bar and popover, and Alerts settings tab.

**Build and run:** `swift build && .build/debug/ClaudeMon`

**Verification steps:**
1. Check notification permission dialog appears on first launch
2. Check visual indicators work (menu bar "!" for critical, popover warning banner)
3. Test Settings > Alerts tab (threshold picker, notification toggle, launch at login)
4. Test that notifications fire when crossing threshold (if testable with actual usage)
5. Verify settings persist across app restart
  </action>
  <verify>
Human confirms all Phase 2 functionality works correctly.
  </verify>
  <done>
Phase 2 complete: Alert system with visual indicators, macOS notifications, configurable thresholds, and launch at login all functioning correctly.
  </done>
</task>

</tasks>

<verification>
- `swift build` succeeds with no errors
- AlertManager imports UserNotifications and sends notifications
- AppDelegate conforms to UNUserNotificationCenterDelegate
- AlertSettings.swift exists with threshold picker, notification toggle, launch at login toggle
- SettingsView has four tabs including Alerts
- Notifications use fixed identifiers to prevent spam
- Launch at login uses SMAppService.mainApp (not UserDefaults)
</verification>

<success_criteria>
- macOS system notification fires when usage crosses warning threshold
- macOS notification with critical sound fires when usage reaches 100%
- User can enable/disable notifications in Settings > Alerts
- User can configure alert threshold (50-90%) in Settings > Alerts
- User can toggle launch at login in Settings > Alerts
- All settings persist across app restarts
</success_criteria>

<output>
After completion, create `.planning/phases/02-alerts-notifications/02-02-SUMMARY.md`
</output>
