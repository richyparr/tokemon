---
phase: 06-licensing-foundation
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - ClaudeMon/ClaudeMonApp.swift
  - ClaudeMon/Views/MenuBar/PopoverContentView.swift
  - ClaudeMon/Views/Licensing/TrialBannerView.swift
  - ClaudeMon/Views/Licensing/PurchasePromptView.swift
  - ClaudeMon/Views/Settings/LicenseSettings.swift
  - ClaudeMon/Views/Settings/SettingsView.swift
autonomous: true

must_haves:
  truths:
    - "User sees trial status with days remaining in menu bar when <= 3 days"
    - "User sees trial banner in popover with upgrade button"
    - "User is prompted to purchase when trial expires"
    - "User can enter a license key in Settings"
    - "User sees Pro status after successful activation"
    - "User can click link to manage subscription in LemonSqueezy portal"
  artifacts:
    - path: "ClaudeMon/Views/Licensing/TrialBannerView.swift"
      provides: "Trial status banner for popover"
      contains: "TrialBannerView"
    - path: "ClaudeMon/Views/Licensing/PurchasePromptView.swift"
      provides: "Purchase prompt modal"
      contains: "PurchasePromptView"
    - path: "ClaudeMon/Views/Settings/LicenseSettings.swift"
      provides: "License settings tab"
      contains: "LicenseSettings"
    - path: "ClaudeMon/ClaudeMonApp.swift"
      provides: "LicenseManager integration"
      contains: "LicenseManager"
  key_links:
    - from: "ClaudeMon/ClaudeMonApp.swift"
      to: "ClaudeMon/Services/LicenseManager.swift"
      via: "@State property and environment"
      pattern: "@State.*licenseManager.*LicenseManager"
    - from: "ClaudeMon/Views/MenuBar/PopoverContentView.swift"
      to: "ClaudeMon/Views/Licensing/TrialBannerView.swift"
      via: "Conditional rendering based on license state"
      pattern: "TrialBannerView"
    - from: "ClaudeMon/Views/Settings/LicenseSettings.swift"
      to: "LicenseManager"
      via: "Environment injection"
      pattern: "@Environment.*LicenseManager"
---

<objective>
Implement trial experience and purchase flow UI across menu bar, popover, and settings.

Purpose: Users must see their trial status, be prompted to purchase when appropriate, and have a clear path to activate a license key.
Output: Complete trial UX with TrialBannerView, PurchasePromptView, LicenseSettings tab, and menu bar integration.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/richardparr/ClaudeMon/.planning/PROJECT.md
@/Users/richardparr/ClaudeMon/.planning/phases/06-licensing-foundation/06-RESEARCH.md
@/Users/richardparr/ClaudeMon/.planning/phases/06-licensing-foundation/06-01-SUMMARY.md

Key integration points from existing code:
- PopoverContentView: Add TrialBannerView above error banner
- SettingsView: Add LicenseSettings tab after Alerts
- ClaudeMonApp: Add LicenseManager as @State, pass via .environment()
- StatusItemManager: Already has update() method - add license state parameter
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TrialBannerView and PurchasePromptView</name>
  <files>
    - ClaudeMon/Views/Licensing/TrialBannerView.swift
    - ClaudeMon/Views/Licensing/PurchasePromptView.swift
  </files>
  <action>
    1. Create directory structure if needed: ClaudeMon/Views/Licensing/

    2. Create TrialBannerView.swift following ErrorBannerView pattern:
       ```swift
       import SwiftUI

       /// Banner showing trial status in popover.
       /// Appears for onTrial, trialExpired, and gracePeriod states.
       struct TrialBannerView: View {
           let state: LicenseState
           let onPurchase: () -> Void

           var body: some View {
               switch state {
               case .onTrial(let days, _, _):
                   trialBanner(days: days)

               case .trialExpired:
                   expiredBanner

               case .gracePeriod(let days, _):
                   graceBanner(days: days)

               default:
                   EmptyView()
               }
           }

           @ViewBuilder
           private func trialBanner(days: Int) -> some View {
               HStack(spacing: 8) {
                   Image(systemName: "clock")
                       .foregroundStyle(.blue)

                   Text("Trial: \(days) day\(days == 1 ? "" : "s") remaining")
                       .font(.callout)

                   Spacer()

                   Button("Upgrade") {
                       onPurchase()
                   }
                   .buttonStyle(.borderedProminent)
                   .controlSize(.small)
               }
               .padding(10)
               .background(
                   RoundedRectangle(cornerRadius: 8)
                       .fill(Color.blue.opacity(0.1))
               )
           }

           private var expiredBanner: some View {
               HStack(spacing: 8) {
                   Image(systemName: "exclamationmark.triangle.fill")
                       .foregroundStyle(.orange)

                   VStack(alignment: .leading, spacing: 2) {
                       Text("Trial expired")
                           .font(.callout)
                           .fontWeight(.medium)
                       Text("Some features are limited")
                           .font(.caption)
                           .foregroundStyle(.secondary)
                   }

                   Spacer()

                   Button("Unlock Pro") {
                       onPurchase()
                   }
                   .buttonStyle(.borderedProminent)
                   .controlSize(.small)
               }
               .padding(10)
               .background(
                   RoundedRectangle(cornerRadius: 8)
                       .fill(Color.orange.opacity(0.1))
               )
           }

           @ViewBuilder
           private func graceBanner(days: Int) -> some View {
               HStack(spacing: 8) {
                   Image(systemName: "exclamationmark.circle.fill")
                       .foregroundStyle(.yellow)

                   VStack(alignment: .leading, spacing: 2) {
                       Text("Subscription lapsed")
                           .font(.callout)
                           .fontWeight(.medium)
                       Text("Renew within \(days) day\(days == 1 ? "" : "s") to keep Pro features")
                           .font(.caption)
                           .foregroundStyle(.secondary)
                   }

                   Spacer()

                   Button("Renew") {
                       onPurchase()
                   }
                   .buttonStyle(.borderedProminent)
                   .controlSize(.small)
               }
               .padding(10)
               .background(
                   RoundedRectangle(cornerRadius: 8)
                       .fill(Color.yellow.opacity(0.1))
               )
           }
       }
       ```

    3. Create PurchasePromptView.swift for modal presentation:
       ```swift
       import SwiftUI

       /// Modal prompt shown when trial expires or user clicks Upgrade.
       /// Provides purchase button and license key entry.
       struct PurchasePromptView: View {
           @Environment(\.dismiss) private var dismiss
           @Environment(LicenseManager.self) private var licenseManager

           @State private var licenseKeyInput: String = ""
           @State private var isActivating: Bool = false
           @State private var activationError: String?
           @State private var showingLicenseEntry: Bool = false

           var body: some View {
               VStack(spacing: 20) {
                   // Header
                   VStack(spacing: 8) {
                       Image(systemName: "star.fill")
                           .font(.system(size: 40))
                           .foregroundStyle(.yellow)

                       Text("Unlock ClaudeMon Pro")
                           .font(.title2)
                           .fontWeight(.bold)

                       Text("Get access to all features")
                           .font(.subheadline)
                           .foregroundStyle(.secondary)
                   }

                   // Features list
                   VStack(alignment: .leading, spacing: 12) {
                       FeatureRow(icon: "person.2.fill", text: "Multiple Claude accounts")
                       FeatureRow(icon: "chart.bar.fill", text: "Extended analytics & history")
                       FeatureRow(icon: "square.and.arrow.up.fill", text: "Export reports (PDF/CSV)")
                       FeatureRow(icon: "photo.fill", text: "Shareable usage cards")
                   }
                   .padding(.vertical, 8)

                   // Pricing
                   VStack(spacing: 4) {
                       Text("$3/month or $29/year")
                           .font(.headline)
                       Text("Cancel anytime")
                           .font(.caption)
                           .foregroundStyle(.secondary)
                   }

                   // Actions
                   VStack(spacing: 12) {
                       Button {
                           licenseManager.openPurchasePage()
                       } label: {
                           Text("Purchase License")
                               .frame(maxWidth: .infinity)
                       }
                       .buttonStyle(.borderedProminent)
                       .controlSize(.large)

                       Button {
                           withAnimation {
                               showingLicenseEntry.toggle()
                           }
                       } label: {
                           Text(showingLicenseEntry ? "Hide License Entry" : "I have a license key")
                               .font(.callout)
                       }
                       .buttonStyle(.plain)
                       .foregroundStyle(.blue)
                   }

                   // License key entry (expandable)
                   if showingLicenseEntry {
                       VStack(spacing: 8) {
                           TextField("Enter license key", text: $licenseKeyInput)
                               .textFieldStyle(.roundedBorder)

                           if let error = activationError {
                               Text(error)
                                   .font(.caption)
                                   .foregroundStyle(.red)
                           }

                           Button {
                               Task { await activateLicense() }
                           } label: {
                               if isActivating {
                                   ProgressView()
                                       .controlSize(.small)
                               } else {
                                   Text("Activate")
                               }
                           }
                           .buttonStyle(.bordered)
                           .disabled(licenseKeyInput.isEmpty || isActivating)
                       }
                       .transition(.opacity.combined(with: .move(edge: .top)))
                   }

                   // Dismiss button
                   Button("Maybe Later") {
                       dismiss()
                   }
                   .buttonStyle(.plain)
                   .foregroundStyle(.secondary)
                   .font(.callout)
               }
               .padding(24)
               .frame(width: 320)
           }

           private func activateLicense() async {
               isActivating = true
               activationError = nil
               defer { isActivating = false }

               do {
                   try await licenseManager.activateLicense(key: licenseKeyInput)
                   dismiss()
               } catch {
                   activationError = error.localizedDescription
               }
           }
       }

       private struct FeatureRow: View {
           let icon: String
           let text: String

           var body: some View {
               HStack(spacing: 12) {
                   Image(systemName: icon)
                       .frame(width: 24)
                       .foregroundStyle(.blue)
                   Text(text)
                       .font(.callout)
               }
           }
       }
       ```
  </action>
  <verify>
    - `swift build` succeeds
    - TrialBannerView handles all 3 relevant states (onTrial, trialExpired, gracePeriod)
    - PurchasePromptView has purchase button, license entry, and dismiss
  </verify>
  <done>
    TrialBannerView displays context-appropriate messaging for trial states; PurchasePromptView provides complete upgrade flow with license key activation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LicenseSettings tab and update SettingsView</name>
  <files>
    - ClaudeMon/Views/Settings/LicenseSettings.swift
    - ClaudeMon/Views/Settings/SettingsView.swift
  </files>
  <action>
    1. Create LicenseSettings.swift:
       ```swift
       import SwiftUI

       /// License settings tab for viewing status, activating keys, and managing subscription.
       struct LicenseSettings: View {
           @Environment(LicenseManager.self) private var licenseManager

           @State private var licenseKeyInput: String = ""
           @State private var isActivating: Bool = false
           @State private var activationError: String?
           @State private var showingDeactivateConfirm: Bool = false

           var body: some View {
               Form {
                   // Status section
                   Section("License Status") {
                       LabeledContent("Status") {
                           HStack(spacing: 6) {
                               statusIcon
                               Text(licenseManager.state.displayText)
                           }
                       }

                       if case .licensed(_, _, let expires) = licenseManager.state,
                          let expiresAt = expires {
                           LabeledContent("Renews") {
                               Text(expiresAt.formatted(date: .abbreviated, time: .omitted))
                           }
                       }

                       if let lastValidated = licenseManager.lastValidated {
                           LabeledContent("Last verified") {
                               Text(lastValidated.formatted(date: .abbreviated, time: .shortened))
                           }
                       }

                       if licenseManager.isValidating {
                           HStack {
                               ProgressView()
                                   .controlSize(.small)
                               Text("Validating...")
                                   .foregroundStyle(.secondary)
                           }
                       }
                   }

                   // Activation section (only for non-licensed states)
                   if !isLicensed {
                       Section("Activate License") {
                           TextField("License Key", text: $licenseKeyInput)
                               .textFieldStyle(.roundedBorder)

                           if let error = activationError {
                               Text(error)
                                   .font(.caption)
                                   .foregroundStyle(.red)
                           }

                           HStack {
                               Button("Activate") {
                                   Task { await activateLicense() }
                               }
                               .disabled(licenseKeyInput.isEmpty || isActivating)

                               if isActivating {
                                   ProgressView()
                                       .controlSize(.small)
                               }

                               Spacer()

                               Button("Purchase License") {
                                   licenseManager.openPurchasePage()
                               }
                           }
                       }
                   }

                   // Subscription management section
                   Section("Subscription") {
                       Button("Manage Subscription") {
                           licenseManager.openCustomerPortal()
                       }
                       .help("Opens LemonSqueezy customer portal in browser")

                       if isLicensed {
                           Button("Deactivate License", role: .destructive) {
                               showingDeactivateConfirm = true
                           }
                       }
                   }
               }
               .formStyle(.grouped)
               .frame(minWidth: 400)
               .confirmationDialog(
                   "Deactivate License?",
                   isPresented: $showingDeactivateConfirm,
                   titleVisibility: .visible
               ) {
                   Button("Deactivate", role: .destructive) {
                       Task { try? await licenseManager.deactivateLicense() }
                   }
                   Button("Cancel", role: .cancel) {}
               } message: {
                   Text("This will remove the license from this device. You can reactivate later with the same key.")
               }
           }

           private var isLicensed: Bool {
               if case .licensed = licenseManager.state { return true }
               return false
           }

           @ViewBuilder
           private var statusIcon: some View {
               switch licenseManager.state {
               case .licensed:
                   Image(systemName: "checkmark.seal.fill")
                       .foregroundStyle(.green)
               case .onTrial:
                   Image(systemName: "clock")
                       .foregroundStyle(.blue)
               case .trialExpired:
                   Image(systemName: "exclamationmark.triangle.fill")
                       .foregroundStyle(.orange)
               case .gracePeriod:
                   Image(systemName: "exclamationmark.circle.fill")
                       .foregroundStyle(.yellow)
               case .unlicensed:
                   Image(systemName: "xmark.circle.fill")
                       .foregroundStyle(.secondary)
               }
           }

           private func activateLicense() async {
               isActivating = true
               activationError = nil
               defer { isActivating = false }

               do {
                   try await licenseManager.activateLicense(key: licenseKeyInput)
                   licenseKeyInput = ""
               } catch {
                   activationError = error.localizedDescription
               }
           }
       }
       ```

    2. Update SettingsView.swift to add License tab:
       - Add LicenseManager environment
       - Add License tab with "key.fill" icon after Alerts tab

       Changes to make:
       ```swift
       // Add to environment declarations at top:
       @Environment(LicenseManager.self) private var licenseManager

       // Add new tab after AlertSettings, before AdminAPISettings:
       LicenseSettings()
           .environment(licenseManager)
           .tabItem {
               Label("License", systemImage: "key.fill")
           }
       ```
  </action>
  <verify>
    - `swift build` succeeds
    - SettingsView has 6 tabs: General, Data Sources, Appearance, Alerts, License, Admin API
    - LicenseSettings shows status with icon, activation form, and portal links
  </verify>
  <done>
    LicenseSettings tab provides complete license management UI; SettingsView integrates the new tab with proper environment passing.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate LicenseManager in app and popover</name>
  <files>
    - ClaudeMon/ClaudeMonApp.swift
    - ClaudeMon/Views/MenuBar/PopoverContentView.swift
  </files>
  <action>
    1. Update ClaudeMonApp.swift:
       - Add LicenseManager as @State property alongside UsageMonitor
       - Pass to views via .environment()
       - Wire onStateChanged callback for status item updates
       - Pass to SettingsWindowController

       Key changes:
       ```swift
       // Add to @State properties:
       @State private var licenseManager = LicenseManager()

       // In MenuBarExtra content, add environment:
       .environment(licenseManager)

       // In Settings scene, add environment:
       .environment(licenseManager)

       // In menuBarExtraAccess callback, add:
       SettingsWindowController.shared.setLicenseManager(licenseManager)

       // Wire license state callback (after monitor callbacks):
       licenseManager.onStateChanged = { [statusItemManager, alertManager] state in
           Task { @MainActor in
               statusItemManager.update(
                   with: monitor.currentUsage,
                   error: monitor.error,
                   alertLevel: alertManager.currentAlertLevel,
                   licenseState: state
               )
           }
       }
       ```

    2. Update StatusItemManager.update() to accept optional licenseState:
       ```swift
       func update(
           with usage: UsageSnapshot,
           error: UsageMonitor.MonitorError?,
           alertLevel: AlertManager.AlertLevel = .normal,
           licenseState: LicenseState? = nil
       ) {
           // ... existing logic ...

           // After determining text and before creating attributedTitle:
           // Add license state suffix if relevant
           if let suffix = licenseState?.menuBarSuffix {
               text = "\(text) \(suffix)"
           }

           // ... rest of existing logic ...
       }
       ```

    3. Update PopoverContentView.swift:
       - Add LicenseManager environment
       - Add TrialBannerView above error banner
       - Add sheet for PurchasePromptView

       Key changes:
       ```swift
       // Add environment:
       @Environment(LicenseManager.self) private var licenseManager

       // Add state for sheet:
       @State private var showingPurchasePrompt = false

       // In body, add TrialBannerView before error banner (above "if let error = monitor.error"):
       // Trial/License banner
       if shouldShowTrialBanner {
           TrialBannerView(state: licenseManager.state) {
               showingPurchasePrompt = true
           }
       }

       // Add computed property:
       private var shouldShowTrialBanner: Bool {
           switch licenseManager.state {
           case .onTrial, .trialExpired, .gracePeriod:
               return true
           default:
               return false
           }
       }

       // Add sheet modifier to popoverContent:
       .sheet(isPresented: $showingPurchasePrompt) {
           PurchasePromptView()
               .environment(licenseManager)
       }
       ```

    4. Update SettingsWindowController to handle LicenseManager:
       ```swift
       // Add property:
       private var licenseManager: LicenseManager?

       // Add setter:
       func setLicenseManager(_ manager: LicenseManager) {
           self.licenseManager = manager
       }

       // Update SettingsView creation to include environment
       ```
  </action>
  <verify>
    - `swift build` succeeds
    - App launches without crash
    - Trial banner appears in popover when on trial
    - Menu bar shows trial days when <= 3 days remaining
    - Settings window opens with License tab functional
  </verify>
  <done>
    LicenseManager integrated at app level; popover shows trial banner with upgrade action; menu bar displays license state suffix; Settings License tab receives environment correctly.
  </done>
</task>

</tasks>

<verification>
1. `swift build` completes without errors
2. App launches and shows trial status (new install starts 14-day trial)
3. Clicking menu bar icon shows popover with trial banner
4. Trial banner "Upgrade" button opens purchase prompt sheet
5. Settings > License tab shows correct status and activation form
6. "Manage Subscription" link opens LemonSqueezy portal in browser
</verification>

<success_criteria>
- TrialBannerView displays in popover for trial, expired, and grace period states
- PurchasePromptView modal provides purchase flow with license activation
- LicenseSettings tab shows status, activation form, and subscription management
- LicenseManager passed through SwiftUI environment to all relevant views
- Menu bar suffix shows trial days when <= 3 days remaining
- StatusItemManager update() method handles license state parameter
- Trial badge [3d] appears in menu bar for 3-day-or-less trials
- Expired state shows [!] badge in menu bar
</success_criteria>

<output>
After completion, create `.planning/phases/06-licensing-foundation/06-02-SUMMARY.md`
</output>
