---
phase: 22-security-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Tokemon/Utilities/Constants.swift
  - Tokemon/Services/ProfileManager.swift
  - Tokemon/Services/TokenManager.swift
  - Tokemon/Services/OAuthClient.swift
autonomous: true

must_haves:
  truths:
    - "Profile credentials (claudeSessionKey, cliCredentialsJSON) are NOT stored in UserDefaults plist on disk"
    - "Profile credentials are stored in macOS Keychain under service ai.tokemon.profiles"
    - "Existing users' credentials are migrated from UserDefaults to Keychain on first launch after update"
    - "Deleting a profile also removes its Keychain entries"
    - "Tokemon does NOT write back refreshed tokens to Claude Code's Keychain entry"
  artifacts:
    - path: "Tokemon/Utilities/Constants.swift"
      provides: "profilesKeychainService constant"
      contains: "ai.tokemon.profiles"
    - path: "Tokemon/Services/ProfileManager.swift"
      provides: "Keychain-backed credential storage with migration"
      contains: "Keychain(service: Constants.profilesKeychainService)"
    - path: "Tokemon/Services/TokenManager.swift"
      provides: "Disabled write-back with explanatory comment"
      contains: "Write-back disabled"
    - path: "Tokemon/Services/OAuthClient.swift"
      provides: "Updated caller that handles disabled write-back"
  key_links:
    - from: "Tokemon/Services/ProfileManager.swift"
      to: "Tokemon/Utilities/Constants.swift"
      via: "Constants.profilesKeychainService"
      pattern: "Constants\\.profilesKeychainService"
    - from: "Tokemon/Services/ProfileManager.swift"
      to: "KeychainAccess"
      via: "import KeychainAccess"
      pattern: "Keychain\\(service:"
---

<objective>
Migrate profile credentials from plaintext UserDefaults to encrypted Keychain storage, and disable the TokenManager write-back to Claude Code's Keychain entry to prevent ACL conflicts.

Purpose: Profile credentials (claudeSessionKey, cliCredentialsJSON) are currently stored as plaintext JSON in ~/Library/Preferences/ai.tokemon.app.plist, readable by any process. Moving them to the macOS Keychain encrypts them at rest using hardware-backed keys. The TokenManager write-back to Claude Code's Keychain entry compounds a known ACL conflict (Claude Code issue #19456) and should be disabled.

Output: ProfileManager stores/retrieves credentials via Keychain, existing users' credentials are automatically migrated, TokenManager write-back is a no-op.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-security-hardening/22-RESEARCH.md
@Tokemon/Services/ProfileManager.swift
@Tokemon/Services/TokenManager.swift
@Tokemon/Services/OAuthClient.swift
@Tokemon/Utilities/Constants.swift
@Tokemon/Models/Profile.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate profile credentials from UserDefaults to Keychain</name>
  <files>
    Tokemon/Utilities/Constants.swift
    Tokemon/Services/ProfileManager.swift
  </files>
  <action>
**Constants.swift:**
Add a new constant in the Multi-Profile section:
```swift
/// Keychain service for storing profile credentials (separate from Claude Code's keychain)
static let profilesKeychainService = "ai.tokemon.profiles"

/// UserDefaults key for one-time credential migration flag
static let credentialsMigratedKey = "tokemon.credentialsMigratedToKeychain"
```

**ProfileManager.swift:**

1. Add `import KeychainAccess` at the top of the file (alongside existing `import Foundation`).

2. Modify `saveProfiles()` to:
   - Before encoding, save each profile's credentials to Keychain using `Keychain(service: Constants.profilesKeychainService)` with keys `"\(profile.id.uuidString).sessionKey"` and `"\(profile.id.uuidString).cliCredentials"`. If the value is nil, remove the key.
   - Create a copy of profiles with `claudeSessionKey = nil` and `cliCredentialsJSON = nil` stripped out.
   - Encode and save the STRIPPED copy to UserDefaults (not the original profiles array).
   - Keep the activeProfileId save logic unchanged.

3. Modify `loadProfiles()` to:
   - After decoding profiles from UserDefaults (the existing decode logic), perform one-time migration:
     - Check `UserDefaults.standard.bool(forKey: Constants.credentialsMigratedKey)`.
     - If false AND any decoded profile has non-nil `claudeSessionKey` or `cliCredentialsJSON`, write those values to Keychain, then set the migration flag to true.
   - After migration check, re-populate credentials from Keychain for ALL profiles:
     ```swift
     let keychain = Keychain(service: Constants.profilesKeychainService)
     for i in profiles.indices {
         let accountKey = profiles[i].id.uuidString
         profiles[i].claudeSessionKey = try? keychain.getString("\(accountKey).sessionKey")
         profiles[i].cliCredentialsJSON = try? keychain.getString("\(accountKey).cliCredentials")
     }
     ```

4. Modify `deleteProfile(id:)` to:
   - After `profiles.remove(at: index)` (line 85), add Keychain cleanup:
     ```swift
     let keychain = Keychain(service: Constants.profilesKeychainService)
     try? keychain.remove("\(id.uuidString).sessionKey")
     try? keychain.remove("\(id.uuidString).cliCredentials")
     ```

5. Modify `enterManualSessionKey(for:sessionKey:orgId:)` to:
   - After setting `profiles[index].claudeSessionKey = sessionKey`, also write directly to Keychain:
     ```swift
     let keychain = Keychain(service: Constants.profilesKeychainService)
     try? keychain.set(sessionKey, key: "\(profileId.uuidString).sessionKey")
     ```
   - The `saveProfiles()` call at the end will also write to Keychain, but the direct write ensures immediate persistence.

6. Modify `syncCredentialsFromKeychain(for:)` to:
   - After setting `profiles[index].cliCredentialsJSON = jsonString` (line 192), also write directly to Keychain:
     ```swift
     let keychain = Keychain(service: Constants.profilesKeychainService)
     try? keychain.set(jsonString, key: "\(profileId.uuidString).cliCredentials")
     ```

**Important:** The Profile struct itself is NOT modified. It continues to carry `claudeSessionKey` and `cliCredentialsJSON` as in-memory fields. The change is purely in how ProfileManager persists/loads them.
  </action>
  <verify>
Build the project with `xcodebuild build -scheme Tokemon -destination 'platform=macOS' 2>&1 | tail -5` to confirm it compiles. Then verify:
1. `grep -c "profilesKeychainService" Tokemon/Utilities/Constants.swift` returns 1+
2. `grep -c "Keychain(service: Constants.profilesKeychainService)" Tokemon/Services/ProfileManager.swift` returns 3+ (saveProfiles, loadProfiles, deleteProfile)
3. `grep -c "credentialsMigratedKey" Tokemon/Services/ProfileManager.swift` returns 1+ (migration check)
4. `grep "claudeSessionKey = nil" Tokemon/Services/ProfileManager.swift` confirms credentials are stripped before UserDefaults save
  </verify>
  <done>
Profile credentials are stored in Keychain under service "ai.tokemon.profiles" with UUID-based keys. UserDefaults plist contains profile metadata but no credentials. Existing users' credentials are migrated on first load. Profile deletion cleans up Keychain entries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Disable TokenManager Keychain write-back and update caller</name>
  <files>
    Tokemon/Services/TokenManager.swift
    Tokemon/Services/OAuthClient.swift
  </files>
  <action>
**TokenManager.swift:**

1. Replace the body of `updateKeychainCredentials(response:)` (lines 179-208) with a no-op + log:
```swift
static func updateKeychainCredentials(response: OAuthTokenResponse) throws {
    // Write-back disabled: Tokemon does not write refreshed tokens back to
    // Claude Code's Keychain entry. Doing so risks ACL conflicts with Claude
    // Code's own token refresh mechanism, especially after auto-updates.
    // See: https://github.com/anthropics/claude-code/issues/19456
    // Users should run 'claude /login' to refresh expired tokens.
    print("[TokenManager] Token refresh available but write-back disabled to avoid Keychain conflict with Claude Code")
}
```

2. Replace the body of `updateKeychainCredentials(response:for username:)` (lines 267-288) with the same no-op pattern:
```swift
static func updateKeychainCredentials(response: OAuthTokenResponse, for username: String) throws {
    // Write-back disabled: same rationale as the non-parameterized overload.
    // See: https://github.com/anthropics/claude-code/issues/19456
    print("[TokenManager] Token refresh available but write-back disabled to avoid Keychain conflict with Claude Code")
}
```

**OAuthClient.swift:**

3. In `performTokenRefresh()` (around line 164-172), update the comment and handle the fact that write-back is now a no-op. The call `try TokenManager.updateKeychainCredentials(response: tokenResponse)` can remain as-is since the method is now a no-op that just logs. But update the comment:
```swift
private static func performTokenRefresh() async throws -> String {
    let refreshToken = try TokenManager.getRefreshToken()
    let tokenResponse = try await TokenManager.refreshAccessToken(refreshToken: refreshToken)

    // Note: updateKeychainCredentials is a no-op (write-back disabled to avoid
    // Claude Code Keychain conflicts). The refreshed token is used for this
    // session only; users must run 'claude /login' when tokens fully expire.
    try TokenManager.updateKeychainCredentials(response: tokenResponse)

    return tokenResponse.accessToken
}
```
  </action>
  <verify>
Build with `xcodebuild build -scheme Tokemon -destination 'platform=macOS' 2>&1 | tail -5`.
Verify:
1. `grep "Write-back disabled" Tokemon/Services/TokenManager.swift` returns matches in both overloads
2. `grep -c "keychain.set" Tokemon/Services/TokenManager.swift` returns 0 (no more Keychain writes in TokenManager)
3. `grep "no-op" Tokemon/Services/OAuthClient.swift` returns a match in the comment
  </verify>
  <done>
Both `updateKeychainCredentials` overloads are no-ops that log a message. No code writes to Claude Code's "Claude Code-credentials" Keychain entry. OAuthClient still calls the method (preserving the API surface) but the call does nothing.
  </done>
</task>

</tasks>

<verification>
1. Project compiles without errors: `xcodebuild build -scheme Tokemon -destination 'platform=macOS'`
2. Profile credentials NOT in UserDefaults encoding: `grep "claudeSessionKey = nil" Tokemon/Services/ProfileManager.swift`
3. Keychain service constant exists: `grep "ai.tokemon.profiles" Tokemon/Utilities/Constants.swift`
4. TokenManager write-back disabled: `grep -c "Write-back disabled" Tokemon/Services/TokenManager.swift` returns 2
5. Migration flag exists: `grep "credentialsMigratedKey" Tokemon/Utilities/Constants.swift`
</verification>

<success_criteria>
- Profile credentials are encrypted at rest in macOS Keychain, not in plaintext UserDefaults plist
- Existing users' credentials are automatically migrated on first launch
- Profile deletion removes Keychain entries
- TokenManager no longer writes to Claude Code's Keychain entry
- Project builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/22-security-hardening/22-01-SUMMARY.md`
</output>
