---
phase: 22-security-hardening
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - Tokemon/Services/ProfileManager.swift
  - Tokemon/Services/TokenManager.swift
  - Tokemon/Services/AdminAPIClient.swift
  - Tokemon/Services/WebhookManager.swift
  - Tokemon/Services/UsageMonitor.swift
  - Tokemon/Services/BudgetManager.swift
  - Tokemon/Services/AlertManager.swift
  - Tokemon/Services/SettingsWindowController.swift
  - Tokemon/Services/FloatingWindowController.swift
  - Tokemon/Services/JSONLParser.swift
  - Tokemon/Tokemon.entitlements
autonomous: true

must_haves:
  truths:
    - "No print() calls remain in service files -- all replaced with OSLog.Logger"
    - "HTTP response bodies are logged with .private privacy annotation"
    - "Webhook URLs must use HTTPS -- http:// URLs are rejected with a clear error"
    - "Entitlements file documents why sandboxing is disabled"
  artifacts:
    - path: "Tokemon/Services/AdminAPIClient.swift"
      provides: "OSLog logger with .private on response bodies"
      contains: "Logger(subsystem:"
    - path: "Tokemon/Services/ProfileManager.swift"
      provides: "OSLog logger replacing all print() calls"
      contains: "Logger(subsystem:"
    - path: "Tokemon/Services/WebhookManager.swift"
      provides: "HTTPS enforcement and OSLog logging"
      contains: "insecureURL"
    - path: "Tokemon/Tokemon.entitlements"
      provides: "Sandboxing rationale documentation"
      contains: "sandboxing is disabled"
  key_links:
    - from: "Tokemon/Services/WebhookManager.swift"
      to: "WebhookError enum"
      via: "insecureURL case"
      pattern: "case insecureURL"
    - from: "Tokemon/Services/AdminAPIClient.swift"
      to: "OSLog"
      via: "import OSLog"
      pattern: "logger\\.error.*privacy: \\.private"
---

<objective>
Replace all print() logging with OSLog.Logger across service files (with privacy annotations on sensitive data), enforce HTTPS-only webhook URLs, and document sandboxing rationale.

Purpose: print() output is always visible in Console.app to any process -- response bodies on lines 369 and 493 of AdminAPIClient.swift may contain API error details. OSLog.Logger with `.private` annotations redacts sensitive values on user devices. HTTP webhook URLs transmit usage data in plaintext. Sandboxing infeasibility should be documented for future reference.

Output: All service files use OSLog.Logger, webhook URLs require HTTPS, entitlements document sandboxing rationale.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-security-hardening/22-RESEARCH.md
@.planning/phases/22-security-hardening/22-01-SUMMARY.md
@Tokemon/Services/AdminAPIClient.swift
@Tokemon/Services/WebhookManager.swift
@Tokemon/Services/ProfileManager.swift
@Tokemon/Services/TokenManager.swift
@Tokemon/Services/UsageMonitor.swift
@Tokemon/Services/BudgetManager.swift
@Tokemon/Services/AlertManager.swift
@Tokemon/Services/SettingsWindowController.swift
@Tokemon/Services/FloatingWindowController.swift
@Tokemon/Services/JSONLParser.swift
@Tokemon/Tokemon.entitlements
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace all print() with OSLog.Logger across service files</name>
  <files>
    Tokemon/Services/ProfileManager.swift
    Tokemon/Services/TokenManager.swift
    Tokemon/Services/AdminAPIClient.swift
    Tokemon/Services/WebhookManager.swift
    Tokemon/Services/UsageMonitor.swift
    Tokemon/Services/BudgetManager.swift
    Tokemon/Services/AlertManager.swift
    Tokemon/Services/SettingsWindowController.swift
    Tokemon/Services/FloatingWindowController.swift
    Tokemon/Services/JSONLParser.swift
  </files>
  <action>
For each service file, apply the same pattern:

1. Add `import OSLog` at the top of the file.
2. Add a file-level private logger constant (outside the class/struct, at file scope):
   ```swift
   private let logger = Logger(subsystem: Bundle.main.bundleIdentifier ?? "ai.tokemon.app", category: "ClassName")
   ```
   Where `ClassName` matches the file's primary type name (e.g., "ProfileManager", "AdminAPIClient", "TokenManager", etc.).

3. Replace every `print("[Tag] ...")` call with the appropriate logger method and privacy annotations.

**Privacy annotation rules:**
- HTTP status codes: `.public`
- Profile names, display names: `.public`
- Error descriptions (non-credential): `.public`
- Counts (profile count, skip counts): `.public`
- UUID strings: `.public` (not secrets, needed for debugging)
- HTTP response bodies: `.private` (may contain tokens/API data)
- Credential JSON strings: `.private`
- Session keys / access tokens: `.private`
- Keychain operation details: `.public` (just status codes, not content)

**Log level mapping:**
- Informational operations (loaded, created, activated, synced): `logger.info(...)`
- Errors and failures: `logger.error(...)`
- Warnings (can't delete last profile, not found): `logger.warning(...)`
- Debug-level (window reset detected, notification state): `logger.debug(...)`

**Specific file guidance:**

**AdminAPIClient.swift** (most security-critical):
- Line 369: `print("[AdminAPI] cost_report error ...")` -> `logger.error("cost_report error \(httpResponse.statusCode, privacy: .public): \(body, privacy: .private)")`
- Line 493: `print("[AdminAPI] cost_report (workspace) error ...")` -> `logger.error("cost_report (workspace) error \(httpResponse.statusCode, privacy: .public): \(body, privacy: .private)")`
- Note: AdminAPIClient is an `actor`, so the logger must be defined at file scope (outside the actor), not as an actor property.

**ProfileManager.swift:**
- Replace all ~25 print() calls. This file was modified in Plan 01 and may have new print() calls from the migration code.
- Credential-related log messages should use `.private` for any credential content.
- Profile names use `.public`.

**TokenManager.swift:**
- Line 207: `print("[Tokemon] Writing refreshed credentials...")` -- this line may have been changed in Plan 01 to a different message. Replace whatever print() remains with `logger.info(...)`.

**WebhookManager.swift:**
- Lines 67, 120, 127: Replace with appropriate logger calls.
- Webhook send failures: `logger.error(...)` with `.public` on error descriptions (they are LocalizedError strings, not sensitive).

**UsageMonitor.swift:**
- Lines 144, 235, 293, 324, 366: Replace with logger calls. Error descriptions are `.public`.

**BudgetManager.swift:**
- Lines 185, 208, 212: Replace with logger calls.

**AlertManager.swift:**
- Lines 117, 194, 213, 217, 239, 245, 247, 262, 295, 299, 301: Replace with logger calls.

**SettingsWindowController.swift:**
- Lines 67, 72, 77, 82, 87, 92, 97: Replace with logger calls (these are all error conditions).

**FloatingWindowController.swift:**
- Lines 154, 159, 164: Replace with logger calls.

**JSONLParser.swift:**
- Line 205: Replace with logger call. Skip count is `.public`.

**Do NOT modify files outside Tokemon/Services/ or Tokemon/Services/JSONLParser.swift.** Focus exclusively on the service layer.
  </action>
  <verify>
1. `grep -r 'print(' Tokemon/Services/ | grep -v '//' | grep -v 'test' | wc -l` should return 0 (no remaining print() calls that aren't comments)
2. `grep -rl 'import OSLog' Tokemon/Services/` should list all 10 service files
3. `grep -c 'privacy: .private' Tokemon/Services/AdminAPIClient.swift` should return 2 (the two response body logs)
4. Build with `xcodebuild build -scheme Tokemon -destination 'platform=macOS' 2>&1 | tail -5`
  </verify>
  <done>
All print() calls in Tokemon/Services/ are replaced with OSLog.Logger. HTTP response bodies in AdminAPIClient use `.private` privacy annotation. Each service file has its own logger with appropriate category name.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enforce HTTPS webhook URLs and document sandboxing</name>
  <files>
    Tokemon/Services/WebhookManager.swift
    Tokemon/Tokemon.entitlements
  </files>
  <action>
**WebhookManager.swift:**

1. Add a new case to the `WebhookError` enum:
```swift
case insecureURL
```

2. Add the error description for `insecureURL`:
```swift
case .insecureURL:
    return "Webhook URL must use HTTPS"
```

3. In `postJSON(_:to:)` (static method, around line 368-389), add an HTTPS check immediately after the `URL(string:)` guard:
```swift
private static func postJSON(_ payload: [String: Any], to urlString: String) async throws {
    guard let url = URL(string: urlString) else {
        throw WebhookError.invalidURL
    }
    guard url.scheme == "https" else {
        throw WebhookError.insecureURL
    }
    // ... rest of method unchanged
}
```

This will reject any non-HTTPS URL (http://, ftp://, etc.) with a clear error message. The error propagates to the UI via the existing `testWebhook` error handling path. No UI changes needed -- the `errorDescription` will be displayed by the existing error alert.

**Tokemon.entitlements:**

4. Add XML comments documenting why sandboxing is disabled. Replace the current entitlements content with:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<!--
  Tokemon.entitlements

  App Sandboxing is intentionally DISABLED for the following reasons:

  1. ProfileManager uses Process() to call /usr/bin/security for reading/writing
     Claude Code's Keychain entry during profile copy/switch operations.
     Sandboxed apps cannot execute arbitrary binaries.

  2. Tokemon reads Claude Code's Keychain entry ("Claude Code-credentials")
     which has no shared access group. Sandboxed apps can only access their
     own Keychain items or configured access groups.

  3. JSONLParser reads ~/.claude/projects/ for session data. Sandboxed apps
     require NSOpenPanel + security-scoped bookmarks for arbitrary filesystem access.

  Prerequisites for future sandboxing:
  - Refactor ProfileManager to use KeychainAccess directly (not /usr/bin/security)
  - Implement NSOpenPanel + persistent security-scoped bookmarks for ~/.claude/
  - Coordinate with Claude Code team for Keychain access group support
-->
<plist version="1.0">
<dict>
    <key>com.apple.security.app-sandbox</key>
    <false/>
</dict>
</plist>
```
  </action>
  <verify>
1. `grep "insecureURL" Tokemon/Services/WebhookManager.swift` returns matches (enum case + error description + guard)
2. `grep 'url.scheme == "https"' Tokemon/Services/WebhookManager.swift` returns a match
3. `grep "sandboxing is intentionally DISABLED" Tokemon/Tokemon.entitlements` returns a match
4. Build with `xcodebuild build -scheme Tokemon -destination 'platform=macOS' 2>&1 | tail -5`
  </verify>
  <done>
Webhook URLs are validated for HTTPS before any payload is sent. HTTP URLs throw WebhookError.insecureURL with message "Webhook URL must use HTTPS". Entitlements file documents three specific reasons why sandboxing is disabled and lists prerequisites for future enablement.
  </done>
</task>

</tasks>

<verification>
1. Zero print() calls in service files: `grep -r 'print(' Tokemon/Services/ | grep -v '//' | wc -l` returns 0
2. OSLog in all service files: `grep -rl 'import OSLog' Tokemon/Services/ | wc -l` returns 10
3. AdminAPIClient response bodies use .private: `grep 'privacy: .private' Tokemon/Services/AdminAPIClient.swift`
4. HTTPS enforcement: `grep 'url.scheme == "https"' Tokemon/Services/WebhookManager.swift`
5. Sandboxing documented: `grep -c "sandboxing" Tokemon/Tokemon.entitlements` returns 1+
6. Full build passes: `xcodebuild build -scheme Tokemon -destination 'platform=macOS'`
</verification>

<success_criteria>
- All print() calls in Tokemon/Services/ replaced with OSLog.Logger
- Sensitive data (response bodies, credentials) logged with .private annotation
- Webhook URLs reject non-HTTPS with clear error message
- Entitlements document sandboxing rationale and future prerequisites
- Project builds successfully
</success_criteria>

<output>
After completion, create `.planning/phases/22-security-hardening/22-02-SUMMARY.md`
</output>
