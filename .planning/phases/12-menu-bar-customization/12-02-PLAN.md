---
phase: 12-menu-bar-customization
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - Tokemon/Views/Settings/AppearanceSettings.swift
autonomous: true

must_haves:
  truths:
    - "User can see all 5 icon styles in Settings and select one"
    - "User can toggle monochrome mode in Settings"
    - "Changing icon style in Settings immediately updates the menu bar"
    - "Changing monochrome toggle immediately updates the menu bar"
    - "Selected style persists across app restarts"
  artifacts:
    - path: "Tokemon/Views/Settings/AppearanceSettings.swift"
      provides: "Icon style picker with 5 options, monochrome toggle, live preview"
      contains: "MenuBarIconStyle"
  key_links:
    - from: "Tokemon/Views/Settings/AppearanceSettings.swift"
      to: "Tokemon/TokemonApp.swift"
      via: "NotificationCenter post triggers StatusItemManager re-render"
      pattern: "MenuBarStyleChanged"
    - from: "Tokemon/Views/Settings/AppearanceSettings.swift"
      to: "Tokemon/Models/MenuBarIconStyle.swift"
      via: "Uses enum for picker options"
      pattern: "MenuBarIconStyle\\.allCases"
---

<objective>
Build the Settings UI for menu bar icon customization with live preview.

Purpose: Let users choose between 5 icon styles and toggle monochrome mode through the existing Appearance settings tab, with changes reflected immediately in the menu bar. Completes the user-facing side of MENU-01 and MENU-02.

Output: Updated AppearanceSettings with icon style picker, monochrome toggle, and notification-based wiring.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-menu-bar-customization/12-01-SUMMARY.md
@Tokemon/Views/Settings/AppearanceSettings.swift
@Tokemon/Views/Settings/SettingsView.swift
@Tokemon/TokemonApp.swift
@Tokemon/Models/MenuBarIconStyle.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Overhaul AppearanceSettings with icon style picker and monochrome toggle</name>
  <files>Tokemon/Views/Settings/AppearanceSettings.swift</files>
  <action>
Rewrite the "Menu Bar Display" section of AppearanceSettings.swift to replace the old 3-option placeholder picker:

1. **Remove** the old `IconStyle` enum defined inside AppearanceSettings (it's replaced by the new `MenuBarIconStyle` model from Plan 01).

2. **Replace** the `@AppStorage("menuBarIconStyle")` line to use `MenuBarIconStyle.rawValue` type properly:
   ```swift
   @AppStorage("menuBarIconStyle") private var selectedStyle: String = MenuBarIconStyle.percentage.rawValue
   @AppStorage("menuBarMonochrome") private var isMonochrome: Bool = false
   ```

3. **Icon Style Picker Section** — Replace the old picker with a new "Menu Bar Icon" section:
   - Use `Picker("Icon style", selection: $selectedStyle)` with `.radioGroup` style
   - Iterate over `MenuBarIconStyle.allCases` showing each case's `displayName`
   - Tag each option with its `.rawValue`
   - Below the picker, add a brief description of the selected style:
     - percentage: "Shows usage as a colored percentage (e.g., 42%)"
     - battery: "Battery icon that fills as usage increases"
     - progressBar: "Thin progress bar showing usage level"
     - iconAndBar: "Lightning bolt icon with percentage text"
     - compact: "Minimal number display without % sign"

4. **Monochrome Toggle** — Add a new section below the icon style picker:
   - `Toggle("Monochrome icon", isOn: $isMonochrome)`
   - Description text: "Use a single color that matches the native macOS menu bar style. When off, the icon color shifts from green to orange to red as usage increases."

5. **Live Update Notification** — Add `.onChange(of: selectedStyle)` and `.onChange(of: isMonochrome)` modifiers that post the `Notification.Name("MenuBarStyleChanged")` notification:
   ```swift
   .onChange(of: selectedStyle) { _, _ in
       NotificationCenter.default.post(name: Notification.Name("MenuBarStyleChanged"), object: nil)
   }
   .onChange(of: isMonochrome) { _, _ in
       NotificationCenter.default.post(name: Notification.Name("MenuBarStyleChanged"), object: nil)
   }
   ```
   This triggers StatusItemManager (from Plan 01) to re-read settings and re-render.

6. **Keep the Theme section** exactly as-is (Theme picker with Native/Light/Dark radio group). It should remain the FIRST section in the form. The icon style section goes second, monochrome toggle third.

Layout order:
- Section 1: Theme (existing, unchanged)
- Section 2: Menu Bar Icon (5-style picker with descriptions)
- Section 3: Monochrome (toggle with explanation)

Do NOT add:
- Live preview images in the settings (complex, not required, can be deferred)
- Any Pro gating (menu bar customization is a FREE feature per requirements)
  </action>
  <verify>
Run `swift build` from the project root. Verify:
1. AppearanceSettings compiles without the old IconStyle enum
2. All 5 MenuBarIconStyle cases appear in the picker
3. Monochrome toggle is present
4. onChange modifiers post the MenuBarStyleChanged notification
5. No "coming soon" placeholder text remains
  </verify>
  <done>
AppearanceSettings shows all 5 icon styles with descriptions, monochrome toggle with explanation, and posts notifications on change. The old 3-option placeholder picker and "coming soon" labels are removed. Selecting a style or toggling monochrome immediately updates the menu bar icon via notification.
  </done>
</task>

<task type="auto">
  <name>Task 2: End-to-end build verification and integration test</name>
  <files>Tokemon/TokemonApp.swift, Tokemon/Views/Settings/AppearanceSettings.swift</files>
  <action>
Perform a final integration check across the full rendering pipeline:

1. Run `swift build` and confirm zero errors, zero warnings related to Phase 12 files.

2. Verify the notification wiring is complete:
   - AppearanceSettings posts `Notification.Name("MenuBarStyleChanged")` on style/monochrome change
   - StatusItemManager (in TokemonApp.swift) observes this notification and calls reloadSettings() + update()
   - If the observer is not yet in place from Plan 01, add it now: in StatusItemManager, add an `init()` or a `setupNotificationObserver()` method that registers for "MenuBarStyleChanged" and re-renders.

3. Verify UserDefaults key consistency:
   - AppearanceSettings writes to "menuBarIconStyle" (String) and "menuBarMonochrome" (Bool)
   - StatusItemManager reads from the same keys
   - Default values match: "percentage" for style, false for monochrome

4. Verify backward compatibility:
   - If "menuBarIconStyle" key does not exist in UserDefaults (fresh install), the default is "percentage"
   - The "percentage" style rendering matches the previous behavior (monospaced digit font, GradientColors, license suffix)

5. If any compilation issues are found, fix them. Common issues to watch for:
   - Missing import statements
   - MenuBarIconStyle not visible (ensure it's not fileprivate)
   - NSImage drawing context issues (ensure lockFocus/unlockFocus or use CGContext properly)
   - SF Symbol rendering in NSAttributedString (use NSTextAttachment with NSImage(systemSymbolName:))

6. Clean up any dead code from the old implementation (the old IconStyle enum in AppearanceSettings, any "coming soon" strings).
  </action>
  <verify>
Run `swift build` and confirm zero errors. Run the app briefly (if possible) or verify via `swift build` that all symbol references resolve correctly across the module boundary.
  </verify>
  <done>
Full rendering pipeline verified: settings UI writes to UserDefaults, notification triggers StatusItemManager re-render, renderer produces correct output for all 5 styles with monochrome support. Build passes cleanly. No dead code or placeholder text remains.
  </done>
</task>

</tasks>

<verification>
1. `swift build` passes with zero errors
2. AppearanceSettings shows 5 icon styles with radio picker (no "coming soon" text)
3. Monochrome toggle present with descriptive text
4. Changing style in Settings posts notification that triggers menu bar update
5. All UserDefaults keys consistent between Settings and StatusItemManager
6. Default behavior (percentage style, no monochrome) matches pre-Phase-12 appearance
</verification>

<success_criteria>
- User can choose between 5 icon styles in the Appearance settings tab
- User can toggle monochrome mode on/off
- Style and monochrome preferences persist via UserDefaults across restarts
- Changing either setting immediately updates the menu bar icon (no restart required)
- No "coming soon" placeholder text remains
- Clean compilation with `swift build`
</success_criteria>

<output>
After completion, create `.planning/phases/12-menu-bar-customization/12-02-SUMMARY.md`
</output>
