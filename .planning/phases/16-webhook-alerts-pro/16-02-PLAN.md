---
phase: 16-webhook-alerts-pro
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - Tokemon/Views/Settings/WebhookSettings.swift
  - Tokemon/Views/Settings/SettingsView.swift
  - Tokemon/TokemonApp.swift
  - Tokemon/Services/AlertManager.swift
  - Tokemon/Services/SettingsWindowController.swift
autonomous: true

must_haves:
  truths:
    - "User can configure a Slack webhook URL in Settings and receive threshold alerts in their Slack channel"
    - "User can configure a Discord webhook URL in Settings and receive threshold alerts in their Discord channel"
    - "User can customize the webhook message format (choose fields, adjust template)"
    - "Webhook settings tab is Pro-gated and only visible to Pro users"
    - "User can test their webhook URL from Settings to verify it works"
    - "Webhooks fire at the same threshold as local notifications, once per level per usage window"
  artifacts:
    - path: "Tokemon/Views/Settings/WebhookSettings.swift"
      provides: "Settings tab for configuring Slack/Discord webhook URLs and message template"
      contains: "struct WebhookSettings"
    - path: "Tokemon/Views/Settings/SettingsView.swift"
      provides: "Webhooks tab in Settings TabView"
      contains: "WebhookSettings"
    - path: "Tokemon/TokemonApp.swift"
      provides: "WebhookManager instantiation and wiring to UsageMonitor"
      contains: "webhookManager"
    - path: "Tokemon/Services/AlertManager.swift"
      provides: "Webhook callback invocation after threshold check"
      contains: "onWebhookCheck"
    - path: "Tokemon/Services/SettingsWindowController.swift"
      provides: "WebhookManager environment injection for settings window"
      contains: "webhookManager"
  key_links:
    - from: "Tokemon/TokemonApp.swift"
      to: "Tokemon/Services/AlertManager.swift"
      via: "AlertManager.onWebhookCheck callback wired to WebhookManager.checkUsageAndNotify"
      pattern: "onWebhookCheck"
    - from: "Tokemon/Services/AlertManager.swift"
      to: "Tokemon/Services/WebhookManager.swift"
      via: "Callback passes UsageSnapshot and alertThreshold to WebhookManager"
      pattern: "onWebhookCheck.*usage.*alertThreshold"
    - from: "Tokemon/Views/Settings/WebhookSettings.swift"
      to: "Tokemon/Services/WebhookManager.swift"
      via: "Environment binding for config editing"
      pattern: "Environment.*WebhookManager"
---

<objective>
Build the webhook Settings UI and wire WebhookManager into the alert flow so webhook notifications fire alongside local notifications.

Purpose: Completes the webhook feature end-to-end -- users can configure URLs, customize message format, test their webhooks, and receive alerts in Slack/Discord when usage crosses thresholds.
Output: WebhookSettings view, AlertManager integration, TokemonApp wiring, SettingsWindowController update.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/16-webhook-alerts-pro/16-01-SUMMARY.md
@Tokemon/Views/Settings/SettingsView.swift
@Tokemon/Views/Settings/AlertSettings.swift
@Tokemon/TokemonApp.swift
@Tokemon/Services/AlertManager.swift
@Tokemon/Services/FeatureAccessManager.swift
@Tokemon/Services/SettingsWindowController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: WebhookSettings UI with Pro gate</name>
  <files>Tokemon/Views/Settings/WebhookSettings.swift</files>
  <action>
Create `Tokemon/Views/Settings/WebhookSettings.swift` as a SwiftUI View.

Environment dependencies:
- `@Environment(WebhookManager.self) private var webhookManager`
- `@Environment(FeatureAccessManager.self) private var featureAccess`

State:
- `@State private var testingSlack = false`
- `@State private var testingDiscord = false`
- `@State private var testResult: String?`
- `@State private var showTestResult = false`

Body structure -- wrap everything in Pro gate check:

```swift
if featureAccess.canAccess(.webhookAlerts) {
    // Full settings form
} else {
    // PurchasePromptView-style upgrade prompt for webhookAlerts
}
```

For the full settings form, use `Form { ... }.formStyle(.grouped)` matching the existing AlertSettings pattern:

**Section 1: "Slack"**
- Toggle "Enable Slack alerts" bound to `webhookManager.config.slackEnabled`
- TextField "Webhook URL" bound to `webhookManager.config.slackWebhookURL`, with `.textFieldStyle(.roundedBorder)` and placeholder "https://hooks.slack.com/services/..."
- Only show URL field when slackEnabled is true
- "Test" Button (disabled when URL is empty or testingSlack is true). On tap: set testingSlack=true, call `webhookManager.testWebhook(service: .slack)` in a Task, show result in alert, set testingSlack=false
- Caption text: "Paste your Slack Incoming Webhook URL. Create one at api.slack.com/messaging/webhooks"

**Section 2: "Discord"**
- Toggle "Enable Discord alerts" bound to `webhookManager.config.discordEnabled`
- TextField "Webhook URL" bound to `webhookManager.config.discordWebhookURL`, with placeholder "https://discord.com/api/webhooks/..."
- Only show URL field when discordEnabled is true
- "Test" Button (same pattern as Slack)
- Caption text: "Paste your Discord Webhook URL. Create one in Server Settings > Integrations > Webhooks"

**Section 3: "Message Template"**
- Toggle "Include usage percentage" bound to `webhookManager.config.includePercentage`
- Toggle "Include reset time" bound to `webhookManager.config.includeResetTime`
- Toggle "Include weekly usage" bound to `webhookManager.config.includeWeeklyUsage`
- Toggle "Include profile name" bound to `webhookManager.config.includeProfileName`
- TextField "Custom message" bound to `webhookManager.config.customMessage`, with placeholder "Optional message to include in alerts"
- Caption text: "Choose which fields appear in your webhook messages"

Use `@Bindable var webhookManager = webhookManager` at top of body for two-way binding (same pattern as AlertSettings uses with alertManager).

For the upgrade prompt (non-Pro), show a VStack with:
- SF Symbol "bell.and.waves.left.and.right" in 48pt, secondary color
- "Webhook Alerts" title
- "Send usage alerts to Slack and Discord channels. Requires Tokemon Pro." description
- Button "Upgrade to Pro" calling `featureAccess.openPurchasePage()`

Add `.alert("Webhook Test", isPresented: $showTestResult)` modifier showing testResult string.
  </action>
  <verify>`swift build` succeeds. Grep for `struct WebhookSettings` in the new file.</verify>
  <done>WebhookSettings view exists with Slack/Discord URL configuration, enable toggles, message template customization, test buttons, and Pro gate with upgrade prompt.</done>
</task>

<task type="auto">
  <name>Task 2: AlertManager callback, SettingsView tab, SettingsWindowController, and TokemonApp wiring</name>
  <files>Tokemon/Services/AlertManager.swift, Tokemon/Views/Settings/SettingsView.swift, Tokemon/TokemonApp.swift, Tokemon/Services/SettingsWindowController.swift</files>
  <action>
**AlertManager.swift changes:**

Add a new callback property alongside the existing notification logic:
```swift
/// Callback invoked when webhook should check usage (wired to WebhookManager)
@ObservationIgnored
var onWebhookCheck: ((_ usage: UsageSnapshot, _ alertThreshold: Int) -> Void)?
```

In the `checkUsage(_ usage:)` method, after the existing notification logic (after the `if newLevel == .critical` / `else if newLevel == .warning` block, but before `checkForSessionReset`), add:
```swift
// Forward to webhook manager for Slack/Discord alerts
onWebhookCheck?(usage, alertThreshold)
```

This fires on EVERY check (the WebhookManager handles its own once-per-level deduplication internally). This is intentional -- WebhookManager has its own hasNotifiedWarning/hasNotifiedCritical state separate from AlertManager's, so they track independently.

**SettingsView.swift changes:**

Add the Webhooks tab after the Alerts tab and before Analytics. Always show the tab -- the WebhookSettings view itself handles the Pro gate internally:
```swift
WebhookSettings()
    .tabItem {
        Label("Webhooks", systemImage: "bell.and.waves.left.and.right")
    }
```

**SettingsWindowController.swift changes:**

Follow the exact pattern of existing managers:
1. Add `private var webhookManager: WebhookManager?` property alongside the others
2. Add `func setWebhookManager(_ manager: WebhookManager) { self.webhookManager = manager }` method
3. In `showSettings()`, add a guard for webhookManager (same pattern as other managers)
4. Add `.environment(webhookManager)` to the settingsView builder chain

**TokemonApp.swift changes:**

1. Add WebhookManager as @State alongside other managers:
```swift
@State private var webhookManager = WebhookManager()
```

2. Pass webhookManager as environment to PopoverContentView (in MenuBarExtra content):
```swift
.environment(webhookManager)
```

3. Pass webhookManager as environment to Settings scene:
```swift
.environment(webhookManager)
```

4. In the `menuBarExtraAccess` closure where other managers are wired, add two things:

a. Pass to SettingsWindowController:
```swift
SettingsWindowController.shared.setWebhookManager(webhookManager)
```

b. Wire AlertManager's webhook callback:
```swift
alertManager.onWebhookCheck = { [webhookManager] usage, threshold in
    Task { @MainActor in
        webhookManager.checkUsageAndNotify(usage, alertThreshold: threshold)
    }
}
```

Place these alongside the existing manager wiring (after `monitor.onAlertCheck` wiring is a natural spot for the webhook wiring).
  </action>
  <verify>`swift build` succeeds. Grep for `onWebhookCheck` in AlertManager.swift. Grep for `WebhookSettings` in SettingsView.swift. Grep for `webhookManager` in TokemonApp.swift. Grep for `setWebhookManager` in SettingsWindowController.swift.</verify>
  <done>AlertManager forwards usage checks to WebhookManager via callback. Webhooks tab appears in Settings. WebhookManager is instantiated in TokemonApp and wired into the alert flow via SettingsWindowController. The full pipeline works: UsageMonitor -> AlertManager.checkUsage -> onWebhookCheck -> WebhookManager.checkUsageAndNotify -> HTTP POST to Slack/Discord.</done>
</task>

</tasks>

<verification>
- `swift build` succeeds with no errors
- Webhooks tab appears in Settings window
- Non-Pro users see upgrade prompt in Webhooks tab
- Pro users see Slack/Discord URL fields, enable toggles, message template toggles
- AlertManager.onWebhookCheck callback is wired in TokemonApp
- WebhookManager receives usage checks and can send to configured webhooks
- Test buttons in Settings UI allow verifying webhook URLs
- SettingsWindowController passes WebhookManager as environment
</verification>

<success_criteria>
- User can configure Slack webhook URL in Settings (HOOK-01)
- User can configure Discord webhook URL in Settings (HOOK-02)
- User receives webhook notification when usage crosses threshold (HOOK-03)
- User can customize webhook message format with field toggles and custom message (HOOK-04)
- Feature is Pro-gated with upgrade prompt for free users
- Webhooks fire independently from local notifications (own deduplication state)
- Test webhook functionality verifies URL configuration works
</success_criteria>

<output>
After completion, create `.planning/phases/16-webhook-alerts-pro/16-02-SUMMARY.md`
</output>
