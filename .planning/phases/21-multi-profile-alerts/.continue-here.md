---
phase: 21-multi-profile-alerts
task: 2
total_tasks: 2
status: in_progress
last_updated: 2026-02-23T05:48:00Z
---

<current_state>
Phase 21 Plan 02 Task 1 (auto) is complete — settings.tsx and alert logic in menu-bar.tsx are built and committed. Task 2 is a human-verify checkpoint. The user reported the Raycast menu bar icon wasn't showing a percentage after the 21-01 token resolution changes. A fix was applied (profilesLoading guard in menu-bar.tsx and index.tsx) but NOT yet committed or verified by the user.

Plan 01 is fully complete (2 commits in tokemon-raycast, 1 doc commit in Tokemon).
</current_state>

<completed_work>

- Plan 21-01 Task 1: Add Profile/AlertSettings types to types.ts, create profiles.tsx command (add/switch/delete), add package.json entry — Done (commit 337929c)
- Plan 21-01 Task 2: Update token resolution in index.tsx, menu-bar.tsx, setup.tsx to use active profile with oauthToken fallback — Done (commit ae87bca)
- Plan 21-01 SUMMARY: Created and committed (commit 326c9d2)
- Plan 21-02 Task 1: Create settings.tsx (threshold form + test alert action), add alert logic to menu-bar.tsx (background check, deduplication, try/catch), add package.json entry — Done (commit 26e5484)
- Plan 21-02 Task 2: Human-verify checkpoint — IN PROGRESS (user found menu bar bug)

ADDITIONAL (outside GSD plans, uncommitted in Tokemon repo):
- Added "Traffic Light" menu bar icon style to macOS app (MenuBarIconStyle.swift, MenuBarIconRenderer.swift, AppearanceSettings.swift)
- Fixed settings tab truncation (SettingsView.swift minWidth 720→880)
- Fixed popover flash bug (restored PopoverHeightCalculator in TokemonApp.swift, changed FloatingWindowController makeKeyAndOrderFront→orderFront)
- Replaced tokemon-site og.png with logo on white background
</completed_work>

<remaining_work>

- Commit the menu bar token resolution fix in tokemon-raycast (profilesLoading guard in menu-bar.tsx and index.tsx) — already built and tested but not committed
- User must re-verify the Raycast menu bar shows percentage correctly after the fix
- Complete human-verify checkpoint (Task 2 of Plan 21-02): profiles add/switch/delete, settings save, test alert, background alert
- Create 21-02-SUMMARY.md after checkpoint passes
- Run gsd-verifier on Phase 21
- Update ROADMAP.md to mark Phase 21 complete
- Commit all uncommitted Tokemon macOS app changes (traffic light icon, popover fix, settings width, og image)
</remaining_work>

<decisions_made>

- profilesLoading guard: While useLocalStorage is loading profiles, use oauthToken preference directly to avoid token flickering that breaks useCachedPromise cache key
- Split SettingsCommand into outer loader + inner AlertSettingsForm due to useForm lacking enableReinitialize in installed @raycast/utils version
- lastAlertedWindowId written to LocalStorage BEFORE showToast to prevent race conditions
- Traffic Light icon style: 13px circle + 13pt text to match Raycast menu bar icon size
- FloatingWindowController uses orderFront instead of makeKeyAndOrderFront to avoid stealing focus from popover
- Settings window minWidth increased to 880 to prevent tab truncation
</decisions_made>

<blockers>
- None — just needs human verification of the Raycast menu bar fix and checkpoint completion
</blockers>

<context>
The execute-phase orchestrator spawned 21-01 executor (Wave 1, complete), then 21-02 executor (Wave 2, hit human checkpoint). During the checkpoint verification, user found the Raycast menu bar wasn't showing a percentage. Root cause: useLocalStorage returns undefined initially while async loading, causing token to flicker. Fix applied but needs commit + user verification before the checkpoint can be marked approved.

There are also several uncommitted changes in the Tokemon macOS app repo (traffic light icon style, popover fix, settings width fix) that were done as ad-hoc requests outside the GSD phase workflow.
</context>

<next_action>
1. Commit the profilesLoading fix in tokemon-raycast (menu-bar.tsx + index.tsx)
2. Ask user to verify Raycast menu bar shows percentage
3. Complete the human-verify checkpoint for Plan 21-02
4. Finish execute-phase workflow (SUMMARY, verifier, roadmap update)
5. Commit the uncommitted Tokemon macOS app changes separately
</next_action>
