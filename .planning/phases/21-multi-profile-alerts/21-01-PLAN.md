---
phase: 21-multi-profile-alerts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tokemon-raycast/src/types.ts
  - tokemon-raycast/src/profiles.tsx
  - tokemon-raycast/src/index.tsx
  - tokemon-raycast/src/menu-bar.tsx
  - tokemon-raycast/src/setup.tsx
  - tokemon-raycast/package.json
autonomous: true

must_haves:
  truths:
    - "User can add a new profile with a name and OAuth token"
    - "User can see all profiles in a list with the active profile marked"
    - "User can switch between profiles by selecting one"
    - "User can delete a profile (with active profile reset if needed)"
    - "Dashboard and menu bar use the active profile's token"
    - "Existing single-token users (oauthToken Preference only) continue to work without profiles"
  artifacts:
    - path: "tokemon-raycast/src/types.ts"
      provides: "Profile and AlertSettings interfaces, storage key constants"
      contains: "interface Profile"
    - path: "tokemon-raycast/src/profiles.tsx"
      provides: "Profile management command with List + CRUD"
      min_lines: 80
    - path: "tokemon-raycast/src/index.tsx"
      provides: "Dashboard using active profile token with fallback"
      contains: "activeProfileId"
    - path: "tokemon-raycast/src/menu-bar.tsx"
      provides: "Menu bar using active profile token with fallback"
      contains: "activeProfileId"
    - path: "tokemon-raycast/package.json"
      provides: "profiles command entry"
      contains: "profiles"
  key_links:
    - from: "tokemon-raycast/src/profiles.tsx"
      to: "tokemon-raycast/src/types.ts"
      via: "Profile type import"
      pattern: "import.*Profile.*from.*types"
    - from: "tokemon-raycast/src/profiles.tsx"
      to: "@raycast/utils useLocalStorage"
      via: "useLocalStorage hook for profiles CRUD"
      pattern: "useLocalStorage.*profiles"
    - from: "tokemon-raycast/src/profiles.tsx"
      to: "@raycast/utils useCachedState"
      via: "useCachedState for activeProfileId cross-command sync"
      pattern: "useCachedState.*activeProfileId"
    - from: "tokemon-raycast/src/index.tsx"
      to: "tokemon-raycast/src/types.ts"
      via: "Profile type import for token resolution"
      pattern: "import.*Profile.*from.*types"
    - from: "tokemon-raycast/src/menu-bar.tsx"
      to: "tokemon-raycast/src/types.ts"
      via: "Profile type import for token resolution"
      pattern: "import.*Profile.*from.*types"
---

<objective>
Multi-profile management: users can add, switch, and delete named Claude OAuth profiles. Dashboard and menu bar resolve the active profile's token with backward-compatible fallback to the Preferences oauthToken.

Purpose: Power users with multiple Claude accounts can manage them from a single Raycast extension without re-entering tokens.
Output: profiles.tsx command, updated token resolution in index.tsx and menu-bar.tsx, Profile/AlertSettings types.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-multi-profile-alerts/21-RESEARCH.md
@tokemon-raycast/src/types.ts
@tokemon-raycast/src/api.ts
@tokemon-raycast/src/index.tsx
@tokemon-raycast/src/menu-bar.tsx
@tokemon-raycast/src/setup.tsx
@tokemon-raycast/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add types and create profiles command</name>
  <files>
    tokemon-raycast/src/types.ts
    tokemon-raycast/src/profiles.tsx
    tokemon-raycast/package.json
  </files>
  <action>
**types.ts** — Append (do not modify existing types) at the end of the file:

```typescript
export interface Profile {
  id: string;
  name: string;
  token: string; // Raw OAuth token (already extracted via extractToken at add-time)
}

export interface AlertSettings {
  threshold: number;          // 1-100 integer
  enabled: boolean;
  lastAlertedWindowId: string | null;
}

export const PROFILES_KEY = "profiles";
export const ACTIVE_PROFILE_KEY = "activeProfileId";
export const ALERT_SETTINGS_KEY = "alertSettings";

export const DEFAULT_ALERT_SETTINGS: AlertSettings = {
  threshold: 80,
  enabled: true,
  lastAlertedWindowId: null,
};
```

**profiles.tsx** — Create new file. Implements a `List` command for profile management:

1. Use `useLocalStorage<Profile[]>(PROFILES_KEY, [])` for profiles CRUD.
2. Use `useCachedState<string | null>(ACTIVE_PROFILE_KEY, null)` for active profile cross-command sync.
3. Show a `List` of all profiles. Each `List.Item` shows:
   - `title`: profile name
   - `subtitle`: first 8 chars of token + "..."
   - `accessories`: green checkmark icon if active (`profile.id === activeProfileId`)
4. `ActionPanel` per item:
   - "Switch to Profile" action — `setActiveProfileId(profile.id)`
   - "Delete Profile" action — `Action.Style.Destructive`. Remove from array. If deleted profile was active, reset `activeProfileId` to first remaining profile's id or `null`.
5. Top-level "Add Profile" action (Cmd+N shortcut) that uses `Action.Push` to push an inline `Form`:
   - `Form.TextField` for name (required, non-empty validation)
   - `Form.PasswordField` for token (required, non-empty validation)
   - On submit: call `extractToken()` on the token value before storing. Generate id as `Date.now().toString()`. Append to profiles array via `setProfiles`. Set as active profile. Pop back to list. Show success toast.
6. Empty state: Show `List.EmptyView` with title "No Profiles" and description "Press Cmd+N to add your first profile".
7. Import `extractToken` from `./api`.

**package.json** — Add to the `commands` array (after the "menu-bar" entry):

```json
{
  "name": "profiles",
  "title": "Manage Profiles",
  "subtitle": "tokemon",
  "description": "Add, switch, and delete Claude OAuth profiles",
  "mode": "view"
}
```
  </action>
  <verify>
Run `cd /Users/richardparr/tokemon-raycast && npm run build` — must succeed with no TypeScript errors. Run `npm test` — all existing tests must still pass.
  </verify>
  <done>
types.ts has Profile, AlertSettings, and storage key exports. profiles.tsx renders a List with add/switch/delete actions. package.json has the profiles command entry. Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update token resolution in dashboard, menu bar, and setup</name>
  <files>
    tokemon-raycast/src/index.tsx
    tokemon-raycast/src/menu-bar.tsx
    tokemon-raycast/src/setup.tsx
  </files>
  <action>
All three commands need to resolve the active profile's token with backward-compatible fallback to the `oauthToken` Preference. Apply the same pattern to each:

**Token resolution pattern (add to each command):**

```typescript
import { useCachedState } from "@raycast/utils";
import { useLocalStorage } from "@raycast/utils";
import type { Profile } from "./types";
import { PROFILES_KEY, ACTIVE_PROFILE_KEY } from "./types";

// Inside the component function, BEFORE any early returns, add these hooks:
const [activeProfileId] = useCachedState<string | null>(ACTIVE_PROFILE_KEY, null);
const { value: profiles } = useLocalStorage<Profile[]>(PROFILES_KEY, []);

// Resolve token: active profile > preference fallback
const activeProfile = profiles?.find((p) => p.id === activeProfileId);
const token = extractToken(activeProfile?.token ?? oauthToken);
```

**index.tsx changes:**
- Add the imports and hooks above (after existing hooks, before early returns).
- Replace the existing `const token = extractToken(oauthToken);` line with the resolution pattern.
- Keep `const { oauthToken } = getPreferenceValues<Preferences>();` as fallback source.
- All existing hooks must remain unconditional and before early returns.

**menu-bar.tsx changes:**
- Same pattern. Add imports, hooks inside `MenuBarCommand()`.
- Replace `const token = extractToken(oauthToken);` with the resolution pattern.
- Keep `getPreferenceValues` for fallback.

**setup.tsx changes:**
- Add imports for `useCachedState`, `useLocalStorage`, `Profile`, key constants.
- Add hooks inside `SetupCommand()`.
- Change `isConfigured` to check: `extractToken(activeProfile?.token ?? oauthToken).length > 0`. This way, if a profile is active, setup shows "already configured"; if no profile and no preference token, shows the setup guide.
- Keep existing UI/markdown unchanged — only the token detection logic changes.

**Critical:** Ensure all new hooks are called unconditionally before any early returns (React rules of hooks). The order should be:
1. `getPreferenceValues` (not a hook, safe anywhere)
2. `useCachedState` (hook)
3. `useLocalStorage` (hook)
4. Existing hooks (useCachedPromise, useState, useEffect)
5. Early returns
  </action>
  <verify>
Run `cd /Users/richardparr/tokemon-raycast && npm run build` — must succeed. Run `npm test` — all existing tests pass. Verify that each modified file imports Profile and uses the activeProfileId pattern by searching for "activeProfileId" in each file.
  </verify>
  <done>
index.tsx, menu-bar.tsx, and setup.tsx all resolve tokens via active profile first, falling back to oauthToken Preference. Existing single-token users see no change in behavior. Build passes.
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds in tokemon-raycast/
- `npm test` passes all existing tests
- types.ts exports Profile, AlertSettings, PROFILES_KEY, ACTIVE_PROFILE_KEY, ALERT_SETTINGS_KEY
- profiles.tsx exists with List, add/switch/delete actions
- index.tsx contains activeProfileId resolution
- menu-bar.tsx contains activeProfileId resolution
- setup.tsx contains activeProfileId resolution
- package.json has "profiles" command entry
</verification>

<success_criteria>
Profile management command is buildable and registered. All existing commands resolve tokens through the active profile system with backward-compatible fallback. No regressions in existing tests or build.
</success_criteria>

<output>
After completion, create `.planning/phases/21-multi-profile-alerts/21-01-SUMMARY.md`
</output>
