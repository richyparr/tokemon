---
phase: 21-multi-profile-alerts
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - tokemon-raycast/src/settings.tsx
  - tokemon-raycast/src/menu-bar.tsx
  - tokemon-raycast/package.json
autonomous: false

must_haves:
  truths:
    - "User can configure a usage threshold percentage (1-100) in settings"
    - "User can enable/disable alerts in settings"
    - "User receives a toast/HUD notification when usage crosses threshold in background"
    - "Alert fires only once per 5-hour window (not every refresh)"
    - "User can test the alert from the settings command"
  artifacts:
    - path: "tokemon-raycast/src/settings.tsx"
      provides: "Settings Form with threshold config and test alert action"
      min_lines: 60
    - path: "tokemon-raycast/src/menu-bar.tsx"
      provides: "Background alert logic triggered on threshold crossing"
      contains: "alertSettings"
    - path: "tokemon-raycast/package.json"
      provides: "settings command entry"
      contains: "settings"
  key_links:
    - from: "tokemon-raycast/src/settings.tsx"
      to: "tokemon-raycast/src/types.ts"
      via: "AlertSettings type and key imports"
      pattern: "import.*AlertSettings.*from.*types"
    - from: "tokemon-raycast/src/settings.tsx"
      to: "@raycast/api LocalStorage"
      via: "Save settings to LocalStorage"
      pattern: "LocalStorage\\.setItem"
    - from: "tokemon-raycast/src/menu-bar.tsx"
      to: "@raycast/api LocalStorage"
      via: "Read alertSettings in background refresh"
      pattern: "LocalStorage\\.getItem.*alertSettings"
    - from: "tokemon-raycast/src/menu-bar.tsx"
      to: "@raycast/api showToast"
      via: "Show HUD notification on threshold crossing"
      pattern: "showToast.*usage alert"
---

<objective>
Threshold alerts: users configure a usage percentage threshold in a settings command. The menu bar background refresh checks utilization against threshold and shows a toast/HUD notification when crossed, once per 5-hour window. A test alert action verifies delivery.

Purpose: Users get proactively notified before hitting Claude usage limits instead of discovering limits mid-conversation.
Output: settings.tsx command, alert logic in menu-bar.tsx, human-verified end-to-end.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-multi-profile-alerts/21-RESEARCH.md
@.planning/phases/21-multi-profile-alerts/21-01-SUMMARY.md
@tokemon-raycast/src/types.ts
@tokemon-raycast/src/menu-bar.tsx
@tokemon-raycast/src/settings.tsx
@tokemon-raycast/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings command and add alert logic to menu bar</name>
  <files>
    tokemon-raycast/src/settings.tsx
    tokemon-raycast/src/menu-bar.tsx
    tokemon-raycast/package.json
  </files>
  <action>
**settings.tsx** — Create new file. Implements a `Form` command for alert configuration:

1. Import `Form`, `ActionPanel`, `Action`, `Icon`, `showToast`, `Toast`, `LocalStorage` from `@raycast/api`.
2. Import `useForm` from `@raycast/utils`.
3. Import `AlertSettings`, `ALERT_SETTINGS_KEY`, `DEFAULT_ALERT_SETTINGS` from `./types`.
4. On mount, load existing settings from `LocalStorage.getItem<string>(ALERT_SETTINGS_KEY)` via a `useEffect` + `useState` pattern. Parse with try/catch, falling back to `DEFAULT_ALERT_SETTINGS`.
5. Use `useForm` with:
   - Form values type: `{ threshold: string; enabled: boolean }`
   - `initialValues`: set from loaded settings (convert threshold number to string). Use a loading state to avoid rendering the form before settings load.
   - `validation.threshold`: parse as int, reject if NaN or outside 1-100 range.
   - `onSubmit`: serialize `AlertSettings` to JSON, call `LocalStorage.setItem(ALERT_SETTINGS_KEY, ...)`. Set `lastAlertedWindowId` to `null` when threshold changes (so alert re-fires with new threshold). Show success toast "Settings saved".
6. Render `Form`:
   - `Form.TextField` for threshold (title "Alert Threshold (%)", placeholder "e.g. 80")
   - `Form.Checkbox` for enabled (label "Enable Alerts")
   - `Form.Description` explaining: "You'll receive a notification when your 5-hour session usage crosses this threshold. Alerts fire once per session window."
7. ActionPanel:
   - `Action.SubmitForm` title "Save Settings" as primary action
   - `Action` title "Test Alert" with `Icon.Bell` — calls `showToast({ style: Toast.Style.Failure, title: "Claude usage alert (test)", message: "This is what your alert will look like" })`

**menu-bar.tsx** — Add threshold alert checking after data loads:

1. Add imports: `LocalStorage`, `environment`, `LaunchType`, `showToast`, `Toast` from `@raycast/api`. (Some may already be imported — only add missing ones.)
2. Import `AlertSettings`, `ALERT_SETTINGS_KEY`, `DEFAULT_ALERT_SETTINGS` from `./types`.
3. Create a helper function outside the component:
```typescript
function parseAlertSettings(raw: string | undefined): AlertSettings {
  try {
    return raw ? JSON.parse(raw) : DEFAULT_ALERT_SETTINGS;
  } catch {
    return DEFAULT_ALERT_SETTINGS;
  }
}
```
4. Add a `useEffect` that depends on `[data]`. Inside:
   - Guard: if `!data` return early.
   - Guard: if `environment.launchType !== LaunchType.Background` return early. (Only check alerts on background refresh, not user-initiated opens.)
   - Define an async `checkAlert` function:
     a. Read `raw` from `await LocalStorage.getItem<string>(ALERT_SETTINGS_KEY)`.
     b. Parse via `parseAlertSettings(raw)`.
     c. If `!settings.enabled`, return.
     d. Get `utilization` from `data.five_hour?.utilization ?? 0`.
     e. Get `windowId` from `data.five_hour?.resets_at ?? "unknown"`.
     f. If `utilization >= settings.threshold && settings.lastAlertedWindowId !== windowId`:
        - Update `lastAlertedWindowId` in LocalStorage FIRST (prevent race).
        - Try `showToast({ style: Toast.Style.Failure, title: "Claude usage alert", message: "Session at ${Math.round(utilization)}% — threshold: ${settings.threshold}%" })`. Wrap in try/catch — swallow errors silently.
   - Call `checkAlert().catch(() => {})` — never let alert logic crash the menu bar.

**package.json** — Add to the `commands` array (after the "profiles" entry added in Plan 01):

```json
{
  "name": "settings",
  "title": "Settings",
  "subtitle": "tokemon",
  "description": "Configure usage alerts and extension settings",
  "mode": "view"
}
```
  </action>
  <verify>
Run `cd /Users/richardparr/tokemon-raycast && npm run build` — must succeed. Run `npm test` — all existing tests pass. Verify settings.tsx exists and contains `useForm`, `showToast`, and `Test Alert`. Verify menu-bar.tsx contains `alertSettings` and `LaunchType.Background`.
  </verify>
  <done>
settings.tsx renders a Form with threshold input, enable checkbox, save action, and test alert action. menu-bar.tsx checks threshold in background refresh and fires a deduped alert. package.json has the settings command entry. Build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify profiles and alerts in Raycast</name>
  <what-built>
Complete multi-profile management (add/switch/delete profiles) and threshold alert system (settings form, background alert, test alert). Two new commands: "Manage Profiles" and "Settings".
  </what-built>
  <how-to-verify>
1. Open Raycast and search for "Manage Profiles"
2. Press Cmd+N to add a new profile — enter a name and your OAuth token. Verify it appears in the list with a green checkmark (active).
3. Add a second profile with a different name (can reuse same token for testing). Verify both appear in the list.
4. Select the second profile — verify the checkmark moves to it.
5. Open the Dashboard command — verify it still shows usage data (using the active profile's token).
6. Check the menu bar — verify it still shows usage percentage.
7. Go back to "Manage Profiles" and delete the second profile. Verify the first profile becomes active.
8. Search for "Settings" in Raycast.
9. Set threshold to a value BELOW your current usage (e.g., 10%) and save. Verify "Settings saved" toast appears.
10. Press the "Test Alert" action — verify a red toast/HUD appears saying "Claude usage alert (test)".
11. Wait for a menu bar background refresh (up to 5 minutes) OR restart the extension to trigger a refresh. The alert should fire since your usage exceeds the threshold.
12. After the alert fires, verify it does NOT fire again on the next refresh (deduplication by window ID).
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` succeeds in tokemon-raycast/
- `npm test` passes all existing tests
- settings.tsx exists with Form, useForm, threshold validation, test alert action
- menu-bar.tsx has background alert logic with LaunchType.Background guard and lastAlertedWindowId deduplication
- package.json has "settings" command entry
- Human verifies: profiles add/switch/delete, dashboard uses active profile, settings save, test alert fires, background alert fires once
</verification>

<success_criteria>
Settings command allows threshold configuration (ALRT-01). Menu bar fires a deduped toast/HUD when threshold is crossed in background (ALRT-02). Test alert action works (ALRT-03). All six requirements (PROF-01 through ALRT-03) verified by human in Raycast.
</success_criteria>

<output>
After completion, create `.planning/phases/21-multi-profile-alerts/21-02-SUMMARY.md`
</output>
