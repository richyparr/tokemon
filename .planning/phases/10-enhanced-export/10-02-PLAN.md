---
phase: 10-enhanced-export
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - Tokemon/Views/Analytics/ExportDialogView.swift
  - Tokemon/Views/Analytics/AnalyticsDashboardView.swift
autonomous: true

must_haves:
  truths:
    - "User sees a two-step export dialog: Step 1 selects source, Step 2 selects date range"
    - "Local-only users see Step 1 without the Organization option"
    - "User can pick from preset periods: 7d, 30d, 90d, 1 Year, All Time, Custom"
    - "Custom date range shows two calendar date pickers for start and end"
    - "Default selection is 30 days with no memory of last choice"
    - "Large export warning appears for 90+ day Organization exports"
    - "Export buttons in dashboard open the new dialog instead of the old source picker"
  artifacts:
    - path: "Tokemon/Views/Analytics/ExportDialogView.swift"
      provides: "Two-step export sheet with source and date range selection"
      contains: "enum Step"
    - path: "Tokemon/Views/Analytics/AnalyticsDashboardView.swift"
      provides: "Wiring from export buttons to ExportDialogView, config-driven export execution"
      contains: "ExportDialogView"
  key_links:
    - from: "Tokemon/Views/Analytics/ExportDialogView.swift"
      to: "Tokemon/Models/ExportConfig.swift"
      via: "Dialog builds ExportConfig from user selections and returns via completion"
      pattern: "ExportConfig"
    - from: "Tokemon/Views/Analytics/AnalyticsDashboardView.swift"
      to: "Tokemon/Views/Analytics/ExportDialogView.swift"
      via: ".sheet presentation with ExportDialogView"
      pattern: "sheet.*ExportDialogView"
---

<objective>
Build the two-step export dialog UI and wire it into the analytics dashboard, replacing the current single-step source picker.

Purpose: The export dialog is the primary user-facing change in this phase. It transforms the export flow from "pick source, immediately export 30d" to "pick source, pick date range, then export" -- giving users control over what period they export.

Output: New ExportDialogView.swift, updated AnalyticsDashboardView.swift with dialog integration and config-driven exports.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-enhanced-export/10-RESEARCH.md
@.planning/phases/10-enhanced-export/10-01-SUMMARY.md
@Tokemon/Views/Analytics/AnalyticsDashboardView.swift
@Tokemon/Models/ExportConfig.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExportDialogView with two-step sheet flow</name>
  <files>Tokemon/Views/Analytics/ExportDialogView.swift</files>
  <action>
Create `Tokemon/Views/Analytics/ExportDialogView.swift` implementing a two-step modal sheet:

**State machine:**
```swift
enum Step {
    case selectSource
    case selectDateRange
}
```
`@State private var step: Step = .selectSource`

**Properties:**
- `let format: ExportFormat` — which export type was requested (PDF, CSV, card)
- `let onExport: (ExportConfig) -> Void` — completion callback with the built config
- `let onCancel: () -> Void` — dismissal callback
- `@State private var selectedSource: ExportSource = .local`
- `@State private var selectedPreset: DatePreset = .thirtyDays` (default per locked decision)
- `@State private var customStartDate: Date` (default: 1 month ago)
- `@State private var customEndDate: Date` (default: today)

**Step 1: Source Selection**
- Title: "Export {format}" (e.g., "Export PDF Report")
- Show source options as selectable rows (matching current source picker style). Each row shows icon, name, description.
- Only show `.organization` option if `AdminAPIClient.shared.hasAdminKey()` is true.
- If Admin API is NOT connected, skip Step 1 entirely -- set source to `.local` and go directly to Step 2. Per locked decision: "Same dialog experience for local-only users (just without Admin API source option)."
- "Next" button at bottom to advance to Step 2. "Cancel" button to dismiss.

**Step 2: Date Range Selection**
- Title: "Select Date Range"
- Back button (chevron.left) to return to Step 1 (or hidden if Step 1 was skipped)
- Show preset buttons in a 2x3 grid or VStack: 7 Days, 30 Days, 90 Days, 1 Year, All Time, Custom. Use a segmented-like selection where the active preset is highlighted.
- When "Custom" is selected, reveal two DatePicker controls:
  - Use `.compact` style DatePickers (per research: more space-efficient for a dialog). Each in a labeled VStack ("Start Date", "End Date").
  - Constrain start <= end and end <= today.
- When a non-custom preset is selected, show the computed date range as text below the selection (e.g., "Jan 17, 2026 - Feb 16, 2026").
- **Large export warning:** If `isLargeExport` would be true (source is .organization AND date range > 90 days), show an informational note: "This export covers {N} days of data and may take a moment to fetch."
- "Export" button at bottom. On tap, build an `ExportConfig` from selections and call `onExport`. "Cancel" button to dismiss.

**Layout:**
- Frame width: ~400 points (enough for date pickers but not overly wide)
- Padding: 20pt around content
- Transition between steps with a simple conditional (no animation needed per discretion)

Do NOT use @Environment for FeatureAccessManager or other services. The dialog receives everything it needs via parameters.
  </action>
  <verify>Build with `swift build`. ExportDialogView.swift compiles. Verify it contains Step enum, source selection step, date range step with preset buttons, custom date pickers, large export warning condition, and onExport callback.</verify>
  <done>ExportDialogView exists with two-step flow. Step 1 shows source selection (skipped for local-only users). Step 2 shows date preset selection with custom range pickers. Default is 30 days. Large export warning shown for 90+ day org exports. Builds cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Wire ExportDialogView into AnalyticsDashboardView and implement config-driven exports</name>
  <files>Tokemon/Views/Analytics/AnalyticsDashboardView.swift</files>
  <action>
Update `Tokemon/Views/Analytics/AnalyticsDashboardView.swift`:

1. **Remove the inline `ExportSource` enum** — it's now in ExportConfig.swift as `ExportSource`.

2. **Replace the `exportSourcePicker` view** with the new `ExportDialogView`. Change the sheet presentation:
   - Replace `showingExportSourcePicker` with `showingExportDialog` (Bool state).
   - Remove `pendingExportAction` state. Instead, add `@State private var pendingExportFormat: ExportFormat?`.
   - The sheet presents `ExportDialogView(format:onExport:onCancel:)`.
   - `onExport` receives the `ExportConfig` and calls a new `performConfiguredExport(_ config:)` method.
   - `onCancel` dismisses the sheet.

3. **Update export button behavior:**
   - When user taps an export button (PDF, CSV, or Share Card):
     - Set `pendingExportFormat` to the corresponding ExportFormat
     - Set `showingExportDialog = true`
   - This replaces the current logic that checks `hasAdminKey()` to decide whether to show source picker or export directly. The dialog now handles this internally (skips Step 1 for local-only users).

4. **Create `performConfiguredExport(_ config: ExportConfig)` method** that replaces the old `performExport(action:source:)`:
   - For `.pdf`: Call the paginated fetch (from Plan 01) with config.dateRange, then pass data to PDFReportView (existing for now, Plan 03 will enhance it), then ExportManager.exportPDF. Use `config.suggestedFilename` for the filename.
   - For `.csv`: Call the paginated fetch with config.dateRange, then generate CSV. Use `config.suggestedFilename`.
   - For `.card`: Keep existing card copy logic but use config.dateRange for the time period.
   - For `.organization` source, use `AdminAPIClient.shared.fetchAllUsageData` (paginated) and `fetchAllCostData` (paginated) instead of the old non-paginated `fetchUsageReport`/`fetchCostReport`.
   - For `.local` source, filter `monitor.usageHistory` to the config's date range.

5. **Remove old methods:** `performPDFExport(source:)`, `performCSVExport(source:)`, `performCardCopy(source:)`, and `performExport(action:source:)`. Replace with the single `performConfiguredExport`.

6. **Remove the old `exportSourcePicker` computed property** entirely.

Keep the `ExportAction` enum only if still needed, or remove if fully replaced by ExportFormat.
  </action>
  <verify>Build with `swift build`. AnalyticsDashboardView compiles. Verify: no reference to old ExportSource enum (now from ExportConfig.swift), sheet presents ExportDialogView, performConfiguredExport handles all three formats with config-driven date ranges, paginated fetch used for organization source.</verify>
  <done>AnalyticsDashboardView uses ExportDialogView for all exports. Old source picker and hardcoded date ranges removed. Export flow: button tap -> dialog -> config -> paginated fetch -> export. All three formats (PDF, CSV, card) work with user-selected date ranges. Builds cleanly.</done>
</task>

</tasks>

<verification>
- `swift build` succeeds with no errors
- ExportDialogView.swift exists with two-step state machine
- AnalyticsDashboardView.swift presents ExportDialogView as a sheet
- Old `exportSourcePicker` and inline `ExportSource` enum removed
- Export buttons open the dialog for all cases (including local-only)
- Config-driven export uses paginated fetch methods from Plan 01
- No hardcoded date ranges remain in export code paths
</verification>

<success_criteria>
- Two-step export dialog works: source selection then date range selection
- Local-only users skip source step, go straight to date range
- All 6 preset periods available (7d, 30d, 90d, 1y, All Time, Custom)
- Custom range shows two DatePickers with proper constraints
- Default is 30 days, no persistence of last selection
- Large export warning for 90+ day organization exports
- All export paths use the new config-driven flow
</success_criteria>

<output>
After completion, create `.planning/phases/10-enhanced-export/10-02-SUMMARY.md`
</output>
