---
phase: 10-enhanced-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Tokemon/Models/ExportConfig.swift
  - Tokemon/Services/AdminAPIClient.swift
  - Tokemon/Models/AdminUsageResponse.swift
autonomous: true

must_haves:
  truths:
    - "Export configuration model captures source, date range, and format choices"
    - "Admin API fetches all data for date ranges exceeding 31 days via pagination"
    - "Cost amounts are correctly converted from cents to dollars"
    - "Cache creation tokens are accessible as a separate field on usage buckets"
  artifacts:
    - path: "Tokemon/Models/ExportConfig.swift"
      provides: "ExportConfig, ExportSource, DatePreset, ReportGranularity types"
      contains: "enum DatePreset"
    - path: "Tokemon/Services/AdminAPIClient.swift"
      provides: "Paginated fetch methods for usage and cost reports"
      contains: "fetchAllUsageData"
    - path: "Tokemon/Models/AdminUsageResponse.swift"
      provides: "cacheCreationTokens computed property on UsageBucket, cents-to-dollars fix on AdminCostResponse"
      contains: "cacheCreationTokens"
  key_links:
    - from: "Tokemon/Models/ExportConfig.swift"
      to: "Tokemon/Services/AdminAPIClient.swift"
      via: "DatePreset.dateRange() produces Date pairs consumed by fetchAllUsageData"
      pattern: "dateRange.*start.*end"
    - from: "Tokemon/Services/AdminAPIClient.swift"
      to: "Tokemon/Models/AdminUsageResponse.swift"
      via: "Paginated fetch aggregates multiple AdminUsageResponse pages"
      pattern: "hasMore.*nextPage"
---

<objective>
Create the export configuration model, implement Admin API pagination for large date ranges, fix the cost cents-to-dollars bug, and add cache creation token access to usage buckets.

Purpose: These are the foundational data types and API capabilities that Plans 02 (dialog UI) and 03 (export output) both depend on. Without pagination, "90 Days", "1 Year", and "All Time" exports would silently truncate data at 31 days.

Output: ExportConfig.swift (new), enhanced AdminAPIClient.swift with pagination, fixed AdminUsageResponse.swift with cache creation tokens and correct cost conversion.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-enhanced-export/10-RESEARCH.md
@Tokemon/Models/AdminUsageResponse.swift
@Tokemon/Services/AdminAPIClient.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExportConfig model with DatePreset and ReportGranularity</name>
  <files>Tokemon/Models/ExportConfig.swift</files>
  <action>
Create a new file `Tokemon/Models/ExportConfig.swift` containing:

1. **`enum ExportSource: String, CaseIterable`** with cases `.local` ("This Machine") and `.organization` ("Organization"). Include `icon` (String) and `description` (String) computed properties matching the current values in AnalyticsDashboardView.ExportSource. This replaces the inline enum in AnalyticsDashboardView.

2. **`enum DatePreset: String, CaseIterable`** with cases: `.sevenDays` ("7 Days"), `.thirtyDays` ("30 Days"), `.ninetyDays` ("90 Days"), `.oneYear` ("1 Year"), `.allTime` ("All Time"), `.custom` ("Custom"). Include a `func dateRange(customStart: Date? = nil, customEnd: Date? = nil) -> (start: Date, end: Date)` method that computes actual Date ranges. For `.allTime`, use January 1, 2023 as start (API won't have data before Anthropic launched). For `.custom`, return the provided custom dates.

3. **`enum ReportGranularity`** with cases `.daily`, `.weekly`, `.monthly`. Include `static func from(days: Int) -> ReportGranularity` that returns `.daily` for < 30, `.weekly` for 30-90, `.monthly` for > 90. Per user's locked decision.

4. **`enum ExportFormat`** with cases `.pdf`, `.csv`, `.card`.

5. **`struct ExportConfig`** with properties: `source: ExportSource`, `datePreset: DatePreset`, `format: ExportFormat`, `customStartDate: Date?`, `customEndDate: Date?`. Include computed properties:
   - `var dateRange: (start: Date, end: Date)` — delegates to datePreset.dateRange with custom dates
   - `var granularity: ReportGranularity` — computed from the number of days in dateRange
   - `var suggestedFilename: String` — generates `tokemon-{type}-{period}.{ext}` per locked decision. Use `yyyy-MM` formatted dates for the period portion (e.g., "tokemon-usage-2026-01-to-2026-02.csv"). Type is "usage" for CSV, "report" for PDF.
   - `var isLargeExport: Bool` — true when date range exceeds 90 days AND source is .organization (per research recommendation)

All types should be `Sendable`.
  </action>
  <verify>Build the project with `swift build` from the repo root. ExportConfig.swift compiles without errors. Verify DatePreset.sevenDays.dateRange() returns a range spanning ~7 days. Verify ReportGranularity.from(days: 15) == .daily, .from(days: 60) == .weekly, .from(days: 120) == .monthly.</verify>
  <done>ExportConfig.swift exists with ExportSource, DatePreset, ReportGranularity, ExportFormat, and ExportConfig types. All compile cleanly. DatePreset computes correct date ranges. ReportGranularity thresholds match locked decisions (daily < 30d, weekly 30-90d, monthly > 90d).</done>
</task>

<task type="auto">
  <name>Task 2: Add paginated fetch to AdminAPIClient and fix cost/token bugs</name>
  <files>Tokemon/Services/AdminAPIClient.swift, Tokemon/Models/AdminUsageResponse.swift</files>
  <action>
**In AdminAPIClient.swift:**

1. Add a `page` parameter (optional String) to the existing `fetchUsageReport` method's URL query items. When `page` is non-nil, add `URLQueryItem(name: "next_page", value: page)` to the query. Also add `limit` query parameter set to `"31"` (the max for daily buckets) to be explicit.

2. Create a new paginated wrapper method:
```swift
func fetchAllUsageData(
    startingAt: Date,
    endingAt: Date,
    bucketWidth: String = "1d"
) async throws -> AdminUsageResponse
```
This method loops: calls `fetchUsageReport` with the page token, collects all `data` buckets, continues while `hasMore` is true with the `nextPage` token. Returns a single `AdminUsageResponse` with all collected buckets and `hasMore: false`.

3. Similarly, add a `page` parameter to `fetchCostReport` and create:
```swift
func fetchAllCostData(
    startingAt: Date,
    endingAt: Date,
    bucketWidth: String = "1d"
) async throws -> AdminCostResponse
```
Same pagination pattern.

Both paginated methods should handle the case where `nextPage` is nil but `hasMore` is true (treat as done -- defensive).

**In AdminUsageResponse.swift:**

4. Add a `cacheCreationTokens` computed property to `UsageBucket`:
```swift
var cacheCreationTokens: Int {
    results.reduce(0) { $0 + $1.cacheCreationTokens }
}
```
(This already exists on UsageResult but not on UsageBucket.)

5. Add `totalCacheCreationTokens` to `AdminUsageResponse`:
```swift
var totalCacheCreationTokens: Int {
    data.reduce(0) { $0 + $1.cacheCreationTokens }
}
```

6. **Fix the cents-to-dollars bug** in `AdminCostResponse.CostBucket.totalCost`:
Change from `results.reduce(0) { $0 + (Double($1.amount) ?? 0) }` to `results.reduce(0) { $0 + ((Double($1.amount) ?? 0) / 100.0) }`. The API returns amounts in cents (lowest currency unit per official docs). This also fixes the aggregate `AdminCostResponse.totalCost` since it sums bucket totals.

Also add `totalCost` computed property to individual `CostBucket` for per-day cost in CSV export (it already exists but needs the /100 fix).

NOTE: This cost fix will also correct the existing OrgUsageView cost display, which is a pre-existing bug.
  </action>
  <verify>Build the project with `swift build`. Verify no compilation errors. Inspect the paginated fetch methods to confirm they loop on hasMore/nextPage. Verify the cost division by 100 is in place. Verify UsageBucket.cacheCreationTokens and AdminUsageResponse.totalCacheCreationTokens exist.</verify>
  <done>AdminAPIClient has `fetchAllUsageData` and `fetchAllCostData` paginated methods. AdminUsageResponse.UsageBucket has `cacheCreationTokens`. AdminUsageResponse has `totalCacheCreationTokens`. AdminCostResponse cost amounts are divided by 100 (cents to dollars). Project compiles cleanly.</done>
</task>

</tasks>

<verification>
- `swift build` succeeds with no errors
- ExportConfig.swift contains all 5 types (ExportSource, DatePreset, ReportGranularity, ExportFormat, ExportConfig)
- AdminAPIClient.swift contains `fetchAllUsageData` and `fetchAllCostData` with pagination loops
- AdminUsageResponse.swift has `cacheCreationTokens` on UsageBucket and `totalCacheCreationTokens` on the response
- AdminCostResponse cost amounts divide by 100
- No regressions in existing code (OrgUsageView, UsageSummaryView still compile)
</verification>

<success_criteria>
- ExportConfig model captures all user-decided date presets (7d, 30d, 90d, 1y, All Time, Custom)
- Paginated fetch handles date ranges of any length without truncating data
- Cost bug fixed (amounts now in dollars, not cents)
- Cache creation tokens accessible at bucket and response level
- All types are Sendable for actor isolation compatibility
</success_criteria>

<output>
After completion, create `.planning/phases/10-enhanced-export/10-01-SUMMARY.md`
</output>
