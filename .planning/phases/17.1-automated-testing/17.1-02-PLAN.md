---
phase: 17.1-automated-testing
plan: 02
type: execute
wave: 2
depends_on: ["17.1-01"]
files_modified:
  - Tokemon/Utilities/PopoverHeightCalculator.swift
  - TokemonTests/PopoverHeightTests.swift
  - TokemonTests/Snapshots/UsageHeaderSnapshotTests.swift
  - TokemonTests/Snapshots/UsageDetailSnapshotTests.swift
  - TokemonTests/Snapshots/FloatingWindowSnapshotTests.swift
  - Tokemon/TokemonApp.swift
autonomous: true

must_haves:
  truths:
    - "Popover height calculation is unit-testable without SwiftUI state"
    - "Popover height returns correct values for all state combinations (single/multi profile, chart on/off, update banner, extra usage)"
    - "UsageHeaderView renders correctly at empty, low (25%), medium (60%), high (80%), and critical (95%) states"
    - "UsageDetailView renders correctly for OAuth and JSONL data sources"
    - "FloatingWindowView renders correctly at multiple usage levels"
    - "Snapshot reference images are generated and committed for all test cases"
  artifacts:
    - path: "Tokemon/Utilities/PopoverHeightCalculator.swift"
      provides: "Pure function for popover height calculation extracted from TokemonApp"
      min_lines: 20
    - path: "TokemonTests/PopoverHeightTests.swift"
      provides: "Unit tests for every popover height calculation branch"
      min_lines: 60
    - path: "TokemonTests/Snapshots/UsageHeaderSnapshotTests.swift"
      provides: "Snapshot tests for UsageHeaderView across states and themes"
      min_lines: 50
    - path: "TokemonTests/Snapshots/UsageDetailSnapshotTests.swift"
      provides: "Snapshot tests for UsageDetailView OAuth and JSONL states"
      min_lines: 40
    - path: "TokemonTests/Snapshots/FloatingWindowSnapshotTests.swift"
      provides: "Snapshot tests for FloatingWindowView at different usage levels"
      min_lines: 40
  key_links:
    - from: "Tokemon/TokemonApp.swift"
      to: "Tokemon/Utilities/PopoverHeightCalculator.swift"
      via: "delegates height calculation to pure function"
      pattern: "PopoverHeightCalculator\\.calculate|calculatePopoverHeight"
    - from: "TokemonTests/PopoverHeightTests.swift"
      to: "Tokemon/Utilities/PopoverHeightCalculator.swift"
      via: "@testable import tokemon"
      pattern: "PopoverHeightCalculator"
    - from: "TokemonTests/Snapshots/UsageHeaderSnapshotTests.swift"
      to: "TokemonTests/Snapshots/SnapshotTestHelper.swift"
      via: "snapshotController and SnapshotTestCase"
      pattern: "snapshotController|SnapshotTestCase"
---

<objective>
Extract popover height calculation into a testable pure function, write comprehensive unit tests for it, and create snapshot tests for the three leaf-level views (UsageHeaderView, UsageDetailView, FloatingWindowView) across multiple usage states and themes.

Purpose: These are the highest-priority views for catching height/layout bugs. UsageHeaderView is the dominant visual element, UsageDetailView shows data rows that vary by source, and FloatingWindowView has critical sizing. The popover height extraction directly addresses the user's reported height bugs by making the logic testable.

Output: Extracted height calculator with full unit test coverage, snapshot reference images for 3 leaf views across states/themes.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17.1-automated-testing/17.1-RESEARCH.md
@.planning/phases/17.1-automated-testing/17.1-01-SUMMARY.md
@Tokemon/TokemonApp.swift
@Tokemon/Views/MenuBar/UsageHeaderView.swift
@Tokemon/Views/MenuBar/UsageDetailView.swift
@Tokemon/Views/FloatingWindow/FloatingWindowView.swift
@Tokemon/Models/UsageSnapshot.swift
@Tokemon/Services/AlertManager.swift
@Tokemon/Utilities/Theme.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract popover height calculation and write unit tests</name>
  <files>
    Tokemon/Utilities/PopoverHeightCalculator.swift
    Tokemon/TokemonApp.swift
    TokemonTests/PopoverHeightTests.swift
  </files>
  <action>
**A) Create `Tokemon/Utilities/PopoverHeightCalculator.swift`:**

Extract the popover height logic from `TokemonApp.popoverHeight` into a pure, static function. The current logic in TokemonApp.swift (lines 27-68) reads from `profileManager.profiles.count`, `monitor.showExtraUsage`, `monitor.currentUsage.extraUsageEnabled`, `updateManager.updateAvailable`, and `showUsageTrend` (AppStorage). Extract to:

```swift
/// Pure function for calculating popover height based on content state.
/// Extracted from TokemonApp for testability.
enum PopoverHeightCalculator {
    /// Base height: account switcher + header + divider + detail + divider + footer + padding = ~300px
    static let baseHeight: CGFloat = 300
    static let updateBannerHeight: CGFloat = 56
    static let chartHeight: CGFloat = 230
    static let extraUsageHeight: CGFloat = 75
    static let profileSwitcherHeight: CGFloat = 28
    static let profileSummaryHeader: CGFloat = 32
    static let profileRowHeight: CGFloat = 24

    static func calculate(
        profileCount: Int,
        showExtraUsage: Bool,
        extraUsageEnabled: Bool,
        updateAvailable: Bool,
        showUsageTrend: Bool
    ) -> CGFloat {
        var height = baseHeight

        if profileCount > 1 {
            height += profileSwitcherHeight + profileSummaryHeader + (CGFloat(profileCount) * profileRowHeight)
        }

        if showExtraUsage && extraUsageEnabled {
            height += extraUsageHeight
        }

        if updateAvailable {
            height += updateBannerHeight
        }

        if showUsageTrend {
            height += chartHeight
        }

        return height
    }
}
```

**B) Update `Tokemon/TokemonApp.swift`:**

Replace the inline `popoverHeight` computed property body with a call to the extracted function:

```swift
private var popoverHeight: CGFloat {
    PopoverHeightCalculator.calculate(
        profileCount: profileManager.profiles.count,
        showExtraUsage: monitor.showExtraUsage,
        extraUsageEnabled: monitor.currentUsage.extraUsageEnabled,
        updateAvailable: updateManager.updateAvailable,
        showUsageTrend: showUsageTrend
    )
}
```

Keep the comments explaining the base height breakdown above the property. Remove the constants and logic that moved to PopoverHeightCalculator.

**C) Create `TokemonTests/PopoverHeightTests.swift`:**

Write unit tests for every branch in the height calculation:

1. `testBaseHeight_SingleProfile_NoExtras` -- profileCount=1, all false -> 300
2. `testWithChart_AddsChartHeight` -- showUsageTrend=true -> 300 + 230 = 530
3. `testWithUpdateBanner_AddsBannerHeight` -- updateAvailable=true -> 300 + 56 = 356
4. `testWithExtraUsage_AddsExtraHeight` -- showExtraUsage=true AND extraUsageEnabled=true -> 300 + 75 = 375
5. `testExtraUsage_OnlyWhenBothFlags` -- showExtraUsage=true but extraUsageEnabled=false -> 300 (no addition)
6. `testMultiProfile_TwoProfiles` -- profileCount=2 -> 300 + 28 + 32 + (2*24) = 408
7. `testMultiProfile_ThreeProfiles` -- profileCount=3 -> 300 + 28 + 32 + (3*24) = 432
8. `testAllExtras_Combined` -- all features on, 3 profiles -> 300 + (28+32+72) + 75 + 56 + 230 = 793 (verify exact math)
9. `testSingleProfile_NoProfileSwitcher` -- profileCount=1 -> no profile height added
10. `testZeroProfiles_NoProfileSwitcher` -- profileCount=0 -> no profile height added (edge case)

Use `XCTAssertEqual` with exact values. The constants are deterministic.
  </action>
  <verify>
`xcodebuild test -scheme Tokemon -project Tokemon.xcodeproj -destination 'platform=macOS' -only-testing:TokemonTests/PopoverHeightTests -quiet` -- all tests pass.
Verify the app still builds: `xcodebuild build -scheme Tokemon -project Tokemon.xcodeproj -destination 'platform=macOS' -quiet`.
  </verify>
  <done>
Popover height calculation is a pure static function in `PopoverHeightCalculator`. TokemonApp.swift delegates to it. All 10 height calculation unit tests pass. App builds and runs identically.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create snapshot tests for UsageHeaderView, UsageDetailView, and FloatingWindowView</name>
  <files>
    TokemonTests/Snapshots/UsageHeaderSnapshotTests.swift
    TokemonTests/Snapshots/UsageDetailSnapshotTests.swift
    TokemonTests/Snapshots/FloatingWindowSnapshotTests.swift
  </files>
  <action>
Create snapshot tests for the three leaf-level views. These views have minimal environment dependencies:
- **UsageHeaderView** needs: `usage: UsageSnapshot`, `alertLevel: AlertManager.AlertLevel`, `@Environment(ThemeManager.self)`
- **UsageDetailView** needs: `usage: UsageSnapshot`, `showExtraUsage: Bool` (no environment objects)
- **FloatingWindowView** needs: `@Environment(UsageMonitor.self)`, `@Environment(AlertManager.self)`, `@Environment(ThemeManager.self)`

For FloatingWindowView, you need to construct UsageMonitor and AlertManager instances. These are `@Observable @MainActor` classes. UsageMonitor has a default init that creates an `.empty` state. AlertManager has a default init with `.normal` level. Set their properties directly after construction for the desired test state (e.g., `monitor.currentUsage = .mockOAuth(percentage: 75)`).

Use the `SnapshotTestCase` base class and `snapshotController(width:height:)` helper from Plan 01.
Use `UsageSnapshot.mockOAuth()`, `.mockJSONL()`, `.empty`, `.mockWithExtraUsage()` factories from Plan 01.

**A) `TokemonTests/Snapshots/UsageHeaderSnapshotTests.swift`:**

Test cases (all extend SnapshotTestCase):
1. `testHeader_Empty` -- UsageSnapshot.empty, alertLevel: .normal, width: 320, height: 140
2. `testHeader_Low_25Percent` -- mockOAuth(percentage: 25), .normal
3. `testHeader_Medium_60Percent` -- mockOAuth(percentage: 60), .normal
4. `testHeader_High_80Percent` -- mockOAuth(percentage: 80), .warning
5. `testHeader_Critical_95Percent` -- mockOAuth(percentage: 95), .critical (shows warning banner)
6. `testHeader_JSONL_TokenCount` -- mockJSONL(), .normal
7. `testHeader_AllThemes_Medium` -- loop through AppTheme.allCases, set themeManager.selectedTheme, use named: "theme-\(theme.rawValue)"

For each test: create the view, inject `.environment(themeManager)`, wrap with `.snapshotController(width: 320, height: 140)` (use height: 180 for critical since it has the warning banner), and call `assertSnapshot(of:as:.image(precision: snapshotPrecision))`.

**B) `TokemonTests/Snapshots/UsageDetailSnapshotTests.swift`:**

Test cases:
1. `testDetail_OAuth_BasicUsage` -- mockOAuth(percentage: 50, sevenDay: 30), showExtraUsage: false
2. `testDetail_OAuth_WithSonnet` -- mockOAuth with sevenDaySonnet: 45
3. `testDetail_OAuth_WithOpus` -- mockOAuth with sevenDayOpus: 15
4. `testDetail_OAuth_WithExtraUsage` -- mockWithExtraUsage(), showExtraUsage: true
5. `testDetail_JSONL_TokenBreakdown` -- mockJSONL(inputTokens: 5000, outputTokens: 2000), showExtraUsage: false
6. `testDetail_JSONL_WithCache` -- mockJSONL with cacheRead and cacheCreation tokens

UsageDetailView takes plain parameters (no @Environment), so just create the view directly. Use width: 320, height: 200 (taller for extra usage rows).

**C) `TokemonTests/Snapshots/FloatingWindowSnapshotTests.swift`:**

FloatingWindowView reads from `@Environment(UsageMonitor.self)`. Create a UsageMonitor instance, set its `currentUsage` property, and inject as environment.

Test cases:
1. `testFloating_Empty` -- UsageMonitor with .empty usage
2. `testFloating_Low_25Percent` -- set monitor.currentUsage = .mockOAuth(percentage: 25)
3. `testFloating_Critical_95Percent` -- set monitor.currentUsage = .mockOAuth(percentage: 95), alertManager.currentAlertLevel = .critical
4. `testFloating_JSONL` -- set monitor.currentUsage = .mockJSONL()

Use width: 140, height: 100 (FloatingWindowView is compact).

For all tests: Use `precision: snapshotPrecision` (0.98). First run will generate reference images in `__Snapshots__/` directories (auto-created by SnapshotTesting). These reference images should be committed to git.

IMPORTANT: All test classes must be `@MainActor` since UsageMonitor and AlertManager are `@MainActor`. Annotate with `@MainActor final class ...Tests: SnapshotTestCase`.
  </action>
  <verify>
Run all snapshot tests:
`xcodebuild test -scheme Tokemon -project Tokemon.xcodeproj -destination 'platform=macOS' -only-testing:TokemonTests/UsageHeaderSnapshotTests -only-testing:TokemonTests/UsageDetailSnapshotTests -only-testing:TokemonTests/FloatingWindowSnapshotTests -quiet`

First run: all tests pass (record: .missing generates reference images).
Second run: all tests pass (comparison against reference images).
Verify `__Snapshots__` directories contain PNG reference images.
  </verify>
  <done>
Snapshot tests exist for UsageHeaderView (7 test cases), UsageDetailView (6 test cases), and FloatingWindowView (4 test cases). Reference images generated. All tests pass on re-run.
  </done>
</task>

</tasks>

<verification>
1. `PopoverHeightCalculator.calculate(...)` produces correct values for all input combinations
2. `TokemonApp.popoverHeight` delegates to `PopoverHeightCalculator` (no inline logic)
3. Snapshot reference images exist in `TokemonTests/Snapshots/__Snapshots__/` directories
4. All tests pass: `xcodebuild test -scheme Tokemon -project Tokemon.xcodeproj -destination 'platform=macOS' -only-testing:TokemonTests -quiet`
5. App builds and runs correctly after TokemonApp.swift refactor
</verification>

<success_criteria>
- PopoverHeightCalculator is a pure, testable function with 10+ unit tests covering every branch
- UsageHeaderView has snapshot tests for empty, low, medium, high, critical, JSONL, and multi-theme states
- UsageDetailView has snapshot tests for OAuth (basic, Sonnet, Opus, extra usage) and JSONL states
- FloatingWindowView has snapshot tests for empty, low, critical, and JSONL states
- All reference images are generated and tests pass on re-run
- Zero regressions in app functionality
</success_criteria>

<output>
After completion, create `.planning/phases/17.1-automated-testing/17.1-02-SUMMARY.md`
</output>
