---
phase: 17.1-automated-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - project.yml
  - TokemonTests/Snapshots/SnapshotTestHelper.swift
  - TokemonTests/Snapshots/MockDataFactories.swift
  - TokemonTests/UsageSnapshotTests.swift
autonomous: true

must_haves:
  truths:
    - "SnapshotTesting library resolves and compiles in TokemonTests target"
    - "Snapshot helper can render a SwiftUI view to an NSViewController for image capture"
    - "Mock UsageSnapshot instances can be created for any usage state (empty, low, medium, high, critical, OAuth, JSONL)"
    - "Existing unit tests compile and pass against current UsageSnapshot API"
  artifacts:
    - path: "project.yml"
      provides: "SnapshotTesting package dependency for TokemonTests"
      contains: "SnapshotTesting"
    - path: "TokemonTests/Snapshots/SnapshotTestHelper.swift"
      provides: "SwiftUI View extension for NSHostingController wrapping and SnapshotTestCase base class"
      min_lines: 30
    - path: "TokemonTests/Snapshots/MockDataFactories.swift"
      provides: "Factory methods for UsageSnapshot, ThemeManager, AlertManager for test use"
      min_lines: 40
    - path: "TokemonTests/UsageSnapshotTests.swift"
      provides: "Fixed unit tests using current UsageSnapshot memberwise init signature"
      min_lines: 50
  key_links:
    - from: "project.yml"
      to: "TokemonTests target"
      via: "package dependency declaration"
      pattern: "package: SnapshotTesting"
    - from: "TokemonTests/Snapshots/SnapshotTestHelper.swift"
      to: "SnapshotTesting"
      via: "import SnapshotTesting"
      pattern: "import SnapshotTesting"
    - from: "TokemonTests/Snapshots/MockDataFactories.swift"
      to: "UsageSnapshot"
      via: "@testable import tokemon"
      pattern: "UsageSnapshot"
---

<objective>
Add SnapshotTesting library to the project, create snapshot test infrastructure (helpers, mock factories), and fix existing broken unit tests to compile against the current UsageSnapshot API.

Purpose: This is the foundation that all snapshot tests in Plans 02 and 03 depend on. Without the library, helpers, and mock factories, no snapshot tests can be written.

Output: Working test infrastructure -- `xcodegen generate` succeeds, `xcodebuild build-for-testing` compiles the TokemonTests target with SnapshotTesting available, and existing unit tests pass.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17.1-automated-testing/17.1-RESEARCH.md
@project.yml
@Tokemon/Models/UsageSnapshot.swift
@TokemonTests/UsageSnapshotTests.swift
@Tokemon/Services/AlertManager.swift
@Tokemon/Utilities/Theme.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SnapshotTesting dependency and regenerate Xcode project</name>
  <files>project.yml</files>
  <action>
Add the SnapshotTesting package to `project.yml`:

1. In the `packages:` section, add after KeychainAccess:
```yaml
  SnapshotTesting:
    url: https://github.com/pointfreeco/swift-snapshot-testing.git
    from: "1.18.0"
```

2. In the `TokemonTests:` target `dependencies:` list, add:
```yaml
      - package: SnapshotTesting
        product: SnapshotTesting
```

3. Run `xcodegen generate` to regenerate the Xcode project with the new dependency.

4. Run `xcodebuild -resolvePackageDependencies -scheme Tokemon -project Tokemon.xcodeproj` to resolve the SPM package.

5. Verify it compiles: `xcodebuild build-for-testing -scheme Tokemon -project Tokemon.xcodeproj -destination 'platform=macOS' -quiet`

IMPORTANT: Do NOT add SnapshotTesting to Package.swift. It goes in project.yml only, for the test target only. The research explicitly warns against the SPM path for snapshot tests.
  </action>
  <verify>
`xcodegen generate` succeeds without errors.
`xcodebuild build-for-testing -scheme Tokemon -project Tokemon.xcodeproj -destination 'platform=macOS' -quiet` compiles successfully (exit code 0).
  </verify>
  <done>SnapshotTesting package resolves, TokemonTests target compiles with access to `import SnapshotTesting`.</done>
</task>

<task type="auto">
  <name>Task 2: Create snapshot test helper, mock factories, and fix existing tests</name>
  <files>
    TokemonTests/Snapshots/SnapshotTestHelper.swift
    TokemonTests/Snapshots/MockDataFactories.swift
    TokemonTests/UsageSnapshotTests.swift
  </files>
  <action>
**A) Create `TokemonTests/Snapshots/SnapshotTestHelper.swift`:**

Create a SwiftUI View extension and base test class for macOS snapshot testing:

```swift
import SnapshotTesting
import SwiftUI
import AppKit
import XCTest
@testable import tokemon

// MARK: - SwiftUI View Snapshotting Helper

extension SwiftUI.View {
    /// Wraps a SwiftUI view in NSHostingController with explicit dimensions for snapshot testing.
    func snapshotController(
        width: CGFloat = 320,
        height: CGFloat = 400
    ) -> NSViewController {
        let vc = NSHostingController(rootView: self)
        vc.view.frame = CGRect(x: 0, y: 0, width: width, height: height)
        vc.view.layoutSubtreeIfNeeded()
        return vc
    }
}

// MARK: - Snapshot Test Base Class

/// Base class for snapshot tests. Configures `record: .missing` so reference
/// images are auto-recorded on first run, then compared on subsequent runs.
class SnapshotTestCase: XCTestCase {
    override func invokeTest() {
        withSnapshotTesting(record: .missing) {
            super.invokeTest()
        }
    }

    /// Standard precision for cross-machine tolerance (Retina vs CI).
    let snapshotPrecision: Float = 0.98
}
```

**B) Create `TokemonTests/Snapshots/MockDataFactories.swift`:**

Create factory methods that match the CURRENT `UsageSnapshot` memberwise init signature. The current struct has these required fields: `primaryPercentage`, `fiveHourUtilization`, `sevenDayUtilization`, `sevenDayOpusUtilization`, `sevenDaySonnetUtilization`, `resetsAt`, `sevenDayResetsAt`, `sevenDaySonnetResetsAt`, `source`, `inputTokens`, `outputTokens`, `cacheCreationTokens`, `cacheReadTokens`, `model`, `extraUsageEnabled`, `extraUsageMonthlyLimitCents`, `extraUsageSpentCents`, `extraUsageUtilization`.

```swift
import Foundation
@testable import tokemon

// MARK: - UsageSnapshot Test Factories

extension UsageSnapshot {
    /// OAuth snapshot at a given percentage with optional extras
    static func mockOAuth(
        percentage: Double,
        fiveHour: Double? = nil,
        sevenDay: Double? = nil,
        sevenDayOpus: Double? = nil,
        sevenDaySonnet: Double? = nil,
        resetsAt: Date? = Date().addingTimeInterval(3600),
        extraUsageEnabled: Bool = false,
        extraUsageSpentCents: Double? = nil,
        extraUsageLimitCents: Int? = nil,
        extraUsageUtilization: Double? = nil
    ) -> UsageSnapshot {
        UsageSnapshot(
            primaryPercentage: percentage,
            fiveHourUtilization: fiveHour ?? percentage,
            sevenDayUtilization: sevenDay,
            sevenDayOpusUtilization: sevenDayOpus,
            sevenDaySonnetUtilization: sevenDaySonnet,
            resetsAt: resetsAt,
            sevenDayResetsAt: nil,
            sevenDaySonnetResetsAt: nil,
            source: .oauth,
            inputTokens: Int(percentage * 100),
            outputTokens: Int(percentage * 50),
            cacheCreationTokens: nil,
            cacheReadTokens: nil,
            model: nil,
            extraUsageEnabled: extraUsageEnabled,
            extraUsageMonthlyLimitCents: extraUsageLimitCents,
            extraUsageSpentCents: extraUsageSpentCents,
            extraUsageUtilization: extraUsageUtilization
        )
    }

    /// JSONL snapshot with token counts
    static func mockJSONL(
        inputTokens: Int = 5000,
        outputTokens: Int = 2000,
        cacheRead: Int? = nil,
        cacheCreation: Int? = nil,
        model: String = "claude-sonnet-4-20250514"
    ) -> UsageSnapshot {
        UsageSnapshot(
            primaryPercentage: 0,
            fiveHourUtilization: nil,
            sevenDayUtilization: nil,
            sevenDayOpusUtilization: nil,
            sevenDaySonnetUtilization: nil,
            resetsAt: nil,
            sevenDayResetsAt: nil,
            sevenDaySonnetResetsAt: nil,
            source: .jsonl,
            inputTokens: inputTokens,
            outputTokens: outputTokens,
            cacheCreationTokens: cacheCreation,
            cacheReadTokens: cacheRead,
            model: model,
            extraUsageEnabled: false,
            extraUsageMonthlyLimitCents: nil,
            extraUsageSpentCents: nil,
            extraUsageUtilization: nil
        )
    }

    /// OAuth snapshot with extra usage billing enabled
    static func mockWithExtraUsage(
        percentage: Double = 60,
        spentCents: Double = 1250,
        limitCents: Int = 5000,
        utilization: Double = 25.0
    ) -> UsageSnapshot {
        mockOAuth(
            percentage: percentage,
            extraUsageEnabled: true,
            extraUsageSpentCents: spentCents,
            extraUsageLimitCents: limitCents,
            extraUsageUtilization: utilization
        )
    }
}
```

IMPORTANT: Read `Tokemon/Models/UsageSnapshot.swift` first to confirm the exact memberwise init parameter names and types before writing. The research code examples use an OLDER API (`secondaryPercentage`, `resetTime`) that no longer exists. Use the CURRENT struct fields.

**C) Fix `TokemonTests/UsageSnapshotTests.swift`:**

The existing tests use stale API: `secondaryPercentage` (doesn't exist), `resetTime` (now `resetsAt`), `resetTimeFormatted` (no longer a property). Read the current file and the current UsageSnapshot model, then rewrite each test to use the correct memberwise initializer. Preserve the test intent but fix the parameter names. Also add tests for new computed properties (`formattedExtraUsageSpent`, `formattedMonthlyLimit`, `formattedTokenCount`).

Keep the same test class name and similar test method names. Use `UsageSnapshot.empty` and the new mock factories where appropriate.
  </action>
  <verify>
`xcodebuild test -scheme Tokemon -project Tokemon.xcodeproj -destination 'platform=macOS' -only-testing:TokemonTests/UsageSnapshotTests -quiet` passes all tests.
Verify `SnapshotTestHelper.swift` and `MockDataFactories.swift` are importable by creating a trivial compile check.
  </verify>
  <done>
Snapshot test helper with `snapshotController(width:height:)` extension exists. Mock factories for UsageSnapshot (OAuth, JSONL, extra usage, empty states) exist. All existing UsageSnapshotTests pass against current API.
  </done>
</task>

</tasks>

<verification>
1. `xcodegen generate` runs without errors
2. `xcodebuild build-for-testing -scheme Tokemon -project Tokemon.xcodeproj -destination 'platform=macOS' -quiet` compiles successfully
3. `xcodebuild test -scheme Tokemon -project Tokemon.xcodeproj -destination 'platform=macOS' -only-testing:TokemonTests -quiet` -- all unit tests pass
4. `import SnapshotTesting` resolves in TokemonTests target
</verification>

<success_criteria>
- SnapshotTesting 1.18.x resolves as a dependency in project.yml
- TokemonTests target compiles with SnapshotTesting available
- `snapshotController(width:height:)` View extension is usable
- `UsageSnapshot.mockOAuth(percentage:)`, `.mockJSONL()`, `.mockWithExtraUsage()` factories produce valid snapshots
- All existing unit tests pass (no regressions from API fixes)
</success_criteria>

<output>
After completion, create `.planning/phases/17.1-automated-testing/17.1-01-SUMMARY.md`
</output>
