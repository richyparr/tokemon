---
phase: 17.1-automated-testing
plan: 03
subsystem: testing
tags: [snapshot-testing, swiftui, popover, settings, profile-switcher, composite-views]

# Dependency graph
requires:
  - phase: 17.1-01
    provides: "SnapshotTesting library, SnapshotTestCase base class, MockDataFactories"
provides:
  - "PopoverContentView snapshot tests covering 8 state combinations (OAuth, empty, critical, JSONL, chart, extra usage, themes, multi-profile)"
  - "Settings tab snapshot tests for 5 tabs (General, Appearance, Alert, Refresh, Statusline)"
  - "ProfileSwitcherView snapshot tests for 2-profile and 3-profile states"
  - "setUp() pattern for clearing UserDefaults-persisted ProfileManager between tests"
  - "Deterministic snapshot pattern: pass resetsAt: nil to avoid time-dependent text"
affects: []

# Tech tracking
tech-stack:
  added: []
  patterns: [userdefaults-cleanup-in-setUp, deterministic-mock-data-for-snapshots, composite-view-environment-injection]

key-files:
  created:
    - TokemonTests/Snapshots/PopoverSnapshotTests.swift
    - TokemonTests/Snapshots/SettingsSnapshotTests.swift
    - TokemonTests/Snapshots/ProfileSwitcherSnapshotTests.swift
  modified:
    - Tokemon.xcodeproj/project.pbxproj

key-decisions:
  - "Pass resetsAt: nil to all mockOAuth calls in snapshot tests to avoid time-dependent subtitle text"
  - "Clear tokemon.profiles and tokemon.activeProfileId UserDefaults in setUp() to prevent profile accumulation across tests"
  - "Skip complex settings tabs (AdminAPI, Team, Analytics, Budget, Webhooks) that require API state or external services"
  - "Use relaxedPrecision (0.95) for chart-containing snapshots due to rendering variations"

patterns-established:
  - "UserDefaults cleanup: Clear persisted state in setUp() when @Observable objects use UserDefaults"
  - "Deterministic mocks: Use resetsAt: nil instead of Date()-based times to eliminate time drift in snapshots"
  - "Composite view testing: Inject all 5 environment objects (UsageMonitor, AlertManager, ThemeManager, ProfileManager, UpdateManager) with stopPolling() for UsageMonitor"

# Metrics
duration: 20min
completed: 2026-02-19
---

# Phase 17.1 Plan 03: Composite View Snapshot Tests Summary

**15 snapshot tests for PopoverContentView (8 states), Settings tabs (5 tabs), and ProfileSwitcherView (2 states) with deterministic mock data and UserDefaults cleanup**

## Performance

- **Duration:** 20 min
- **Started:** 2026-02-19T04:51:48Z
- **Completed:** 2026-02-19T05:12:36Z
- **Tasks:** 2
- **Files modified:** 4 (3 created + 1 modified)

## Accomplishments
- PopoverContentView snapshot tests covering 8 state combinations: OAuth basic, empty, critical alert, JSONL tokens, chart enabled, extra usage billing, all 3 themes, and multi-profile with 2 profiles
- Settings tab snapshot tests for 5 tabs at default state: GeneralSettings, AppearanceSettings, AlertSettings, RefreshSettings, StatuslineSettings
- ProfileSwitcherView snapshot tests for 2-profile and 3-profile configurations
- Deterministic test patterns established: UserDefaults cleanup in setUp(), resetsAt: nil for time-stable output, explicit monitor state reset
- Full test suite: 133 tests passing (91 unit + 42 snapshot) in under 1 second

## Task Commits

Each task was committed atomically:

1. **Task 1: PopoverContentView snapshot tests** - `b4b5da1` (feat)
2. **Task 1 fix: deterministic resetsAt** - `42e1be7` (fix)
3. **Task 2: Settings tabs and ProfileSwitcher snapshot tests** - `fb49f96` (feat)
4. **Task 1+2 fix: UserDefaults setUp cleanup** - `af91125` (fix)

## Files Created/Modified
- `TokemonTests/Snapshots/PopoverSnapshotTests.swift` - 8 snapshot tests for PopoverContentView with all 5 environment objects injected, setUp() cleanup, deterministic mock data
- `TokemonTests/Snapshots/SettingsSnapshotTests.swift` - 5 snapshot tests for individual settings tab views (General, Appearance, Alert, Refresh, Statusline)
- `TokemonTests/Snapshots/ProfileSwitcherSnapshotTests.swift` - 2 snapshot tests for ProfileSwitcherView with 2-profile and 3-profile states
- `TokemonTests/Snapshots/__Snapshots__/PopoverSnapshotTests/` - 10 reference images (3 themes + 7 states)
- `TokemonTests/Snapshots/__Snapshots__/SettingsSnapshotTests/` - 5 reference images
- `TokemonTests/Snapshots/__Snapshots__/ProfileSwitcherSnapshotTests/` - 2 reference images

## Decisions Made
- Pass `resetsAt: nil` to all `mockOAuth` calls in snapshot tests to avoid time-dependent subtitle text ("resets in Xm" changes between runs, "of 5-hour limit" is stable)
- Clear `tokemon.profiles` and `tokemon.activeProfileId` from UserDefaults in `setUp()` to prevent profile accumulation across tests (ProfileManager persists to UserDefaults)
- Skip complex settings tabs (AdminAPISettings, TeamDashboardView, AnalyticsDashboardView, BudgetDashboardView, WebhookSettings) that depend on API state, history data, or external services
- Use `relaxedPrecision` (0.95) for chart-containing snapshots due to gradient rendering variations
- Explicitly set `monitor.lastUpdated = nil`, `monitor.error = nil`, `monitor.isRefreshing = false` after `stopPolling()` for fully deterministic RefreshStatusView

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed non-deterministic resetsAt in mock data**
- **Found during:** Task 1 (verification re-run)
- **Issue:** Default `resetsAt: Date().addingTimeInterval(3600)` produced different subtitle text on each run ("resets in 59m" vs "resets in 58m"), causing snapshot mismatches
- **Fix:** Pass `resetsAt: nil` to all mockOAuth calls, producing stable "of 5-hour limit" subtitle
- **Files modified:** TokemonTests/Snapshots/PopoverSnapshotTests.swift
- **Verification:** Tests pass consistently across 3 consecutive runs
- **Committed in:** 42e1be7

**2. [Rule 1 - Bug] Fixed UserDefaults profile accumulation across tests**
- **Found during:** Task 2 (full suite verification)
- **Issue:** ProfileManager persists profiles to UserDefaults via `saveProfiles()`. Profiles created in multi-profile test leaked into subsequent single-profile tests, causing "Profile 2" entries to appear in OAuthBasic test
- **Fix:** Added `setUp()` to both PopoverSnapshotTests and ProfileSwitcherSnapshotTests that clears `tokemon.profiles` and `tokemon.activeProfileId` keys from UserDefaults before each test
- **Files modified:** TokemonTests/Snapshots/PopoverSnapshotTests.swift, TokemonTests/Snapshots/ProfileSwitcherSnapshotTests.swift
- **Verification:** All 15 tests pass consistently across multiple runs with clean profile state
- **Committed in:** af91125

---

**Total deviations:** 2 auto-fixed (2 bugs)
**Impact on plan:** Both fixes were necessary for test determinism. Without them, tests would fail intermittently based on timing and test execution order. No scope creep.

## Issues Encountered
- ProfileManager.init() performs keychain sync via `/usr/bin/security` which fails silently in test environment -- this is harmless, creates a default profile with no credentials
- UsageMonitor.init() calls startPolling() which triggers async network tasks -- mitigated by calling stopPolling() immediately and setting state explicitly
- UpdateManager.init() initializes Sparkle framework -- works in test host app context, defaults are safe (updateAvailable=false)

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Phase 17.1 (Automated Testing) is complete: 133 tests (91 unit + 42 snapshot) all passing
- Snapshot coverage: leaf views (Plan 02), composite views (Plan 03), settings tabs, profile switcher
- Ready to proceed to Phase 18+ (Raycast Extension)

## Self-Check: PASSED

- All 3 test files exist on disk
- All reference image directories populated (10 + 5 + 2 = 17 images)
- All 4 commit hashes verified in git log

---
*Phase: 17.1-automated-testing*
*Completed: 2026-02-19*
