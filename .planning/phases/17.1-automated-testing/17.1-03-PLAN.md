---
phase: 17.1-automated-testing
plan: 03
type: execute
wave: 2
depends_on: ["17.1-01"]
files_modified:
  - TokemonTests/Snapshots/PopoverSnapshotTests.swift
  - TokemonTests/Snapshots/SettingsSnapshotTests.swift
  - TokemonTests/Snapshots/ProfileSwitcherSnapshotTests.swift
autonomous: true

must_haves:
  truths:
    - "PopoverContentView renders correctly with mock environment objects injected"
    - "PopoverContentView layout is captured at different state combinations (single profile, multi-profile, with chart, without chart)"
    - "Settings tabs render without overflow at the standard settings window size"
    - "ProfileSwitcherView renders correctly for multi-profile state"
  artifacts:
    - path: "TokemonTests/Snapshots/PopoverSnapshotTests.swift"
      provides: "Snapshot tests for PopoverContentView composite view"
      min_lines: 60
    - path: "TokemonTests/Snapshots/SettingsSnapshotTests.swift"
      provides: "Snapshot tests for individual settings tab views"
      min_lines: 50
    - path: "TokemonTests/Snapshots/ProfileSwitcherSnapshotTests.swift"
      provides: "Snapshot tests for ProfileSwitcherView"
      min_lines: 30
  key_links:
    - from: "TokemonTests/Snapshots/PopoverSnapshotTests.swift"
      to: "TokemonTests/Snapshots/MockDataFactories.swift"
      via: "UsageSnapshot mock factories"
      pattern: "mockOAuth|mockJSONL|mockWithExtraUsage"
    - from: "TokemonTests/Snapshots/PopoverSnapshotTests.swift"
      to: "Tokemon/Views/MenuBar/PopoverContentView.swift"
      via: "@testable import tokemon"
      pattern: "PopoverContentView"
---

<objective>
Create snapshot tests for the composite views: PopoverContentView (the main UI with all 7 environment dependencies), selected Settings tabs, and ProfileSwitcherView. These are more complex than leaf views because they require multiple @Observable mock objects injected as environment.

Purpose: PopoverContentView is where height bugs manifest -- it composes all the leaf views and is the primary UI surface. Settings tabs can overflow. ProfileSwitcherView affects popover height. Snapshotting these catches layout regressions that leaf-view tests miss.

Output: Snapshot reference images for composite views across key state combinations.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17.1-automated-testing/17.1-RESEARCH.md
@.planning/phases/17.1-automated-testing/17.1-01-SUMMARY.md
@Tokemon/Views/MenuBar/PopoverContentView.swift
@Tokemon/Views/Settings/SettingsView.swift
@Tokemon/Views/MenuBar/ProfileSwitcherView.swift
@Tokemon/Models/UsageSnapshot.swift
@Tokemon/Services/UsageMonitor.swift
@Tokemon/Services/AlertManager.swift
@Tokemon/Services/ProfileManager.swift
@Tokemon/Utilities/Theme.swift
@Tokemon/Services/UpdateManager.swift
@Tokemon/Services/WebhookManager.swift
@Tokemon/Services/BudgetManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create snapshot tests for PopoverContentView</name>
  <files>TokemonTests/Snapshots/PopoverSnapshotTests.swift</files>
  <action>
PopoverContentView requires these environment objects:
- `@Environment(UsageMonitor.self)` -- has default init, set `.currentUsage` for state
- `@Environment(AlertManager.self)` -- has default init, set `.currentAlertLevel`
- `@Environment(ThemeManager.self)` -- has default init, set `.selectedTheme`
- `@Environment(ProfileManager.self)` -- has default init, profiles array controls multi-profile display

Read `Tokemon/Services/ProfileManager.swift` to understand how to create profiles (the `profiles` property and how to add entries). Also read `Tokemon/Services/UsageMonitor.swift` to confirm `showExtraUsage` is a settable property.

For the popover, PopoverContentView also reads `@AppStorage("showUsageTrend")`. In tests, set this via `UserDefaults.standard.set(false, forKey: "showUsageTrend")` before creating the view.

Create a `@MainActor final class PopoverSnapshotTests: SnapshotTestCase` with a helper that constructs all required environment objects:

```swift
private func makePopoverView(
    usage: UsageSnapshot = .mockOAuth(percentage: 50),
    alertLevel: AlertManager.AlertLevel = .normal,
    theme: AppTheme = .native,
    showChart: Bool = false,
    showExtraUsage: Bool = false
) -> some View {
    let monitor = UsageMonitor()
    monitor.currentUsage = usage
    monitor.showExtraUsage = showExtraUsage

    let alertManager = AlertManager()
    alertManager.currentAlertLevel = alertLevel

    let themeManager = ThemeManager()
    themeManager.selectedTheme = theme

    let profileManager = ProfileManager()
    // Leave as single profile by default

    UserDefaults.standard.set(showChart, forKey: "showUsageTrend")

    return PopoverContentView()
        .environment(monitor)
        .environment(alertManager)
        .environment(themeManager)
        .environment(profileManager)
}
```

IMPORTANT: If PopoverContentView also needs `@Environment(UpdateManager.self)`, `@Environment(WebhookManager.self)`, or `@Environment(BudgetManager.self)`, inject those too. Read PopoverContentView.swift to check -- if it only accesses them through child views that aren't rendered in the test state, they may not be needed. But if the view crashes without them, add default instances.

If constructing any @Observable object has side effects (network calls, file access in init), wrap in a do/catch or check if there's a way to construct without side effects. If an object's init is too complex, skip that test case and document why.

Test cases:
1. `testPopover_OAuthBasic_50Percent` -- Basic OAuth at 50%, no chart, single profile. Width: 320, height: 300.
2. `testPopover_Empty_NoData` -- UsageSnapshot.empty. Width: 320, height: 300.
3. `testPopover_Critical_95Percent` -- 95% with .critical alert level (shows warning banner). Width: 320, height: 340.
4. `testPopover_JSONL_TokenView` -- JSONL data source. Width: 320, height: 300.
5. `testPopover_WithChart` -- OAuth 50% with showChart=true. Width: 320, height: 530 (300 + 230).
6. `testPopover_WithExtraUsage` -- mockWithExtraUsage, showExtraUsage=true. Width: 320, height: 375 (300 + 75).
7. `testPopover_AllThemes` -- Loop through AppTheme.allCases at 50% usage, named snapshots.

Use the heights from PopoverHeightCalculator constants (Plan 02) to set the correct snapshot height for each state.

If multi-profile testing is feasible (ProfileManager allows adding test profiles), add:
8. `testPopover_MultiProfile_TwoProfiles` -- Width: 320, height calculated for 2 profiles.

If ProfileManager requires keychain or filesystem access that makes testing impractical, skip multi-profile popover tests and note in a comment.
  </action>
  <verify>
`xcodebuild test -scheme Tokemon -project Tokemon.xcodeproj -destination 'platform=macOS' -only-testing:TokemonTests/PopoverSnapshotTests -quiet` -- all tests pass.
Reference images exist in `TokemonTests/Snapshots/__Snapshots__/PopoverSnapshotTests/` directory.
  </verify>
  <done>
PopoverContentView snapshot tests cover basic OAuth, empty, critical, JSONL, chart, extra usage, and multi-theme states. Reference images generated. All pass on re-run.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create snapshot tests for Settings tabs and ProfileSwitcherView</name>
  <files>
    TokemonTests/Snapshots/SettingsSnapshotTests.swift
    TokemonTests/Snapshots/ProfileSwitcherSnapshotTests.swift
  </files>
  <action>
**A) `TokemonTests/Snapshots/SettingsSnapshotTests.swift`:**

Test individual settings tab views (not the TabView container -- that's hard to snapshot meaningfully). Each tab view has different environment requirements. Read each settings file to determine what @Environment objects it needs.

From SettingsView.swift, the tabs and their environments:
- `GeneralSettings()` -- read file to check dependencies (likely minimal)
- `RefreshSettings()` -- needs `@Environment(UsageMonitor.self)`
- `DataSourceSettings()` -- needs `@Environment(UsageMonitor.self)`
- `AppearanceSettings()` -- needs `@Environment(UsageMonitor.self)`, `@Environment(ThemeManager.self)`
- `AlertSettings()` -- needs `@Environment(AlertManager.self)`
- `StatuslineSettings()` -- likely minimal dependencies

Focus on the tabs most likely to have layout issues: AppearanceSettings, AlertSettings, and GeneralSettings. Skip tabs that require complex external state (AdminAPISettings, TeamDashboardView, AnalyticsDashboardView, BudgetDashboardView, WebhookSettings) -- these depend on API state, history data, or complex service objects.

Test cases:
1. `testGeneralSettings_Default` -- width: 500, height: 350
2. `testAppearanceSettings_Default` -- width: 500, height: 350
3. `testAlertSettings_Default` -- width: 500, height: 350
4. `testRefreshSettings_Default` -- width: 500, height: 350
5. `testStatuslineSettings_Default` -- width: 500, height: 350

Each test: construct the view, inject required environment objects with default state, snapshot at settings window size. If a tab crashes due to missing dependencies, skip it with a comment.

**B) `TokemonTests/Snapshots/ProfileSwitcherSnapshotTests.swift`:**

Read `Tokemon/Views/MenuBar/ProfileSwitcherView.swift` to understand its dependencies. It likely reads from `@Environment(ProfileManager.self)`.

Read `Tokemon/Services/ProfileManager.swift` to understand the Profile model and how to create test profiles. If ProfileManager has a `profiles` array that can be set directly, create test profiles. If it reads from disk/keychain in init, you may need to construct profiles manually.

Test cases (if feasible):
1. `testProfileSwitcher_TwoProfiles` -- Two profiles, first active
2. `testProfileSwitcher_ThreeProfiles` -- Three profiles, second active

Width: 290 (fits within 320 popover with padding), height: 40.

If ProfileManager cannot be easily mocked (requires keychain/disk), document this limitation and skip these tests. The popover multi-profile state is the higher-priority test.
  </action>
  <verify>
`xcodebuild test -scheme Tokemon -project Tokemon.xcodeproj -destination 'platform=macOS' -only-testing:TokemonTests/SettingsSnapshotTests -only-testing:TokemonTests/ProfileSwitcherSnapshotTests -quiet` -- all implemented tests pass.
Reference images exist for all test cases.
  </verify>
  <done>
Settings tab views (General, Appearance, Alerts, Refresh, Statusline) have snapshot tests at default state. ProfileSwitcherView has snapshot tests if ProfileManager is testable (documented if not). Reference images committed.
  </done>
</task>

</tasks>

<verification>
1. All snapshot tests pass: `xcodebuild test -scheme Tokemon -project Tokemon.xcodeproj -destination 'platform=macOS' -only-testing:TokemonTests -quiet`
2. Reference images exist in `__Snapshots__` directories
3. No crashes from missing environment objects
4. Total snapshot test count across all plans is 20+ test cases
</verification>

<success_criteria>
- PopoverContentView has 7+ snapshot tests covering OAuth, JSONL, critical, chart, extra usage, and themes
- Settings tabs have snapshot tests for at least 3-5 tabs at default state
- ProfileSwitcherView tested if ProfileManager is testable
- All reference images generated and committed
- Full test suite passes: unit tests + snapshot tests
</success_criteria>

<output>
After completion, create `.planning/phases/17.1-automated-testing/17.1-03-SUMMARY.md`
</output>
