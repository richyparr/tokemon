---
phase: 17.1-automated-testing
plan: 02
subsystem: testing
tags: [swift-snapshot-testing, xctest, popover-height, usage-header, usage-detail, floating-window]

# Dependency graph
requires:
  - phase: 17.1-01
    provides: "SnapshotTesting library, SnapshotTestCase, snapshotController helper, MockDataFactories"
provides:
  - "PopoverHeightCalculator pure function with 10 unit tests"
  - "UsageHeaderView snapshot tests across 7 states (empty, low, medium, high, critical, JSONL, multi-theme)"
  - "UsageDetailView snapshot tests for 6 states (OAuth basic/Sonnet/Opus/extra, JSONL tokens/cache)"
  - "FloatingWindowView snapshot tests for 4 states (empty, low, critical, JSONL)"
  - "19 reference PNG images for snapshot comparison (9 header, 6 detail, 4 floating)"
affects: [17.1-03]

# Tech tracking
tech-stack:
  added: []
  patterns: [pure-function-extraction, popover-height-testability]

key-files:
  created:
    - Tokemon/Utilities/PopoverHeightCalculator.swift
    - TokemonTests/PopoverHeightTests.swift
    - TokemonTests/Snapshots/UsageHeaderSnapshotTests.swift
    - TokemonTests/Snapshots/UsageDetailSnapshotTests.swift
    - TokemonTests/Snapshots/FloatingWindowSnapshotTests.swift
  modified:
    - Tokemon/TokemonApp.swift
    - Tokemon.xcodeproj/project.pbxproj

key-decisions:
  - "Extracted PopoverHeightCalculator as enum with static function for zero-instance pure computation"
  - "TokemonApp.popoverHeight delegates entirely to PopoverHeightCalculator.calculate()"
  - "Snapshot tests use @MainActor since UsageMonitor and AlertManager are @MainActor-isolated"

patterns-established:
  - "Pure function extraction: move testable logic out of SwiftUI views into enum with static methods"
  - "Snapshot test helper pattern: create makeXxx() factory method per test class for view + environment setup"

# Metrics
duration: 6min
completed: 2026-02-19
---

# Phase 17.1 Plan 02: Menu Bar Snapshot Tests Summary

**PopoverHeightCalculator extracted as pure function with 10 unit tests, plus 17 snapshot tests covering UsageHeaderView, UsageDetailView, and FloatingWindowView across usage states and themes**

## Performance

- **Duration:** 6 min
- **Started:** 2026-02-19T04:51:50Z
- **Completed:** 2026-02-19T04:58:20Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- Extracted popover height calculation from TokemonApp into pure, testable PopoverHeightCalculator enum
- 10 unit tests covering every branch: base height, chart, update banner, extra usage (both flags), multi-profile (2 and 3 profiles), zero profiles edge case, and all-combined
- 17 snapshot tests across 3 leaf views with 19 reference PNG images committed (theme loop generates 3 separate images)
- All 27 tests pass on re-run (10 unit + 17 snapshot)

## Task Commits

Each task was committed atomically:

1. **Task 1: Extract popover height calculation and write unit tests** - `2937154` (feat)
2. **Task 2: Create snapshot tests for UsageHeaderView, UsageDetailView, FloatingWindowView** - `a3afa0b` (feat)

## Files Created/Modified
- `Tokemon/Utilities/PopoverHeightCalculator.swift` - Pure static function for popover height calculation with named constants
- `TokemonTests/PopoverHeightTests.swift` - 10 unit tests for every height calculation branch
- `TokemonTests/Snapshots/UsageHeaderSnapshotTests.swift` - 7 snapshot tests: empty, low (25%), medium (60%), high (80%), critical (95%), JSONL, and all-themes loop
- `TokemonTests/Snapshots/UsageDetailSnapshotTests.swift` - 6 snapshot tests: OAuth basic/Sonnet/Opus/extra-usage, JSONL tokens/cache
- `TokemonTests/Snapshots/FloatingWindowSnapshotTests.swift` - 4 snapshot tests: empty, low (25%), critical (95%), JSONL
- `Tokemon/TokemonApp.swift` - Replaced inline height logic with PopoverHeightCalculator.calculate() delegation
- `Tokemon.xcodeproj/project.pbxproj` - Added new source and test files

## Decisions Made
- Used enum (not struct/class) for PopoverHeightCalculator since it has no state -- purely a namespace for static computation
- Named all height constants explicitly (baseHeight, updateBannerHeight, chartHeight, etc.) for self-documenting code
- All snapshot test classes annotated @MainActor to match UsageMonitor and AlertManager isolation requirements
- Used height: 180 for critical header test (vs 140 standard) to accommodate warning banner

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- PopoverHeightCalculator is fully tested and can be extended if new popover sections are added
- Snapshot reference images establish visual baselines for catching layout regressions
- All existing tests (91 unit from Plan 01 + 27 new) continue passing
- Ready for Plan 03 (remaining view snapshot tests)

## Self-Check: PASSED

- All 5 created files exist on disk
- Both task commits verified (2937154, a3afa0b)
- 19 reference PNG images confirmed (9 UsageHeader, 6 UsageDetail, 4 FloatingWindow)
- All 27 tests pass on final verification run

---
*Phase: 17.1-automated-testing*
*Completed: 2026-02-19*
