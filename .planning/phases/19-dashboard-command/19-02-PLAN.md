---
phase: 19-dashboard-command
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - tokemon-raycast/src/index.tsx
autonomous: false

must_haves:
  truths:
    - "User sees session usage percentage in dashboard (DASH-01)"
    - "User sees weekly usage percentage in dashboard (DASH-02)"
    - "User sees reset countdown timer that ticks every second (DASH-03)"
    - "User sees pace indicator with colored tag (on track / ahead / behind) (DASH-04)"
    - "User can manually refresh data with Cmd+R (DASH-05)"
  artifacts:
    - path: "tokemon-raycast/src/index.tsx"
      provides: "Full Dashboard command with Detail.Metadata layout"
      min_lines: 80
      contains: "useCachedPromise"
  key_links:
    - from: "tokemon-raycast/src/index.tsx"
      to: "tokemon-raycast/src/api.ts"
      via: "useCachedPromise wrapping fetchUsage"
      pattern: "useCachedPromise.*fetchUsage"
    - from: "tokemon-raycast/src/index.tsx"
      to: "tokemon-raycast/src/utils.ts"
      via: "imports formatCountdown, computePace, parseResetDate, formatPercentage, usageColor"
      pattern: "import.*formatCountdown.*from.*utils"
    - from: "tokemon-raycast/src/index.tsx"
      to: "tokemon-raycast/src/types.ts"
      via: "imports UsageData type"
      pattern: "import.*UsageData.*from.*types"
---

<objective>
Build the full Dashboard command UI that displays Claude usage data using Raycast's Detail + Detail.Metadata components.

Purpose: This is the core user-facing feature of Phase 19. Users open the Dashboard command and immediately see their session usage, weekly usage, countdown to reset, and pace indicator -- all from a single API call rendered in Raycast's native UI.

Output: Rewritten `index.tsx` that replaces the current stub with a full dashboard meeting all 5 DASH requirements.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-dashboard-command/19-RESEARCH.md
@.planning/phases/19-dashboard-command/19-01-SUMMARY.md

@tokemon-raycast/src/api.ts
@tokemon-raycast/src/types.ts
@tokemon-raycast/src/utils.ts
@tokemon-raycast/src/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite index.tsx with full Dashboard UI</name>
  <files>tokemon-raycast/src/index.tsx</files>
  <action>
Replace the current stub `index.tsx` entirely with the full Dashboard command. The component must:

**Data fetching with useCachedPromise:**
- Import `useCachedPromise` from `@raycast/utils`
- Get token from preferences using `getPreferenceValues`, then `extractToken(oauthToken)`
- Call `useCachedPromise` wrapping `fetchUsage`:
  ```typescript
  const { isLoading, data, error, revalidate } = useCachedPromise(
    async (t: string) => {
      const raw = await fetchUsage(t);
      return raw;
    },
    [token],
    { execute: token.length > 0, keepPreviousData: true }
  );
  ```
- IMPORTANT: All hooks must be called unconditionally (before any early returns). The `execute: token.length > 0` option prevents the fetch without violating React hook rules.

**Countdown timer (DASH-03):**
- Use `useState<Date>(new Date())` for `now`
- Use `useEffect` with `setInterval(() => setNow(new Date()), 1000)` -- must return cleanup function `() => clearInterval(id)`
- Derive countdown from `parseResetDate(data?.five_hour?.resets_at)` and `now`
- Use `formatCountdown(secondsRemaining)` for display

**Derive display values from data:**
- Session usage: `formatPercentage(data?.five_hour?.utilization)` (DASH-01)
- Weekly usage: `formatPercentage(data?.seven_day?.utilization)` (DASH-02)
- Countdown: computed from timer (DASH-03)
- Pace: `computePace(data?.five_hour?.utilization ?? 0, sessionResetsAt)` (DASH-04)
- Map `usageColor()` return strings to Raycast `Color` constants: "green" -> Color.Green, "yellow" -> Color.Yellow, "orange" -> Color.Orange, "red" -> Color.Red

**Color mapping helper** (inside index.tsx since it uses @raycast/api):
```typescript
const colorMap: Record<string, string> = {
  green: Color.Green,
  yellow: Color.Yellow,
  orange: Color.Orange,
  red: Color.Red,
};
```

**Pace display config:**
```typescript
const paceConfig = {
  "on-track": { label: "On Track", color: Color.Green },
  "ahead":    { label: "Ahead",    color: Color.Blue },
  "behind":   { label: "Behind",   color: Color.Orange },
  "unknown":  { label: "Unknown",  color: Color.SecondaryText },
};
```

**No-token guard** (after all hooks):
If `!token`, render the same NO_TOKEN_GUIDE Detail with "Open Preferences" action (keep existing behavior).

**Error handling:**
If `error` is a `TokenError`, show toast with "Open Preferences" action. Handle in an `useEffect` watching `error`.

**Layout using Detail + Detail.Metadata:**

Markdown pane (left side): A brief summary with emoji-free header.
```typescript
const markdown = data
  ? `# Claude Usage\n\nSession: **${sessionText}** | Weekly: **${weeklyText}**`
  : "# Claude Usage\n\nLoading...";
```

Metadata panel (right side):
```xml
<Detail.Metadata>
  <Detail.Metadata.Label title="Session (5h)" text={sessionText} icon={Icon.Gauge} />
  <Detail.Metadata.Label title="Weekly (7d)" text={weeklyText} icon={Icon.Calendar} />
  <Detail.Metadata.Separator />
  <Detail.Metadata.Label title="Resets in" text={countdownText} icon={Icon.Clock} />
  <Detail.Metadata.TagList title="Pace">
    <Detail.Metadata.TagList.Item text={paceLabel} color={paceColor} />
  </Detail.Metadata.TagList>
</Detail.Metadata>
```

Always render metadata rows -- use "--" placeholders when data is loading (never conditionally omit rows).

If `data?.seven_day_sonnet?.utilization` or `data?.seven_day_opus?.utilization` is non-null, add optional secondary rows:
```xml
<Detail.Metadata.Separator />
<Detail.Metadata.Label title="Sonnet (7d)" text={formatPercentage(data?.seven_day_sonnet?.utilization)} />
<Detail.Metadata.Label title="Opus (7d)" text={formatPercentage(data?.seven_day_opus?.utilization)} />
```

**Actions (DASH-05):**
```xml
<ActionPanel>
  <Action
    title="Refresh"
    icon={Icon.ArrowClockwise}
    shortcut={{ modifiers: ["cmd"], key: "r" }}
    onAction={revalidate}
  />
  <Action title="Open Preferences" icon={Icon.Gear} onAction={openExtensionPreferences} />
</ActionPanel>
```

Use the simpler `onAction: revalidate` pattern (not the toast wrapper), letting `isLoading` drive the UI refresh state. Per research, `revalidate()` does not return a Promise.

**Build verification:**
Run `npm run build` in tokemon-raycast/ to confirm the component compiles without TypeScript errors.

Commit: `feat(19-02): implement full dashboard command with usage display`
  </action>
  <verify>
Run `cd /Users/richardparr/tokemon-raycast && npm run build` -- builds without errors.
Run `cd /Users/richardparr/tokemon-raycast && npm test` -- existing utility tests still pass.
  </verify>
  <done>index.tsx is a complete Dashboard command using useCachedPromise, Detail.Metadata, countdown timer, pace indicator, and Cmd+R refresh. Compiles and builds successfully.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Dashboard in Raycast</name>
  <what-built>
Complete Dashboard command showing:
- Session usage percentage (DASH-01)
- Weekly usage percentage (DASH-02)
- Live countdown timer to reset (DASH-03)
- Pace indicator tag (on track / ahead / behind) (DASH-04)
- Cmd+R manual refresh (DASH-05)
  </what-built>
  <how-to-verify>
1. Open Raycast and search for "Dashboard" (the tokemon Dashboard command)
2. Verify the Dashboard loads and shows usage data (not the old stub message)
3. Check the metadata panel on the right side shows:
   - "Session (5h)" with a percentage value
   - "Weekly (7d)" with a percentage value
   - "Resets in" with a live countdown (watch it tick for a few seconds)
   - "Pace" with a colored tag (On Track, Ahead, or Behind)
4. Press Cmd+R and verify the data refreshes (loading indicator appears briefly)
5. If token is not configured, verify the "Setup Required" message still appears with "Open Preferences" action
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues you see</resume-signal>
</task>

</tasks>

<verification>
- `npm run build` succeeds in tokemon-raycast/
- `npm test` passes (utility tests from Plan 01 unaffected)
- Dashboard command shows all 5 DASH requirements in Raycast
- Countdown timer ticks every second
- Cmd+R triggers data refresh
- No-token state shows setup instructions
- Token error shows toast with "Open Preferences" action
</verification>

<success_criteria>
- DASH-01: Session usage percentage visible in metadata panel
- DASH-02: Weekly usage percentage visible in metadata panel
- DASH-03: Reset countdown timer ticks live in metadata panel
- DASH-04: Pace indicator shown as colored tag (on-track/ahead/behind)
- DASH-05: Cmd+R keyboard shortcut triggers data refresh
- Human verified the above in Raycast
</success_criteria>

<output>
After completion, create `.planning/phases/19-dashboard-command/19-02-SUMMARY.md`
</output>
