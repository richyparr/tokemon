---
phase: 08-analytics-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ClaudeMon/Services/HistoryStore.swift
  - ClaudeMon/Models/UsageDataPoint.swift
  - ClaudeMon/Services/UsageMonitor.swift
autonomous: true

must_haves:
  truths:
    - "HistoryStore retains up to 90 days of usage data per account"
    - "Data older than 7 days is automatically downsampled to hourly averages"
    - "Downsampling runs on app launch and after each data append"
    - "Existing 30-day data is preserved and not lost during upgrade"
  artifacts:
    - path: "ClaudeMon/Services/HistoryStore.swift"
      provides: "90-day retention with hourly downsampling for old data"
      contains: "maxAgeDays.*90"
    - path: "ClaudeMon/Services/HistoryStore.swift"
      provides: "downsampleOldEntries method"
      contains: "func downsampleOldEntries"
  key_links:
    - from: "ClaudeMon/Services/HistoryStore.swift"
      to: "ClaudeMon/Models/UsageDataPoint.swift"
      via: "UsageDataPoint init for downsampled averages"
      pattern: "UsageDataPoint.*timestamp.*primaryPercentage"
    - from: "ClaudeMon/Services/UsageMonitor.swift"
      to: "ClaudeMon/Services/HistoryStore.swift"
      via: "recordHistory triggers downsample"
      pattern: "historyStore"
---

<objective>
Extend HistoryStore from 30-day to 90-day retention with automatic hourly downsampling for data older than 7 days.

Purpose: All analytics features (30d/90d charts, weekly/monthly summaries, export) require extended history data. Without downsampling, 90 days of per-minute data would be ~25MB per account. Hourly downsampling reduces this to ~2.4MB.

Output: HistoryStore with 90-day retention and automatic downsampling. No new files -- extends existing infrastructure.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-analytics-export/08-RESEARCH.md
@ClaudeMon/Services/HistoryStore.swift
@ClaudeMon/Models/UsageDataPoint.swift
@ClaudeMon/Services/UsageMonitor.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend HistoryStore retention to 90 days with downsampling</name>
  <files>ClaudeMon/Services/HistoryStore.swift</files>
  <action>
Modify the existing HistoryStore actor:

1. Change `maxAgeDays` from 30 to 90.

2. Add a `recentWindowDays` constant set to 7 (data within 7 days keeps full resolution).

3. Add a `downsampleOldEntries(for accountId: UUID)` method that:
   - Splits cached data into "recent" (within recentWindowDays) and "old" (beyond recentWindowDays)
   - Groups old points by hour using `Calendar.current.dateInterval(of: .hour, for:)`
   - For each hour group, creates a single UsageDataPoint with:
     - `timestamp` = hour start
     - `primaryPercentage` = average of all points in that hour
     - `sevenDayPercentage` = average of non-nil values (nil if all nil)
     - `source` = first point's source
     - A new UUID (not reusing old IDs)
   - Replaces the cache with downsampled + recent points, sorted by timestamp ascending
   - Calls `save(for:)` to persist

4. Call `downsampleOldEntries(for:)` in two places:
   - In the `load(for:)` method, after loading data from disk (run once on startup)
   - In the `append(_:for:)` method, after `trimOldEntries` (periodic maintenance)

5. Also add the same downsampling to the legacy (no-account-ID) `load()` and `append(_:)` methods, calling `downsampleOldEntries(for: legacyUUID)`.

6. Update the legacy `getHistory(since:)` method to also work with per-account data by adding a `getHistory(for accountId: UUID, since cutoff: Date) -> [UsageDataPoint]` overload.

Important: The `trimOldEntries` method already runs in append. The downsampling should run AFTER trimming, so old data beyond 90 days is removed first, then remaining old data (7d-90d) is downsampled. Do NOT downsample on every append -- add a guard that only downsamples if the last downsample was more than 1 hour ago (track via a `lastDownsampleDates: [UUID: Date]` dictionary). On load(), always downsample.
  </action>
  <verify>
Run `swift build` -- the project should compile without errors. The HistoryStore should have `maxAgeDays = 90`, a `downsampleOldEntries` method, and the new `getHistory(for:since:)` overload.
  </verify>
  <done>
HistoryStore retains 90 days of data, automatically downsamples data older than 7 days to hourly averages, runs downsampling on load and periodically (at most once per hour) on append.
  </done>
</task>

<task type="auto">
  <name>Task 2: Ensure UsageMonitor loads extended history correctly</name>
  <files>ClaudeMon/Services/UsageMonitor.swift</files>
  <action>
Update UsageMonitor to work with the extended 90-day history:

1. In the `init()` method, the existing code loads history with `historyStore.load()` (legacy). This is already fine -- the HistoryStore will now automatically downsample on load.

2. In the `recordHistory(for:)` method, no changes needed -- `historyStore.append()` already calls downsample internally.

3. Add a `reloadHistory(for accountId: UUID)` overload that loads per-account history:
   ```swift
   func reloadHistory(for accountId: UUID) async {
       usageHistory = await historyStore.getHistory(for: accountId)
   }
   ```

This is a small change but important for the analytics views in Plan 02 that will need to request specific time ranges.

No changes to polling logic, refresh logic, or callback patterns.
  </action>
  <verify>
Run `swift build` -- should compile without errors. The UsageMonitor should have the new `reloadHistory(for:)` overload.
  </verify>
  <done>
UsageMonitor correctly loads and exposes extended 90-day history, with per-account reload support for analytics views.
  </done>
</task>

</tasks>

<verification>
- `swift build` succeeds with no errors
- `maxAgeDays` is 90 in HistoryStore
- `downsampleOldEntries` method exists and groups by hour
- `getHistory(for:since:)` overload exists
- `reloadHistory(for:)` overload exists in UsageMonitor
- No breaking changes to existing API (all legacy methods still work)
</verification>

<success_criteria>
HistoryStore supports 90-day retention with automatic hourly downsampling for data older than 7 days. All existing callers (UsageMonitor, CombinedUsageView) continue to work without changes. The extended history is ready for analytics views and export features in subsequent plans.
</success_criteria>

<output>
After completion, create `.planning/phases/08-analytics-export/08-01-SUMMARY.md`
</output>
