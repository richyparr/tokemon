---
phase: 08-analytics-export
plan: 03
type: execute
wave: 3
depends_on: ["08-02"]
files_modified:
  - Tokemon/Services/ExportManager.swift
  - Tokemon/Views/Analytics/PDFReportView.swift
  - Tokemon/Views/Analytics/AnalyticsDashboardView.swift
autonomous: true

must_haves:
  truths:
    - "User can export a PDF report with usage summaries and project breakdown"
    - "User can export raw usage data as CSV"
    - "PDF contains weekly summaries, project breakdown, and Tokemon branding"
    - "CSV contains timestamp, utilization %, 7-day %, and source for each data point"
    - "Save panel appears correctly in LSUIElement app (activated before showing)"
    - "Export features are Pro-gated"
  artifacts:
    - path: "Tokemon/Services/ExportManager.swift"
      provides: "PDF generation via ImageRenderer and CSV generation with NSSavePanel"
      contains: "struct ExportManager"
    - path: "Tokemon/Views/Analytics/PDFReportView.swift"
      provides: "Self-contained SwiftUI view for PDF rendering (no @Environment dependencies)"
      contains: "struct PDFReportView"
    - path: "Tokemon/Views/Analytics/AnalyticsDashboardView.swift"
      provides: "Export buttons wired to ExportManager"
      contains: "ExportManager"
  key_links:
    - from: "Tokemon/Views/Analytics/AnalyticsDashboardView.swift"
      to: "Tokemon/Services/ExportManager.swift"
      via: "Button actions call ExportManager.exportPDF and exportCSV"
      pattern: "ExportManager\\."
    - from: "Tokemon/Services/ExportManager.swift"
      to: "Tokemon/Views/Analytics/PDFReportView.swift"
      via: "generatePDF renders PDFReportView with ImageRenderer"
      pattern: "PDFReportView"
    - from: "Tokemon/Services/ExportManager.swift"
      to: "NSSavePanel"
      via: "File save dialogs for both PDF and CSV"
      pattern: "NSSavePanel"
---

<objective>
Build ExportManager with PDF and CSV export capabilities, add export buttons to the Analytics dashboard.

Purpose: Users need to export their usage data for record-keeping, expense reports, or sharing. PDF provides a formatted report with summaries; CSV provides raw data for spreadsheet analysis. Covers ANALYTICS-03 and ANALYTICS-04.

Output: ExportManager service, PDFReportView for rendering, export buttons in AnalyticsDashboardView.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-analytics-export/08-RESEARCH.md
@.planning/phases/08-analytics-export/08-01-SUMMARY.md
@.planning/phases/08-analytics-export/08-02-SUMMARY.md
@Tokemon/Services/AnalyticsEngine.swift
@Tokemon/Models/UsageSummary.swift
@Tokemon/Models/ProjectUsage.swift
@Tokemon/Views/Analytics/AnalyticsDashboardView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExportManager and PDFReportView</name>
  <files>
    Tokemon/Services/ExportManager.swift
    Tokemon/Views/Analytics/PDFReportView.swift
  </files>
  <action>
**PDFReportView.swift** -- Create in Views/Analytics/:
A SELF-CONTAINED SwiftUI view for PDF rendering. CRITICAL: No @Environment dependencies (ImageRenderer creates an isolated rendering context without the normal SwiftUI environment -- see research pitfall #2). All data passed as parameters.

```
struct PDFReportView: View {
    let accountName: String
    let generatedDate: Date
    let weeklySummaries: [UsageSummary]
    let monthlySummaries: [UsageSummary]
    let projectBreakdown: [ProjectUsage]
    let totalDataPoints: Int
```

Layout (single page, US Letter-compatible at 540pt width):
1. Header: "Tokemon Usage Report" (title, bold) + generated date (caption, right-aligned)
2. Account name (subheadline)
3. Divider
4. "Weekly Summary" section: For each weekly summary, show period label, avg %, peak %
5. "Monthly Summary" section: Same pattern
6. Divider
7. "Project Token Usage" section: Top 10 projects by total tokens, showing project name and formatted token count (use `formatTokens` helper: 1M+, 1K+, raw)
8. Divider
9. Footer: "Generated by Tokemon - https://tokemon.app" (caption, centered)

Use ONLY solid colors (`.white` background, `.black` foreground). No gradients (ImageRenderer macOS gradient rendering bug per research). No theme colors. `.frame(width: 540)` to fit US Letter with margins. `.padding(24)`.

**ExportManager.swift** -- Create in Services/:
A `@MainActor` struct with static methods:

1. `static func generatePDF(from reportView: some View, filename: String = "Tokemon-Report.pdf") -> URL?`
   - Create `ImageRenderer(content: reportView)` with `scale = 2.0` (Retina)
   - Use `renderer.render { size, context in ... }` closure
   - US Letter page: `CGRect(x: 0, y: 0, width: 612, height: 792)`
   - Create `CGContext(url as CFURL, mediaBox: &box, nil)`
   - Apply 36pt margins (0.5 inch) and scale to fit
   - Write to `FileManager.default.temporaryDirectory`
   - Return the temp URL (or nil on failure)

2. `static func exportPDF(reportView: some View, suggestedFilename: String = "Tokemon-Report.pdf") async -> Bool`
   - Call `NSApp.activate(ignoringOtherApps: true)` FIRST (critical for LSUIElement apps per research pitfall #5)
   - Create `NSSavePanel` with `.allowedContentTypes = [.pdf]`
   - Set `nameFieldStringValue`, `canCreateDirectories = true`, `title = "Export Usage Report"`, `prompt = "Export"`
   - Use `await panel.begin()` (standalone, NOT `beginSheetModal` -- no reliable key window in LSUIElement app per research)
   - Generate PDF to temp file, then `FileManager.default.moveItem` to destination
   - On success, call `NSWorkspace.shared.activateFileViewerSelecting([destinationURL])` to reveal in Finder
   - Return true/false

3. `static func generateCSV(from points: [UsageDataPoint]) -> String`
   - Header: `"Timestamp,Utilization %,7-Day Utilization %,Source"`
   - For each point: ISO8601 timestamp, primaryPercentage (%.1f), sevenDayPercentage (%.1f or empty), source
   - Proper CSV escaping: wrap fields containing commas/quotes/newlines in double quotes, escape embedded quotes by doubling them. For this data the risk is low (all numeric) but do it correctly anyway.
   - Join with "\n"

4. `static func exportCSV(from points: [UsageDataPoint], suggestedFilename: String = "tokemon-usage.csv") async -> Bool`
   - `NSApp.activate(ignoringOtherApps: true)` first
   - `NSSavePanel` with `.allowedContentTypes = [.commaSeparatedText]`
   - Use `await panel.begin()` (standalone)
   - Write CSV string to selected URL with `.utf8` encoding
   - Return true/false

Import `UniformTypeIdentifiers` for UTType.pdf and UTType.commaSeparatedText.
Import `SwiftUI` (for ImageRenderer).
  </action>
  <verify>
Run `swift build` -- ExportManager and PDFReportView compile. ExportManager has generatePDF, exportPDF, generateCSV, exportCSV methods. PDFReportView takes all data as parameters (no @Environment).
  </verify>
  <done>
ExportManager can generate PDF reports from PDFReportView and CSV from UsageDataPoint arrays. Both export methods use NSSavePanel with proper LSUIElement activation. PDFReportView is self-contained with no environment dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add export buttons to AnalyticsDashboardView</name>
  <files>Tokemon/Views/Analytics/AnalyticsDashboardView.swift</files>
  <action>
Modify the existing AnalyticsDashboardView to add export functionality:

1. Add `@State private var isExporting = false` for loading state during export.

2. Add an export section at the bottom of the ScrollView (after ProjectBreakdownView), containing:
   - A section header "Export" with SF Symbol `square.and.arrow.up`
   - Two buttons side by side in an HStack:
     a. "Export PDF Report" button (icon: `doc.richtext`) -- Pro-gated with `.exportPDF`
     b. "Export CSV Data" button (icon: `tablecells`) -- Pro-gated with `.exportCSV`
   - Both buttons disabled while `isExporting` is true
   - Show a ProgressView when isExporting

3. PDF export button action:
   - Set `isExporting = true`
   - Compute data: weekly summaries, monthly summaries, project breakdown (from AnalyticsEngine)
   - Build PDFReportView with:
     - accountName: from `accountManager.activeAccount?.username ?? "Default"`
     - generatedDate: Date()
     - weeklySummaries, monthlySummaries from AnalyticsEngine
     - projectBreakdown from AnalyticsEngine (30 day default)
     - totalDataPoints: monitor.usageHistory.count
   - Call `await ExportManager.exportPDF(reportView:)`
   - Set `isExporting = false`

4. CSV export button action:
   - Set `isExporting = true`
   - Call `await ExportManager.exportCSV(from: monitor.usageHistory)`
   - Set `isExporting = false`

5. Pro gate the export buttons individually:
   - If `!featureAccess.canAccess(.exportPDF)`: show button as disabled with lock icon overlay
   - If `!featureAccess.canAccess(.exportCSV)`: same pattern
   - On tap of locked button, present purchase prompt (use existing `@State private var showingPurchasePrompt` pattern from PopoverContentView)

6. Add `@Environment(AccountManager.self) private var accountManager` if not already present (needed for account name in PDF).

Style the export buttons as `.buttonStyle(.bordered)` with `.controlSize(.regular)` for a clean look.
  </action>
  <verify>
Run `swift build` -- AnalyticsDashboardView compiles with export buttons. Verify:
- Two export buttons visible in the view
- PDF button wires to ExportManager.exportPDF
- CSV button wires to ExportManager.exportCSV
- Both buttons have Pro gating
- isExporting state prevents double-clicks
  </verify>
  <done>
Export buttons in Analytics dashboard allow users to generate PDF reports and CSV exports of their usage data. Both are Pro-gated and show loading state during export.
  </done>
</task>

</tasks>

<verification>
- `swift build` succeeds
- ExportManager.swift exists in Services/ with PDF and CSV export methods
- PDFReportView.swift exists in Views/Analytics/ with no @Environment dependencies
- AnalyticsDashboardView has two export buttons (PDF and CSV)
- NSSavePanel calls are preceded by NSApp.activate (LSUIElement requirement)
- PDF uses ImageRenderer with scale 2.0 and solid colors (no gradients)
- CSV uses ISO8601 timestamps with proper escaping
- Export features gated behind .exportPDF and .exportCSV Pro features
</verification>

<success_criteria>
User can click "Export PDF Report" in Analytics tab to generate and save a formatted PDF with weekly summaries and project breakdown. User can click "Export CSV Data" to save raw usage history as a CSV file. Both use NSSavePanel for file destination. Covers ANALYTICS-03 and ANALYTICS-04.
</success_criteria>

<output>
After completion, create `.planning/phases/08-analytics-export/08-03-SUMMARY.md`
</output>
