---
phase: 08-analytics-export
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - Tokemon/Services/AnalyticsEngine.swift
  - Tokemon/Models/UsageSummary.swift
  - Tokemon/Models/ProjectUsage.swift
  - Tokemon/Views/Analytics/AnalyticsDashboardView.swift
  - Tokemon/Views/Analytics/UsageSummaryView.swift
  - Tokemon/Views/Analytics/ProjectBreakdownView.swift
  - Tokemon/Views/Analytics/ExtendedHistoryChartView.swift
  - Tokemon/Views/Settings/SettingsView.swift
autonomous: true

must_haves:
  truths:
    - "User can view weekly usage summaries with average and peak utilization"
    - "User can view monthly usage summaries with average and peak utilization"
    - "User can view 30-day and 90-day usage history charts"
    - "User can see which projects consumed the most tokens"
    - "Analytics tab appears in Settings window"
    - "All analytics features are Pro-gated"
  artifacts:
    - path: "Tokemon/Services/AnalyticsEngine.swift"
      provides: "Weekly/monthly summary aggregation and project breakdown"
      exports: ["weeklySummaries", "monthlySummaries", "projectBreakdown"]
    - path: "Tokemon/Models/UsageSummary.swift"
      provides: "UsageSummary model for weekly/monthly data"
      contains: "struct UsageSummary"
    - path: "Tokemon/Models/ProjectUsage.swift"
      provides: "ProjectUsage model for per-project token breakdown"
      contains: "struct ProjectUsage"
    - path: "Tokemon/Views/Analytics/AnalyticsDashboardView.swift"
      provides: "Main analytics container with tab-based navigation"
      contains: "struct AnalyticsDashboardView"
    - path: "Tokemon/Views/Analytics/ExtendedHistoryChartView.swift"
      provides: "30d/90d chart with time range picker"
      contains: "ExtendedChartTimeRange"
    - path: "Tokemon/Views/Settings/SettingsView.swift"
      provides: "Analytics tab in settings"
      contains: "Analytics"
  key_links:
    - from: "Tokemon/Views/Analytics/AnalyticsDashboardView.swift"
      to: "Tokemon/Services/AnalyticsEngine.swift"
      via: "Calls AnalyticsEngine static methods for data"
      pattern: "AnalyticsEngine\\."
    - from: "Tokemon/Views/Analytics/ExtendedHistoryChartView.swift"
      to: "Tokemon/Services/HistoryStore.swift"
      via: "Gets history data via UsageMonitor.usageHistory"
      pattern: "dataPoints"
    - from: "Tokemon/Views/Analytics/ProjectBreakdownView.swift"
      to: "Tokemon/Services/AnalyticsEngine.swift"
      via: "Calls projectBreakdown for JSONL token data"
      pattern: "AnalyticsEngine\\.projectBreakdown"
    - from: "Tokemon/Views/Settings/SettingsView.swift"
      to: "Tokemon/Views/Analytics/AnalyticsDashboardView.swift"
      via: "TabView tab for Analytics"
      pattern: "AnalyticsDashboardView"
---

<objective>
Build the AnalyticsEngine service, data models, and Analytics dashboard UI with weekly/monthly summaries, extended history charts, and project token breakdown.

Purpose: This is the core analytics experience -- users see their usage patterns over time and understand which projects consume the most tokens. Covers ANALYTICS-01, -02, -05, -06, -07.

Output: AnalyticsEngine service, UsageSummary and ProjectUsage models, 4 analytics views, and Analytics tab in Settings.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-analytics-export/08-RESEARCH.md
@.planning/phases/08-analytics-export/08-01-SUMMARY.md
@Tokemon/Services/HistoryStore.swift
@Tokemon/Services/JSONLParser.swift
@Tokemon/Services/FeatureAccessManager.swift
@Tokemon/Views/Charts/UsageChartView.swift
@Tokemon/Views/Settings/SettingsView.swift
@Tokemon/Utilities/Constants.swift
@Tokemon/TokemonApp.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AnalyticsEngine, UsageSummary, and ProjectUsage</name>
  <files>
    Tokemon/Services/AnalyticsEngine.swift
    Tokemon/Models/UsageSummary.swift
    Tokemon/Models/ProjectUsage.swift
  </files>
  <action>
**UsageSummary.swift** -- Create in Models/:
```
struct UsageSummary: Identifiable, Sendable {
    let id: UUID
    let period: DateInterval
    let periodLabel: String        // "Feb 10-16" or "February 2026"
    let averageUtilization: Double // Average 5-hour utilization %
    let peakUtilization: Double    // Highest recorded utilization %
    let dataPointCount: Int        // Number of data points in period
}
```

**ProjectUsage.swift** -- Create in Models/:
```
struct ProjectUsage: Identifiable, Sendable {
    let id: UUID
    let projectPath: String        // Decoded path (e.g., "/Users/richardparr/Tokemon")
    let projectName: String        // Last path component (e.g., "Tokemon")
    let inputTokens: Int
    let outputTokens: Int
    let cacheCreationTokens: Int
    let cacheReadTokens: Int
    let sessionCount: Int

    var totalTokens: Int {
        inputTokens + outputTokens + cacheCreationTokens + cacheReadTokens
    }
}
```

**AnalyticsEngine.swift** -- Create in Services/:
A struct with all static methods (no state, pure computation):

1. `static func weeklySummaries(from points: [UsageDataPoint], weeks: Int = 4) -> [UsageSummary]`
   - Filter points to last N weeks using `Calendar.current.date(byAdding: .weekOfYear, value: -weeks, to: Date())`
   - Group by `Calendar.current.dateInterval(of: .weekOfYear, for:)` -- ALWAYS use Calendar.current for locale-aware week starts
   - For each group: compute average and peak primaryPercentage, format label as "MMM d-d"
   - Sort by period start ascending
   - Return empty array if no data (not an error)

2. `static func monthlySummaries(from points: [UsageDataPoint], months: Int = 3) -> [UsageSummary]`
   - Same pattern but group by `.month`
   - Label format: "MMMM yyyy" (e.g., "February 2026")

3. `static func projectBreakdown(since: Date) -> [ProjectUsage]`
   - Call `JSONLParser.findProjectDirectories()` (wrap in do/catch, return empty on error)
   - For each project dir, call `JSONLParser.findSessionFiles(in:since:)` then `JSONLParser.parseSession(at:)` for each
   - Decode project path: replace leading `-` with `/`, then replace all remaining `-` with `/`
   - Extract project name as `URL(fileURLWithPath: decodedPath).lastPathComponent`
   - Sort by totalTokens descending
   - This is cross-account (all JSONL data is shared on one machine)

4. `static func decodeProjectPath(_ dirName: String) -> String`
   - Helper: Convert "-Users-richardparr-Tokemon" to "/Users/richardparr/Tokemon"

5. `static func formatTokenCount(_ count: Int) -> String`
   - Helper: 1_000_000+ = "1.2M", 1_000+ = "1.2K", else "\(count)"
  </action>
  <verify>
Run `swift build` -- all three new files compile. AnalyticsEngine has weeklySummaries, monthlySummaries, projectBreakdown, decodeProjectPath, and formatTokenCount methods.
  </verify>
  <done>
AnalyticsEngine provides weekly/monthly summary aggregation from UsageDataPoint arrays and project token breakdown from JSONL files. UsageSummary and ProjectUsage models are Identifiable and Sendable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Analytics views and add Analytics tab to Settings</name>
  <files>
    Tokemon/Views/Analytics/AnalyticsDashboardView.swift
    Tokemon/Views/Analytics/UsageSummaryView.swift
    Tokemon/Views/Analytics/ProjectBreakdownView.swift
    Tokemon/Views/Analytics/ExtendedHistoryChartView.swift
    Tokemon/Views/Settings/SettingsView.swift
  </files>
  <action>
Create the `Views/Analytics/` directory and four views. All views use `@Environment(FeatureAccessManager.self)` for Pro gating.

**ExtendedHistoryChartView.swift:**
- Add `ExtendedChartTimeRange` enum with cases: `.day("24h")`, `.week("7d")`, `.month("30d")`, `.quarter("90d")`
  - Each case has `interval: TimeInterval`, `strideComponent: Calendar.Component`, `strideCount: Int`
  - `.month` and `.quarter` are Pro-gated (require `.extendedHistory`)
- View takes `dataPoints: [UsageDataPoint]` and `@State private var selectedRange: ExtendedChartTimeRange = .week`
- Filters dataPoints by selectedRange.interval
- Renders Swift Charts area+line chart (same pattern as existing UsageChartView)
- Uses `@Environment(ThemeManager.self)` for chart colors (same pattern as UsageChartView)
- The segmented picker shows all 4 options; 30d/90d segments show a lock icon if not Pro (use `featureAccess.canAccess(.extendedHistory)` to gate selection)
- Do NOT use `#Preview` macros (incompatible with SPM builds per established decision)

**UsageSummaryView.swift:**
- Takes `weeklySummaries: [UsageSummary]` and `monthlySummaries: [UsageSummary]`
- Shows a `Picker` to toggle between Weekly and Monthly view
- For each summary, show a row: period label, average %, peak %, data point count
- Use `.monospacedDigit()` for numbers
- Empty state: "No data for this period" message
- Pro-gate the entire view with `featureAccess.canAccess(.weeklySummary)` -- show locked state with upgrade prompt if not Pro (follow existing ProGatedModifier pattern but since this is a whole view, check inline)

**ProjectBreakdownView.swift:**
- Computes project breakdown on appear using `Task { }` with `AnalyticsEngine.projectBreakdown(since:)` on a background thread
- Shows loading indicator while computing
- Presents "This Machine" header (cross-account, per research recommendation)
- Lists projects sorted by total tokens, showing: project name, total tokens (formatted), session count
- Each row has a small bar indicator showing relative proportion (widest = most tokens)
- Pro-gated with `.projectBreakdown` feature
- Allow user to pick time range: 7d, 30d, 90d (default 30d)

**AnalyticsDashboardView.swift:**
- Main container view for the Analytics tab
- Check `featureAccess.canAccess(.extendedHistory)` at the top level -- if not Pro, show a locked splash (icon, title "Analytics is a Pro feature", description, upgrade button calling `featureAccess.openPurchasePage()`)
- If Pro: show ScrollView with:
  1. ExtendedHistoryChartView (passing `monitor.usageHistory`)
  2. Divider
  3. UsageSummaryView (passing computed summaries from AnalyticsEngine)
  4. Divider
  5. ProjectBreakdownView
  6. Spacer for export buttons (Plan 03 will add these)
- Use `@Environment(UsageMonitor.self)` for history data
- Compute summaries using AnalyticsEngine.weeklySummaries/monthlySummaries from monitor.usageHistory
- Frame minHeight: 400

**SettingsView.swift** -- Modify existing:
- Add a new Analytics tab BEFORE the License tab (between Accounts and License):
  ```swift
  AnalyticsDashboardView()
      .tabItem {
          Label("Analytics", systemImage: "chart.bar.xaxis")
      }
  ```
- The AnalyticsDashboardView pulls its own environment objects, no extra wiring needed
- Increase minHeight from 320 to 400 to accommodate analytics content

Important: Do NOT use `#Preview` macros anywhere (incompatible with SPM builds per codebase convention). Do NOT use `@Environment(\.colorScheme)` inside views that will be rendered to PDF (Plan 03 concern, but good to note). The analytics views ARE for on-screen display only, so they CAN use environment objects.
  </action>
  <verify>
Run `swift build` -- all new views compile and SettingsView includes the Analytics tab. Verify:
- `Views/Analytics/` directory exists with 4 files
- SettingsView has 8 tabs (was 7)
- ExtendedHistoryChartView has 4 time range options
- AnalyticsDashboardView has Pro gate check
  </verify>
  <done>
Analytics dashboard is accessible from Settings > Analytics tab. Users can view weekly/monthly summaries, 30d/90d history charts, and project token breakdown. All features are Pro-gated. Export buttons will be added in Plan 03.
  </done>
</task>

</tasks>

<verification>
- `swift build` succeeds
- AnalyticsEngine.swift exists in Services/ with weeklySummaries, monthlySummaries, projectBreakdown
- UsageSummary.swift and ProjectUsage.swift exist in Models/
- Views/Analytics/ contains 4 view files
- SettingsView has Analytics tab between Accounts and License
- All analytics views check FeatureAccessManager for Pro gating
- ExtendedHistoryChartView has 24h/7d/30d/90d time range picker
- ProjectBreakdownView runs JSONL parsing in background Task (not blocking UI)
</verification>

<success_criteria>
User can open Settings > Analytics and see: extended history chart with 30d/90d options, weekly and monthly usage summaries with averages and peaks, and per-project token breakdown. All gated behind Pro. Covers ANALYTICS-01, -02, -05, -06, -07.
</success_criteria>

<output>
After completion, create `.planning/phases/08-analytics-export/08-02-SUMMARY.md`
</output>
