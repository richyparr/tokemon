---
phase: 20-menu-bar-command
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tokemon-raycast/src/menu-bar.tsx
  - tokemon-raycast/package.json
autonomous: false

must_haves:
  truths:
    - "Usage percentage is visible in the macOS menu bar via Raycast"
    - "Menu bar updates automatically without user opening the command"
    - "Menu bar icon color changes based on usage level (green/yellow/orange/red)"
    - "Clicking the menu bar item shows a dropdown with session details and actions"
    - "No-token state shows a warning icon and setup prompt instead of crashing"
  artifacts:
    - path: "tokemon-raycast/src/menu-bar.tsx"
      provides: "MenuBarExtra command with colored icon, percentage title, and dropdown"
      exports: ["default"]
    - path: "tokemon-raycast/package.json"
      provides: "Menu bar command entry with mode menu-bar and interval 5m"
      contains: "menu-bar"
  key_links:
    - from: "tokemon-raycast/src/menu-bar.tsx"
      to: "tokemon-raycast/src/api.ts"
      via: "fetchUsage import"
      pattern: "import.*fetchUsage.*from.*api"
    - from: "tokemon-raycast/src/menu-bar.tsx"
      to: "tokemon-raycast/src/utils.ts"
      via: "usageColor and formatPercentage imports"
      pattern: "import.*usageColor.*formatPercentage.*from.*utils"
    - from: "tokemon-raycast/package.json"
      to: "tokemon-raycast/src/menu-bar.tsx"
      via: "command name matches filename"
      pattern: '"name": "menu-bar"'
---

<objective>
Create the Raycast menu bar command that persistently displays Claude usage percentage with color-coded icon and automatic background refresh.

Purpose: MENU-01 (usage percentage in menu bar), MENU-02 (automatic background refresh), MENU-03 (color indicates usage level). This is the full Phase 20 scope.

Output: Working `src/menu-bar.tsx` command + updated `package.json` manifest, verified in Raycast.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-menu-bar-command/20-RESEARCH.md
@.planning/phases/19-dashboard-command/19-02-SUMMARY.md

# Key source files to reference (read, do NOT modify):
@tokemon-raycast/src/index.tsx       # Dashboard command — copy colorMap pattern
@tokemon-raycast/src/api.ts          # fetchUsage, extractToken, TokenError — import as-is
@tokemon-raycast/src/utils.ts        # usageColor, formatPercentage, parseResetDate, formatCountdown — import as-is
@tokemon-raycast/src/types.ts        # UsageData — import for type annotation
@tokemon-raycast/package.json        # Add new command entry to commands array
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create menu-bar.tsx and add package.json command entry</name>
  <files>tokemon-raycast/src/menu-bar.tsx, tokemon-raycast/package.json</files>
  <action>
**1. Create `tokemon-raycast/src/menu-bar.tsx`:**

Create the MenuBarExtra command. Import from existing modules — do NOT modify api.ts, utils.ts, types.ts, or index.tsx.

```typescript
import {
  MenuBarExtra,
  Icon,
  Color,
  getPreferenceValues,
  openExtensionPreferences,
  launchCommand,
  LaunchType,
} from "@raycast/api";
import { useCachedPromise } from "@raycast/utils";
import { extractToken, fetchUsage } from "./api";
import { usageColor, formatPercentage, parseResetDate, formatCountdown } from "./utils";

interface Preferences {
  oauthToken: string;
}

const colorMap: Record<string, Color> = {
  green: Color.Green,
  yellow: Color.Yellow,
  orange: Color.Orange,
  red: Color.Red,
};

export default function MenuBarCommand() {
  const { oauthToken } = getPreferenceValues<Preferences>();
  const token = extractToken(oauthToken);

  const { isLoading, data, error } = useCachedPromise(
    async (t: string) => fetchUsage(t),
    [token],
    { execute: token.length > 0, keepPreviousData: true },
  );

  // No token — show warning icon with setup prompt
  if (!token) {
    return (
      <MenuBarExtra icon={{ source: Icon.Warning }} tooltip="tokemon: Setup required" isLoading={false}>
        <MenuBarExtra.Item
          title="Setup Required"
          subtitle="Click to configure token"
          onAction={openExtensionPreferences}
        />
      </MenuBarExtra>
    );
  }

  // Derive display values
  const utilization = data?.five_hour?.utilization ?? 0;
  const colorKey = usageColor(utilization);
  const tintColor = colorMap[colorKey] ?? Color.Green;
  const title = data ? formatPercentage(utilization) : undefined;

  const resetAt = parseResetDate(data?.five_hour?.resets_at);
  const secondsRemaining = resetAt ? Math.floor((resetAt.getTime() - Date.now()) / 1000) : 0;

  return (
    <MenuBarExtra
      icon={{ source: Icon.CircleFilled, tintColor: error ? Color.SecondaryText : tintColor }}
      title={title}
      tooltip={`Claude usage: ${formatPercentage(utilization)}`}
      isLoading={isLoading}
    >
      <MenuBarExtra.Section title="Session (5h)">
        <MenuBarExtra.Item title={`Usage: ${formatPercentage(utilization)}`} />
        <MenuBarExtra.Item title={`Resets in: ${data ? formatCountdown(secondsRemaining) : "--"}`} />
      </MenuBarExtra.Section>
      <MenuBarExtra.Section title="Weekly (7d)">
        <MenuBarExtra.Item title={`Usage: ${formatPercentage(data?.seven_day?.utilization)}`} />
      </MenuBarExtra.Section>
      <MenuBarExtra.Section>
        <MenuBarExtra.Item
          title="Open Dashboard"
          icon={Icon.AppWindowSidebarLeft}
          onAction={() => launchCommand({ name: "index", type: LaunchType.UserInitiated })}
        />
        <MenuBarExtra.Item
          title="Preferences"
          icon={Icon.Gear}
          onAction={openExtensionPreferences}
        />
      </MenuBarExtra.Section>
    </MenuBarExtra>
  );
}
```

Key patterns (from research and index.tsx):
- `useCachedPromise` with `keepPreviousData: true` — same pattern as Dashboard
- `colorMap` duplicated (not shared) — keeps each command self-contained per Phase 19 decision
- `isLoading` passed directly from `useCachedPromise` — NEVER manually managed (critical for background refresh lifecycle)
- No-token state returns a `MenuBarExtra` with `Icon.Warning` — do NOT return `null` (would hide the menu bar item entirely)
- `error` state dims icon to `Color.SecondaryText` — shows something went wrong without crashing
- All hooks called before early return (React rules compliance, established in Phase 19)

**2. Add command entry to `tokemon-raycast/package.json`:**

Add a new object to the `commands` array (after the existing "setup" entry):

```json
{
  "name": "menu-bar",
  "title": "Menu Bar",
  "subtitle": "tokemon",
  "description": "Claude usage percentage in your menu bar with automatic refresh",
  "mode": "menu-bar",
  "interval": "5m"
}
```

Critical: `"name": "menu-bar"` must match the filename `menu-bar.tsx` (without extension). The `"interval": "5m"` enables Raycast's native background refresh scheduler. The `"mode": "menu-bar"` tells Raycast this is a persistent menu bar item.

**3. Verify build:**

Run `cd tokemon-raycast && npm run build` — must succeed with zero errors.
Run `cd tokemon-raycast && npm test` — existing 30 tests must still pass.
Run `cd tokemon-raycast && npm run lint` — must pass with no errors.
  </action>
  <verify>
1. `cd tokemon-raycast && npm run build` exits 0
2. `cd tokemon-raycast && npm test` — all tests pass (no regressions)
3. `cd tokemon-raycast && npm run lint` exits 0
4. `tokemon-raycast/src/menu-bar.tsx` exists and exports a default function
5. `package.json` commands array has 3 entries, third is name "menu-bar" with mode "menu-bar" and interval "5m"
  </verify>
  <done>
- menu-bar.tsx created with MenuBarExtra, useCachedPromise, tintColor icon, no-token guard, dropdown with session/weekly/dashboard-link/preferences
- package.json has menu-bar command entry with mode "menu-bar" and interval "5m"
- Build, tests, and lint all pass
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify menu bar command in Raycast</name>
  <files>tokemon-raycast/src/menu-bar.tsx</files>
  <action>
Human verification of the menu bar command in Raycast. Claude automated everything in Task 1 — this checkpoint confirms it works visually and functionally.

What was built: Menu bar command showing Claude usage percentage with colored icon and automatic background refresh.

Steps to verify:
1. Open Raycast and search for "Menu Bar" — the tokemon Menu Bar command should appear
2. Run the command — a menu bar icon should appear in the macOS menu bar
3. Verify the icon is a colored circle (green/yellow/orange/red matching your current usage level)
4. Verify the percentage text appears next to the icon (e.g., "32%")
5. Click the menu bar item — a dropdown should show:
   - Session (5h) section with Usage percentage and Resets countdown
   - Weekly (7d) section with Usage percentage
   - "Open Dashboard" action (should open the Dashboard command)
   - "Preferences" action (should open extension preferences)
6. Wait ~5 minutes and check if the percentage updates automatically (or change token to see if it refreshes)

Resume signal: Type "approved" if all checks pass, or describe what needs fixing.
  </action>
  <verify>User confirms all 3 MENU requirements are met in Raycast</verify>
  <done>MENU-01 (percentage in menu bar), MENU-02 (auto refresh), MENU-03 (color reflects usage level) — all verified by human in Raycast</done>
</task>

</tasks>

<verification>
1. `npm run build` passes in tokemon-raycast/
2. `npm test` passes with no regressions (30+ tests)
3. `npm run lint` passes
4. Menu bar icon visible in macOS menu bar with colored tint
5. Percentage text displayed next to icon
6. Dropdown shows session, weekly, dashboard link, preferences
7. No-token state shows warning icon (can test by clearing token in preferences)
8. Background refresh observed (usage updates after interval)
</verification>

<success_criteria>
- MENU-01: Usage percentage displayed in Raycast menu bar (title text + dropdown details)
- MENU-02: Menu bar updates automatically via `interval: "5m"` background refresh
- MENU-03: Menu bar icon color reflects usage level (green/yellow/orange/red via tintColor)
- Build, tests, and lint all pass with no regressions
- Human verification confirms all three requirements working in Raycast
</success_criteria>

<output>
After completion, create `.planning/phases/20-menu-bar-command/20-01-SUMMARY.md`
</output>
