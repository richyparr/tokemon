---
phase: 15-team-dashboard-pro
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Tokemon/Models/TeamMember.swift
  - Tokemon/Models/AdminUsageResponse.swift
  - Tokemon/Services/AdminAPIClient.swift
  - Tokemon/Services/FeatureAccessManager.swift
autonomous: true

must_haves:
  truths:
    - "AdminAPIClient can fetch organization members list"
    - "AdminAPIClient can fetch usage data grouped by user_id"
    - "TeamMember model stores member info (id, name, email, role)"
    - "Team dashboard feature is gated behind Pro license"
  artifacts:
    - path: "Tokemon/Models/TeamMember.swift"
      provides: "Organization member data model"
      contains: "struct TeamMember"
    - path: "Tokemon/Services/AdminAPIClient.swift"
      provides: "API methods for members and grouped usage"
      contains: "fetchOrganizationMembers"
  key_links:
    - from: "AdminAPIClient"
      to: "Anthropic Admin API"
      via: "REST endpoints"
      pattern: "/v1/organizations/members"
---

<objective>
Create the data layer for team usage monitoring: TeamMember model, Admin API methods for fetching org members and per-member usage breakdown.

Purpose: Enable the team dashboard to display aggregated and per-member usage data from Anthropic's Admin API.
Output: TeamMember.swift model, extended AdminAPIClient with members endpoint and group_by support.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@Tokemon/Models/AdminUsageResponse.swift
@Tokemon/Services/AdminAPIClient.swift
@Tokemon/Services/FeatureAccessManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TeamMember model and extend AdminUsageResponse</name>
  <files>
    Tokemon/Models/TeamMember.swift
    Tokemon/Models/AdminUsageResponse.swift
  </files>
  <action>
1. Create TeamMember.swift with:
   - `struct TeamMember: Codable, Identifiable, Sendable`
   - Properties: `id: String` (user_id from API), `name: String`, `email: String`, `role: String`
   - Conformance to CodingKeys for snake_case API response mapping (`user_id` -> `id`)

2. Extend AdminUsageResponse.UsageResult in AdminUsageResponse.swift:
   - Add optional `userId: String?` property (maps from `user_id` in API response)
   - Update CodingKeys to include `userId = "user_id"`
   - This field is only present when `group_by=user_id` is used in the API request

The Admin API returns usage results with an optional `user_id` field when grouped:
```json
{
  "data": [{
    "starting_at": "2026-02-10T00:00:00Z",
    "ending_at": "2026-02-11T00:00:00Z",
    "results": [{
      "user_id": "user_abc123",
      "uncached_input_tokens": 1000,
      ...
    }]
  }]
}
```
  </action>
  <verify>
Build succeeds: `swift build` in project root.
TeamMember struct exists with id, name, email, role properties.
AdminUsageResponse.UsageResult has optional userId field.
  </verify>
  <done>
TeamMember model created.
AdminUsageResponse.UsageResult extended with userId for per-member grouping.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Admin API methods for members and grouped usage</name>
  <files>
    Tokemon/Services/AdminAPIClient.swift
    Tokemon/Services/FeatureAccessManager.swift
  </files>
  <action>
1. Add to AdminAPIClient.swift:

   a) `fetchOrganizationMembers()` method:
      - Endpoint: GET `/v1/organizations/members`
      - Returns: `[TeamMember]` array
      - Handles pagination via `has_more` and `next_page` (loop until all members fetched)
      - Headers: `anthropic-version: 2023-06-01`, `x-api-key: {admin_key}`
      - Error handling: reuse existing AdminAPIError cases

   b) `fetchUsageByMember(startingAt:endingAt:bucketWidth:)` method:
      - Same as existing fetchUsageReport but adds `group_by=user_id` query parameter
      - Returns `AdminUsageResponse` where each UsageResult has `userId` populated
      - Handles pagination (reuse pattern from fetchAllUsageData)

   c) Create response wrapper for members endpoint:
      ```swift
      struct OrganizationMembersResponse: Codable, Sendable {
          let data: [TeamMember]
          let hasMore: Bool
          let nextPage: String?

          enum CodingKeys: String, CodingKey {
              case data
              case hasMore = "has_more"
              case nextPage = "next_page"
          }
      }
      ```

2. Add to FeatureAccessManager.swift ProFeature enum:
   - `.teamDashboard = "Team usage dashboard"` case
   - Add icon: `"person.3.fill"` for teamDashboard in the switch

The members endpoint returns:
```json
{
  "data": [
    {"user_id": "user_abc", "name": "Alice", "email": "alice@org.com", "role": "admin"},
    {"user_id": "user_def", "name": "Bob", "email": "bob@org.com", "role": "user"}
  ],
  "has_more": false
}
```
  </action>
  <verify>
Build succeeds with new methods.
`AdminAPIClient.shared.fetchOrganizationMembers()` compiles.
`AdminAPIClient.shared.fetchUsageByMember(startingAt:endingAt:)` compiles.
ProFeature.teamDashboard case exists.
  </verify>
  <done>
AdminAPIClient has fetchOrganizationMembers() and fetchUsageByMember() methods.
ProFeature.teamDashboard added for Pro gating.
  </done>
</task>

</tasks>

<verification>
- Project builds without errors: `swift build`
- TeamMember model has all required properties
- AdminAPIClient has both new methods
- ProFeature enum includes .teamDashboard
- AdminUsageResponse.UsageResult has userId field
</verification>

<success_criteria>
1. TeamMember struct created with Codable/Identifiable conformance
2. AdminUsageResponse extended to support per-user grouping
3. AdminAPIClient can fetch org members via /members endpoint
4. AdminAPIClient can fetch usage grouped by user_id
5. teamDashboard Pro feature defined for UI gating
</success_criteria>

<output>
After completion, create `.planning/phases/15-team-dashboard-pro/15-01-SUMMARY.md`
</output>
