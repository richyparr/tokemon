---
phase: 15-team-dashboard-pro
plan: 02
type: execute
wave: 2
depends_on: ["15-01"]
files_modified:
  - Tokemon/Views/Team/TeamDashboardView.swift
  - Tokemon/Views/Team/MemberUsageRow.swift
  - Tokemon/Views/Team/TeamUsageSummaryView.swift
  - Tokemon/Views/Settings/SettingsView.swift
autonomous: true

must_haves:
  truths:
    - "User can view aggregated org usage in Team Dashboard tab"
    - "User can see per-member usage breakdown with name and tokens"
    - "User can filter team data by date range (7d, 30d, 90d)"
    - "Team tab only visible when Admin API key configured and Pro license active"
  artifacts:
    - path: "Tokemon/Views/Team/TeamDashboardView.swift"
      provides: "Main team dashboard container"
      contains: "struct TeamDashboardView"
    - path: "Tokemon/Views/Team/MemberUsageRow.swift"
      provides: "Per-member usage display component"
      contains: "struct MemberUsageRow"
    - path: "Tokemon/Views/Settings/SettingsView.swift"
      provides: "Team tab added to settings"
      contains: "TeamDashboardView"
  key_links:
    - from: "TeamDashboardView"
      to: "AdminAPIClient"
      via: "async fetch calls"
      pattern: "AdminAPIClient.shared.fetch"
    - from: "SettingsView"
      to: "TeamDashboardView"
      via: "TabView tab item"
      pattern: "tabItem.*Team"
---

<objective>
Build the Team Dashboard UI showing aggregated org usage and per-member breakdown with date range filtering.

Purpose: Enable team leads to view org-wide Claude usage and drill down into individual member consumption.
Output: TeamDashboardView, MemberUsageRow, TeamUsageSummaryView components, integrated into Settings.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/15-team-dashboard-pro/15-01-SUMMARY.md
@Tokemon/Views/Analytics/OrgUsageView.swift
@Tokemon/Views/Settings/SettingsView.swift
@Tokemon/Services/FeatureAccessManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TeamDashboardView and helper views</name>
  <files>
    Tokemon/Views/Team/TeamDashboardView.swift
    Tokemon/Views/Team/MemberUsageRow.swift
    Tokemon/Views/Team/TeamUsageSummaryView.swift
  </files>
  <action>
1. Create directory structure: Tokemon/Views/Team/

2. Create TeamDashboardView.swift:
   - Pro-gated at top level (check `featureAccess.canAccess(.teamDashboard)`)
   - If not Pro: show locked splash with upgrade button (same pattern as AnalyticsDashboardView)
   - If Pro but no Admin API key: show "Connect Admin API" message with link to Admin settings

   State:
   - `@State private var isLoading = false`
   - `@State private var errorMessage: String?`
   - `@State private var members: [TeamMember] = []`
   - `@State private var usageByMember: [String: Int] = [:]` (userId -> totalTokens)
   - `@State private var orgTotalTokens: Int = 0`
   - `@State private var selectedPeriod: Period = .week` (7d/30d/90d picker)

   Layout (Form with grouped style to match other settings tabs):
   - Header: "Team Usage" with period picker (segmented: 7 Days, 30 Days, 90 Days)
   - TeamUsageSummaryView: Shows org total tokens, total cost, member count
   - Section "Members": List of MemberUsageRow sorted by tokens descending
   - Loading/error states handled gracefully

   Data loading:
   - `.task { await loadTeamData() }` on appear
   - `loadTeamData()`:
     a) Fetch members via `AdminAPIClient.shared.fetchOrganizationMembers()`
     b) Fetch usage by member via `AdminAPIClient.shared.fetchUsageByMember(startingAt:endingAt:)`
     c) Aggregate: sum tokens per userId from results
     d) Calculate org total from all results
   - Reload on period change

3. Create MemberUsageRow.swift:
   - Takes: `member: TeamMember`, `tokenCount: Int`, `orgTotal: Int`
   - Display: Avatar placeholder (person.circle SF Symbol), name, email, role badge
   - Progress bar showing member's proportion of org total
   - Token count formatted (K/M notation)
   - Sorted position badge (1st, 2nd, 3rd with medals: gold/silver/bronze)

4. Create TeamUsageSummaryView.swift:
   - Takes: `totalTokens: Int`, `memberCount: Int`, `period: String`
   - LazyVGrid layout (3 columns) matching OrgUsageView pattern:
     - Total Tokens card
     - Active Members card
     - Avg per Member card
   - Use consistent card styling from OrgUsageView (statCard pattern)
  </action>
  <verify>
Build succeeds with new views.
TeamDashboardView shows Pro gate when not licensed.
TeamDashboardView shows Admin API prompt when key missing.
  </verify>
  <done>
TeamDashboardView created with Pro gating, Admin API check, period picker, member list.
MemberUsageRow displays member info with usage proportion.
TeamUsageSummaryView shows org-level aggregates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate Team Dashboard into Settings</name>
  <files>
    Tokemon/Views/Settings/SettingsView.swift
  </files>
  <action>
1. Add Team tab to SettingsView TabView:
   - Position: After "Admin" tab (since it depends on Admin API being configured)
   - Tab item: `Label("Team", systemImage: "person.3.fill")`
   - Only show tab if Admin API is configured (conditional tab)

   ```swift
   // Conditionally show Team tab only when Admin API configured
   if AdminAPIClient.shared.hasAdminKey() {
       TeamDashboardView()
           .tabItem {
               Label("Team", systemImage: "person.3.fill")
           }
   }
   ```

2. Import the new view at top of file if needed (Views/Team/TeamDashboardView)

Note: The Team tab is only useful when Admin API is configured, so we hide it entirely
when no key is present. Inside the tab, Pro gating handles the license check.
  </action>
  <verify>
Build succeeds.
Settings window shows Team tab when Admin API key is configured.
Team tab does not appear when Admin API key is not configured.
  </verify>
  <done>
Team tab integrated into Settings with conditional visibility based on Admin API configuration.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add date range filtering to Team Dashboard</name>
  <files>
    Tokemon/Views/Team/TeamDashboardView.swift
  </files>
  <action>
1. Ensure TeamDashboardView has Period enum (same as OrgUsageView):
   ```swift
   enum Period: String, CaseIterable {
       case week = "7 Days"
       case month = "30 Days"
       case quarter = "90 Days"

       var days: Int {
           switch self {
           case .week: return 7
           case .month: return 30
           case .quarter: return 90
           }
       }
   }
   ```

2. Add segmented picker in header matching OrgUsageView pattern:
   ```swift
   Picker("Period", selection: $selectedPeriod) {
       ForEach(Period.allCases, id: \.self) { period in
           Text(period.rawValue).tag(period)
       }
   }
   .pickerStyle(.segmented)
   .frame(width: 200)
   .onChange(of: selectedPeriod) { _, _ in
       Task { await loadTeamData() }
   }
   ```

3. In loadTeamData(), calculate date range:
   ```swift
   let endDate = Date()
   let startDate = endDate.addingTimeInterval(-Double(selectedPeriod.days) * 24 * 3600)

   let usageResponse = try await AdminAPIClient.shared.fetchUsageByMember(
       startingAt: startDate,
       endingAt: endDate
   )
   ```

4. Add refresh button in header (same pattern as OrgUsageView):
   ```swift
   Button {
       Task { await loadTeamData() }
   } label: {
       Image(systemName: "arrow.clockwise")
   }
   .buttonStyle(.borderless)
   .disabled(isLoading)
   ```
  </action>
  <verify>
Build succeeds.
Changing period picker triggers data reload.
Different periods show different token counts (assuming historical data exists).
  </verify>
  <done>
Date range filtering works with 7d/30d/90d options.
Period changes trigger async data reload.
Refresh button allows manual data refresh.
  </done>
</task>

</tasks>

<verification>
- Project builds without errors
- Team tab appears in Settings when Admin API configured
- Team tab hidden when Admin API not configured
- Pro gate shows upgrade prompt for non-Pro users
- Period picker changes date range and reloads data
- Member list sorted by token usage descending
- Org totals displayed correctly
</verification>

<success_criteria>
1. User can view aggregated org usage in Team Dashboard (TEAM-01)
2. User can see per-member usage breakdown (TEAM-02)
3. User can filter by date range 7d/30d/90d (TEAM-03)
4. Dashboard is Pro-gated
5. Tab only visible when Admin API is configured
</success_criteria>

<output>
After completion, create `.planning/phases/15-team-dashboard-pro/15-02-SUMMARY.md`
</output>
