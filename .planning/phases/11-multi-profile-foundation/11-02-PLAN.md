---
phase: 11-multi-profile-foundation
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - Tokemon/Views/Settings/ProfilesSettings.swift
  - Tokemon/Views/MenuBar/ProfileSwitcherView.swift
  - Tokemon/Views/MenuBar/PopoverContentView.swift
  - Tokemon/Views/Settings/SettingsView.swift
  - Tokemon/TokemonApp.swift
autonomous: true

must_haves:
  truths:
    - "User can see a Profiles tab in Settings with list of profiles"
    - "User can create a new profile with a custom name from Settings"
    - "User can sync credentials from system keychain into a profile via Settings"
    - "User can enter manual session keys for a profile via Settings"
    - "User can delete a profile from Settings"
    - "User can switch active profile from the popover (profile switcher)"
    - "User can switch active profile from Settings"
    - "Switching profiles writes credentials to system keychain"
  artifacts:
    - path: "Tokemon/Views/Settings/ProfilesSettings.swift"
      provides: "Full profile management UI in Settings"
      contains: "struct ProfilesSettings"
    - path: "Tokemon/Views/MenuBar/ProfileSwitcherView.swift"
      provides: "Compact profile switcher for popover header"
      contains: "struct ProfileSwitcherView"
  key_links:
    - from: "Tokemon/Views/Settings/ProfilesSettings.swift"
      to: "Tokemon/Services/ProfileManager.swift"
      via: "@Environment(ProfileManager.self)"
      pattern: "Environment.*ProfileManager"
    - from: "Tokemon/Views/MenuBar/ProfileSwitcherView.swift"
      to: "Tokemon/Services/ProfileManager.swift"
      via: "@Environment(ProfileManager.self)"
      pattern: "profileManager\\.setActiveProfile"
    - from: "Tokemon/TokemonApp.swift"
      to: "Tokemon/Services/ProfileManager.swift"
      via: "@State private var profileManager"
      pattern: "environment.*profileManager"
---

<objective>
Create the profile management UI (Settings tab + popover switcher) and wire ProfileManager into the app lifecycle.

Purpose: Users need to create, manage, and switch between profiles. The Settings tab provides full CRUD + credential management, while the popover provides quick profile switching. Wiring into TokemonApp ensures ProfileManager is available as an environment object throughout the app.

Output: ProfilesSettings.swift, ProfileSwitcherView.swift, updated PopoverContentView, SettingsView, and TokemonApp.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-multi-profile-foundation/11-01-SUMMARY.md

Key codebase files to reference:
@Tokemon/Views/Settings/SettingsView.swift (add new tab)
@Tokemon/Views/MenuBar/PopoverContentView.swift (add profile switcher)
@Tokemon/TokemonApp.swift (wire ProfileManager as environment)
@Tokemon/Views/Settings/AlertSettings.swift (reference for Settings tab layout patterns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ProfilesSettings view and ProfileSwitcherView</name>
  <files>Tokemon/Views/Settings/ProfilesSettings.swift, Tokemon/Views/MenuBar/ProfileSwitcherView.swift</files>
  <action>
**Create `Tokemon/Views/Settings/ProfilesSettings.swift`:**

A full-featured Settings tab for profile management. Layout:

```
+------------------------------------------+
| Profiles                                 |
+------------------------------------------+
| [Profile List]                           |
|  > Default (active)     [Sync] [Delete]  |
|  > Work Account         [Sync] [Delete]  |
|                                          |
|  [+ Add Profile]                         |
+------------------------------------------+
| Selected Profile Details                 |
+------------------------------------------+
| Name: [text field]                       |
| Status: Synced (2 min ago) / Manual / -- |
|                                          |
| Credentials:                             |
| [Sync from Keychain] button              |
|   -- or --                               |
| Session Key: [secure field]              |
| Org ID: [text field] (optional)          |
| [Save Manual Credentials] button         |
|                                          |
| [Switch to This Profile] button          |
|   (disabled if already active)           |
+------------------------------------------+
```

Implementation details:
- Use `@Environment(ProfileManager.self) private var profileManager`
- Profile list as a `List` with selection binding
- Selected profile shows detail form
- "Sync from Keychain" button calls `profileManager.syncCredentialsFromKeychain(for:)`
- Manual session key entry uses `SecureField` for the session key
- "Save Manual Credentials" calls `profileManager.enterManualSessionKey(for:sessionKey:orgId:)`
- "Switch to This Profile" calls `profileManager.setActiveProfile(id:)`
- "Delete" button calls `profileManager.deleteProfile(id:)` with confirmation alert
- "Add Profile" shows a text field (inline or sheet) for the profile name, then calls `profileManager.createProfile(name:)`
- Show credential status: "Synced X ago" (if lastSynced set), "Manual key" (if claudeSessionKey set), "No credentials" (if neither)
- Disable delete for the last remaining profile
- Show active indicator (checkmark or "Active" badge) next to the active profile

Follow the existing Settings tab patterns in the codebase (Form with Sections, consistent spacing).

**Create `Tokemon/Views/MenuBar/ProfileSwitcherView.swift`:**

A compact profile switcher for the top of the popover. Only shown when there are 2+ profiles.

```
+------------------------------------------+
| [icon] Default v                         |
+------------------------------------------+
```

Implementation:
- Use a `Menu` (dropdown) showing the active profile name with a chevron
- Menu items list all profiles with a checkmark on the active one
- Selecting a different profile calls `profileManager.setActiveProfile(id:)`
- Use `@Environment(ProfileManager.self)`
- Compact styling: small font, secondary color, fits in the popover header area
- If only 1 profile exists, either hide the view entirely or show just the profile name without dropdown

Keep it minimal -- this is NOT the full management UI (that's in Settings). This is just for quick switching.
  </action>
  <verify>
`swift build 2>&1 | tail -5` compiles without errors. Both ProfilesSettings.swift and ProfileSwitcherView.swift exist.
  </verify>
  <done>ProfilesSettings tab provides full profile CRUD with credential sync/manual entry. ProfileSwitcherView provides quick profile switching in the popover.</done>
</task>

<task type="auto">
  <name>Task 2: Wire ProfileManager into app and update existing views</name>
  <files>Tokemon/TokemonApp.swift, Tokemon/Views/Settings/SettingsView.swift, Tokemon/Views/MenuBar/PopoverContentView.swift</files>
  <action>
**Update `Tokemon/TokemonApp.swift`:**

1. Add `@State private var profileManager = ProfileManager()` alongside the existing monitor, alertManager, themeManager, etc.

2. Pass profileManager as environment to the MenuBarExtra content and Settings:
   ```swift
   .environment(profileManager)
   ```
   Add this to BOTH the PopoverContentView environment chain and the SettingsView environment chain.

3. Also pass profileManager to SettingsWindowController:
   ```swift
   SettingsWindowController.shared.setProfileManager(profileManager)
   ```
   NOTE: SettingsWindowController may need a `setProfileManager` method added. Check if it uses a generic pattern or has specific setters. If it has specific setters (like setMonitor, setAlertManager), add `setProfileManager(_ manager: ProfileManager)` following the same pattern. If the settings window is opened via the SwiftUI Settings scene (which it is -- see the `Settings { SettingsView().environment(...) }` block), then just adding `.environment(profileManager)` to the Settings scene is sufficient. Do BOTH to be safe.

4. Wire the profile change callback to trigger a UsageMonitor refresh:
   ```swift
   profileManager.onActiveProfileChanged = { [monitor] _ in
       Task { @MainActor in
           await monitor.refresh()
       }
   }
   ```
   Place this in the `menuBarExtraAccess` closure alongside the existing callback wiring.

5. Update `popoverHeight` computation: add a small height (~28px) for the profile switcher when profiles.count > 1:
   ```swift
   if profileManager.profiles.count > 1 {
       height += 28  // Profile switcher row
   }
   ```

**Update `Tokemon/Views/Settings/SettingsView.swift`:**

Add a "Profiles" tab to the TabView, placed as the FIRST tab (before General):

```swift
ProfilesSettings()
    .tabItem {
        Label("Profiles", systemImage: "person.2")
    }
```

The environment will be inherited from the parent (TokemonApp passes it).

**Update `Tokemon/Views/MenuBar/PopoverContentView.swift`:**

1. Add `@Environment(ProfileManager.self) private var profileManager`

2. Add `ProfileSwitcherView()` at the TOP of the VStack (before UsageHeaderView), but only when there are 2+ profiles:
   ```swift
   if profileManager.profiles.count > 1 {
       ProfileSwitcherView()
   }
   ```

3. The ProfileSwitcherView will get its ProfileManager environment from the parent.

**IMPORTANT:** When modifying TokemonApp.swift, preserve ALL existing environment passing and callback wiring. Only ADD the profileManager-related code. Do not restructure existing code.
  </action>
  <verify>
`swift build 2>&1 | tail -5` compiles without errors. Verify:
1. TokemonApp.swift contains `@State private var profileManager`
2. PopoverContentView.swift contains `ProfileSwitcherView`
3. SettingsView.swift contains `ProfilesSettings` tab
  </verify>
  <done>ProfileManager is wired as environment throughout the app. Users can see the Profiles tab in Settings, the profile switcher in the popover (when 2+ profiles exist), and switching profiles triggers a UsageMonitor refresh.</done>
</task>

</tasks>

<verification>
1. `swift build` compiles successfully
2. ProfilesSettings tab visible in Settings window
3. ProfileSwitcherView appears in popover when 2+ profiles exist
4. ProfileManager passed as environment to all views
5. Profile switching triggers monitor refresh
</verification>

<success_criteria>
- User can see Profiles tab in Settings with profile list
- User can create a new profile with a custom name (PROF-01)
- User can sync credentials from system keychain (PROF-02)
- User can enter manual session keys (PROF-03)
- User can switch profiles from popover or Settings (PROF-04)
- User can delete profiles from Settings (PROF-05)
- Switching profiles writes credentials to system keychain
</success_criteria>

<output>
After completion, create `.planning/phases/11-multi-profile-foundation/11-02-SUMMARY.md`
</output>
