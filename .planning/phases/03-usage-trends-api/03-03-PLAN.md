---
phase: 03-usage-trends-api
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - ClaudeMon/Services/AdminAPIClient.swift
  - ClaudeMon/Models/AdminUsageResponse.swift
  - ClaudeMon/Views/Settings/AdminAPISettings.swift
  - ClaudeMon/Views/Settings/SettingsView.swift
autonomous: true

must_haves:
  truths:
    - "User can optionally enter an Admin API key in settings"
    - "Admin API key is validated on entry (sk-ant-admin prefix check)"
    - "Admin API key is stored securely in Keychain"
    - "User can clear/disconnect Admin API"
  artifacts:
    - path: "ClaudeMon/Services/AdminAPIClient.swift"
      provides: "Admin API key management and usage fetching"
      contains: "actor AdminAPIClient"
    - path: "ClaudeMon/Models/AdminUsageResponse.swift"
      provides: "Response model for Admin API"
      contains: "struct AdminUsageResponse"
    - path: "ClaudeMon/Views/Settings/AdminAPISettings.swift"
      provides: "Admin API configuration UI"
      contains: "struct AdminAPISettings"
  key_links:
    - from: "ClaudeMon/Views/Settings/AdminAPISettings.swift"
      to: "ClaudeMon/Services/AdminAPIClient.swift"
      via: "setAdminKey/clearAdminKey calls"
      pattern: "AdminAPIClient\\."
    - from: "ClaudeMon/Services/AdminAPIClient.swift"
      to: "Keychain"
      via: "KeychainAccess library"
      pattern: "Keychain\\("
    - from: "ClaudeMon/Views/Settings/SettingsView.swift"
      to: "ClaudeMon/Views/Settings/AdminAPISettings.swift"
      via: "settings tab"
      pattern: "AdminAPISettings"
---

<objective>
Add optional Admin API integration for organization admins.

Purpose: Let users with org admin access connect their Admin API key to access detailed cost and usage data from the Anthropic API. This is optional functionality (DATA-05) -- most individual users won't have Admin API access.

Output: AdminAPIClient for key management, AdminUsageResponse model, AdminAPISettings tab in settings, secure Keychain storage.
</objective>

<execution_context>
@/Users/richardparr/.claude/get-shit-done/workflows/execute-plan.md
@/Users/richardparr/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-usage-trends-api/03-RESEARCH.md

# Existing patterns for Keychain access
@ClaudeMon/Services/TokenManager.swift
@ClaudeMon/Views/Settings/SettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AdminUsageResponse model</name>
  <files>ClaudeMon/Models/AdminUsageResponse.swift</files>
  <action>
Create the response model for the Admin API usage endpoint:

```swift
import Foundation

/// Response from Anthropic Admin API /v1/organizations/usage_report/messages endpoint.
/// Provides organization-level usage data with token breakdowns.
struct AdminUsageResponse: Codable, Sendable {
    let data: [UsageBucket]
    let hasMore: Bool
    let nextPage: String?

    /// A single time bucket of usage data.
    struct UsageBucket: Codable, Sendable {
        let bucketStartTime: String
        let inputTokens: Int
        let outputTokens: Int
        let cacheCreationInputTokens: Int
        let cacheReadInputTokens: Int

        enum CodingKeys: String, CodingKey {
            case bucketStartTime = "bucket_start_time"
            case inputTokens = "input_tokens"
            case outputTokens = "output_tokens"
            case cacheCreationInputTokens = "cache_creation_input_tokens"
            case cacheReadInputTokens = "cache_read_input_tokens"
        }

        /// Total tokens in this bucket
        var totalTokens: Int {
            inputTokens + outputTokens + cacheCreationInputTokens + cacheReadInputTokens
        }
    }

    enum CodingKeys: String, CodingKey {
        case data
        case hasMore = "has_more"
        case nextPage = "next_page"
    }

    /// Calculate total tokens across all buckets
    var totalTokens: Int {
        data.reduce(0) { $0 + $1.totalTokens }
    }

    /// Calculate total input tokens
    var totalInputTokens: Int {
        data.reduce(0) { $0 + $1.inputTokens }
    }

    /// Calculate total output tokens
    var totalOutputTokens: Int {
        data.reduce(0) { $0 + $1.outputTokens }
    }
}
```

This matches the Admin API response structure from research.
  </action>
  <verify>File compiles: `swift build 2>&1 | head -20`</verify>
  <done>AdminUsageResponse.swift exists with Codable struct matching Admin API response</done>
</task>

<task type="auto">
  <name>Task 2: Create AdminAPIClient</name>
  <files>ClaudeMon/Services/AdminAPIClient.swift</files>
  <action>
Create an actor for Admin API key management and usage fetching:

```swift
import Foundation
import KeychainAccess

/// Client for Anthropic Admin API.
/// Manages Admin API key storage and organization usage data fetching.
/// Note: Admin API is only available for organization accounts with admin role.
actor AdminAPIClient {
    static let shared = AdminAPIClient()

    private let keychain = Keychain(service: "com.claudemon.admin-api")
    private let keychainKey = "admin_api_key"
    private let baseURL = "https://api.anthropic.com/v1/organizations"

    // MARK: - Key Management

    /// Store Admin API key securely after validation.
    func setAdminKey(_ key: String) throws {
        guard key.hasPrefix("sk-ant-admin") else {
            throw AdminAPIError.invalidKeyFormat
        }
        try keychain.set(key, key: keychainKey)
    }

    /// Check if Admin API is configured.
    nonisolated func hasAdminKey() -> Bool {
        // Keychain access is thread-safe, can check synchronously
        (try? Keychain(service: "com.claudemon.admin-api").get("admin_api_key")) != nil
    }

    /// Get masked key for display (sk-ant-admin...xxxx).
    func getMaskedKey() -> String? {
        guard let key = try? keychain.get(keychainKey) else { return nil }
        guard key.count > 16 else { return "sk-ant-admin...****" }
        let suffix = String(key.suffix(4))
        return "sk-ant-admin...\(suffix)"
    }

    /// Clear stored Admin API key.
    func clearAdminKey() throws {
        try keychain.remove(keychainKey)
    }

    // MARK: - API Calls

    /// Fetch organization usage report.
    ///
    /// - Parameters:
    ///   - startingAt: Start of the reporting period
    ///   - endingAt: End of the reporting period
    ///   - bucketWidth: Aggregation bucket size ("1h", "1d", "1w", "1mo")
    /// - Returns: Usage report response
    func fetchUsageReport(
        startingAt: Date,
        endingAt: Date,
        bucketWidth: String = "1d"
    ) async throws -> AdminUsageResponse {
        guard let adminKey = try? keychain.get(keychainKey) else {
            throw AdminAPIError.notConfigured
        }

        let formatter = ISO8601DateFormatter()
        formatter.formatOptions = [.withInternetDateTime]

        guard var components = URLComponents(string: "\(baseURL)/usage_report/messages") else {
            throw AdminAPIError.invalidURL
        }

        components.queryItems = [
            URLQueryItem(name: "starting_at", value: formatter.string(from: startingAt)),
            URLQueryItem(name: "ending_at", value: formatter.string(from: endingAt)),
            URLQueryItem(name: "bucket_width", value: bucketWidth)
        ]

        guard let url = components.url else {
            throw AdminAPIError.invalidURL
        }

        var request = URLRequest(url: url)
        request.setValue("2023-06-01", forHTTPHeaderField: "anthropic-version")
        request.setValue(adminKey, forHTTPHeaderField: "x-api-key")

        let (data, response) = try await URLSession.shared.data(for: request)

        guard let httpResponse = response as? HTTPURLResponse else {
            throw AdminAPIError.invalidResponse
        }

        switch httpResponse.statusCode {
        case 200:
            let decoder = JSONDecoder()
            return try decoder.decode(AdminUsageResponse.self, from: data)
        case 401, 403:
            throw AdminAPIError.unauthorized
        case 404:
            throw AdminAPIError.notFound
        default:
            throw AdminAPIError.serverError(httpResponse.statusCode)
        }
    }

    /// Test if the stored Admin API key is valid by making a minimal API call.
    func validateKey() async throws {
        // Fetch 1 day of data to validate key
        let endDate = Date()
        let startDate = endDate.addingTimeInterval(-24 * 3600)
        _ = try await fetchUsageReport(startingAt: startDate, endingAt: endDate, bucketWidth: "1d")
    }

    // MARK: - Errors

    enum AdminAPIError: LocalizedError {
        case notConfigured
        case invalidKeyFormat
        case invalidURL
        case invalidResponse
        case unauthorized
        case notFound
        case serverError(Int)

        var errorDescription: String? {
            switch self {
            case .notConfigured:
                return "Admin API not configured"
            case .invalidKeyFormat:
                return "Invalid key format. Admin API keys start with 'sk-ant-admin'"
            case .invalidURL:
                return "Invalid API URL"
            case .invalidResponse:
                return "Invalid response from server"
            case .unauthorized:
                return "Unauthorized. Check your Admin API key."
            case .notFound:
                return "Organization not found. Admin API requires organization admin access."
            case .serverError(let code):
                return "Server error (\(code))"
            }
        }
    }
}
```

Key design choices:
- Actor for thread safety (like HistoryStore)
- Separate Keychain service from OAuth tokens (different credentials)
- Key validation checks prefix before storing (research pitfall #5)
- Masked key display for settings UI
- nonisolated hasAdminKey for quick sync checks
  </action>
  <verify>File compiles: `swift build 2>&1 | head -20`</verify>
  <done>AdminAPIClient.swift exists with key management and fetchUsageReport functionality</done>
</task>

<task type="auto">
  <name>Task 3: Create AdminAPISettings tab and add to SettingsView</name>
  <files>
    ClaudeMon/Views/Settings/AdminAPISettings.swift
    ClaudeMon/Views/Settings/SettingsView.swift
  </files>
  <action>
**Part A: Create AdminAPISettings.swift**

```swift
import SwiftUI

/// Settings tab for optional Admin API configuration.
/// Allows organization admins to connect their Admin API key for detailed usage data.
struct AdminAPISettings: View {
    @State private var apiKey: String = ""
    @State private var isConnected: Bool = false
    @State private var maskedKey: String = ""
    @State private var isValidating: Bool = false
    @State private var errorMessage: String?
    @State private var showingKeyField: Bool = false

    var body: some View {
        Form {
            Section {
                VStack(alignment: .leading, spacing: 12) {
                    HStack {
                        Image(systemName: "building.2")
                            .foregroundStyle(.secondary)
                        Text("Organization Admin API")
                            .font(.headline)
                    }

                    Text("Connect an Admin API key to access detailed organization usage and cost data. This is optional and only available for organization accounts with admin permissions.")
                        .font(.caption)
                        .foregroundStyle(.secondary)
                        .fixedSize(horizontal: false, vertical: true)
                }
            }

            if isConnected {
                Section("Connected") {
                    HStack {
                        Image(systemName: "checkmark.circle.fill")
                            .foregroundColor(.green)
                        Text(maskedKey)
                            .font(.system(.body, design: .monospaced))
                        Spacer()
                        Button("Disconnect") {
                            disconnect()
                        }
                        .foregroundColor(.red)
                    }
                }
            } else {
                Section("Connect Admin API") {
                    if showingKeyField {
                        VStack(alignment: .leading, spacing: 8) {
                            SecureField("sk-ant-admin...", text: $apiKey)
                                .textFieldStyle(.roundedBorder)
                                .disabled(isValidating)

                            if let error = errorMessage {
                                Text(error)
                                    .font(.caption)
                                    .foregroundColor(.red)
                            }

                            HStack {
                                Button("Cancel") {
                                    showingKeyField = false
                                    apiKey = ""
                                    errorMessage = nil
                                }
                                .disabled(isValidating)

                                Button("Connect") {
                                    connect()
                                }
                                .disabled(apiKey.isEmpty || isValidating)
                                .keyboardShortcut(.defaultAction)

                                if isValidating {
                                    ProgressView()
                                        .scaleEffect(0.7)
                                        .padding(.leading, 4)
                                }
                            }
                        }
                    } else {
                        Button("Add Admin API Key...") {
                            showingKeyField = true
                        }
                    }
                }

                Section {
                    VStack(alignment: .leading, spacing: 4) {
                        Text("How to get an Admin API key:")
                            .font(.caption)
                            .foregroundStyle(.secondary)
                        Text("1. Go to console.anthropic.com")
                            .font(.caption)
                            .foregroundStyle(.secondary)
                        Text("2. Navigate to Settings > Admin API")
                            .font(.caption)
                            .foregroundStyle(.secondary)
                        Text("3. Create a new Admin API key")
                            .font(.caption)
                            .foregroundStyle(.secondary)
                    }
                }
            }
        }
        .formStyle(.grouped)
        .padding()
        .onAppear {
            checkConnection()
        }
    }

    private func checkConnection() {
        isConnected = AdminAPIClient.shared.hasAdminKey()
        if isConnected {
            Task {
                maskedKey = await AdminAPIClient.shared.getMaskedKey() ?? "Connected"
            }
        }
    }

    private func connect() {
        errorMessage = nil
        isValidating = true

        Task {
            do {
                // Store key
                try await AdminAPIClient.shared.setAdminKey(apiKey)

                // Validate by making test request
                try await AdminAPIClient.shared.validateKey()

                // Success
                await MainActor.run {
                    isConnected = true
                    showingKeyField = false
                    apiKey = ""
                    isValidating = false
                }
                checkConnection()
            } catch {
                await MainActor.run {
                    errorMessage = error.localizedDescription
                    isValidating = false
                    // Clear invalid key
                    try? await AdminAPIClient.shared.clearAdminKey()
                }
            }
        }
    }

    private func disconnect() {
        Task {
            try? await AdminAPIClient.shared.clearAdminKey()
            await MainActor.run {
                isConnected = false
                maskedKey = ""
            }
        }
    }
}

#Preview {
    AdminAPISettings()
        .frame(width: 420, height: 300)
}
```

**Part B: Add tab to SettingsView.swift**

Add the new tab after Alerts:

```swift
AdminAPISettings()
    .tabItem {
        Label("Admin API", systemImage: "building.2")
    }
```

Full updated body:

```swift
var body: some View {
    TabView {
        RefreshSettings()
            .environment(monitor)
            .tabItem {
                Label("General", systemImage: "gear")
            }

        DataSourceSettings()
            .environment(monitor)
            .tabItem {
                Label("Data Sources", systemImage: "arrow.triangle.2.circlepath")
            }

        AppearanceSettings()
            .environment(monitor)
            .tabItem {
                Label("Appearance", systemImage: "paintbrush")
            }

        AlertSettings()
            .environment(alertManager)
            .tabItem {
                Label("Alerts", systemImage: "bell.badge")
            }

        AdminAPISettings()
            .tabItem {
                Label("Admin API", systemImage: "building.2")
            }
    }
    .frame(minWidth: 420, minHeight: 320)  // Slightly taller for new tab
}
```
  </action>
  <verify>
1. Build succeeds: `swift build 2>&1 | head -20`
2. Launch app, open Settings (Command+,)
3. Admin API tab visible with building.2 icon
4. Tab shows "Add Admin API Key..." button
  </verify>
  <done>
- AdminAPISettings.swift provides Admin API configuration UI
- SettingsView has new Admin API tab
- Key entry, validation, and disconnect flows work
  </done>
</task>

</tasks>

<verification>
1. `swift build` completes without errors
2. App launches without crash
3. Settings > Admin API tab is accessible
4. Can see "Add Admin API Key..." button for new users
5. Entering invalid key format shows error
6. Entering valid key format attempts validation
7. Connected state shows masked key and Disconnect button
8. Disconnect clears key and returns to entry state
</verification>

<success_criteria>
- Admin API key can be entered in settings
- Key format validated (sk-ant-admin prefix required)
- Key stored securely in Keychain (separate from OAuth)
- Connection validates by making test API call
- Connected state shows masked key
- User can disconnect (clear key)
- Feature is completely optional -- doesn't affect other functionality
</success_criteria>

<output>
After completion, create `.planning/phases/03-usage-trends-api/03-03-SUMMARY.md`
</output>
